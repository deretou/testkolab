var kolabEditor=(function(){ 
function initMsgManager(e,d){var g=document.location;var b=g.port==""?(g.protocol=="https:"?443:80):g.port;var c=g.protocol+"//"+g.hostname+":"+b+"/document";var f=g.pathname.substr(1,g.pathname.indexOf("/"))+"socket.io";var a;a=io.connect(c,{resource:f,"max reconnection attempts":3,"sync disconnect on unload":false});a.once("connect",function(){console.log("connected");a.emit("choose",g.pathname.substr(1));sendClientReady(e,d,a)});a.on("disconnect",function(h){console.log("disconnected")});a.on("status",function(h){console.log("INCOMING message",h);msgRouter(e,h)});a.on("changeset",function(h){console.log("INCOMING changeset",h);changesetRouter(h)});return a}function msgRouter(a,b){switch(b.status){case"userEnter":manageUpdateUserInfo(a,b);break;case"initDocument":initClientDocument(b);break;case"initUsers":initUsersPosition(a,b.content);break;case"userLeave":handleUserDisconnect(b);break;case"paragraphDenied":handleDeniedParagraph(b.user,"kolab");break;default:alert("UNKNOWN MESSAGE : "+b.status);console.log("UNKNOWN MESSAGE : ",b.status);break}}function retrieveUserColor(b){var a;KolabInReal.currentSquareMembers.forEach(function(c){console.log(c.kolabID,b,c.color);if(c.kolabID==b){a=c.color}});return a}function changesetRouter(d,c){var b=retrieveUserColor(d.user);if(d.action=="addSpec"){manageSpecialCharacterAdd(d.user,d.content,d.undo?d.undo:d.user,stylesUnZip(d.extra),b,c)}else{if(d.action=="add"){console.log(c);manageCharacterAdd(d.user,d.content,d.undo?d.undo:d.user,stylesUnZip(d.extra),b,c)}else{if(d.action=="spec"){switch(d.content){case"DEL":manageDelete(d.user,b,c);break;case"BAK":manageBackspace(d.user,b,c);break;case"ENT":manageEnter(d.user,d.extra,b,c,true);break;case"TAB":manageTab(d.user,b,c);break}}else{if(d.action=="style"){manageStyling(d.extra,d.content,d.user,c,true)}else{if(d.action=="styleSpec"){applyCoordStyle(d.content,d.extra)}else{if(d.action=="stylePgh"){switch(d.extra){case"alg":manageAlignement(d.content,d.user,c);break;case"lht":setLineHeight(d.content,d.user,c);break;case"ind":case"det":manageIndent(d.extra,d.user,c);break;case"hdg":manageHeading(d.content,d.user,c);break}}else{if(d.action=="styleSpecPgh"){applyParagraphStyle(d.content,d.extra)}else{if(d.action=="cursor"){var a=d.content.split(",");var e=d.extra?d.extra.split(","):[];console.log(d,a,e);manageCursorChangeEvent(b,d.user,a[0],a[1],e[0],e[1],c)}else{if(d.action=="paste"){console.log(d);manageInsertHtml(d.content,d.user,b,c)}else{if(d.action=="page"){switch(d.content){case"BRK":pageRender.pageBreak(d.user,b,d.extra);break;case"NEW":pageRender.newPage(d.user,b,d.extra);break}}}}}}}}}}}Cursor.setCursor(d.user,b)}function handleUserDisconnect(b){for(var a=0;a<KolabInReal.currentSquareMembers.length;a++){if(KolabInReal.currentSquareMembers[a].kolabID===b.user){var c=$doc("div.page").children().filter(function(){return($(this).hasClass("background_blue"))});c.removeClass("locked");c.removeClass("background_blue");$doc("div.cursor#"+b.user).remove();$doc("div.selAnchor#"+b.user).remove();KolabInReal.currentSquareMembers.splice(a,1);break}}removeUserCursorManagement(b.user)}function manageUpdateUserInfo(b,d){var e=false;for(var a=0;a<KolabInReal.currentSquareMembers.length;a++){if(KolabInReal.currentSquareMembers[a].kolabID==d.user){e=true}}if(b==d.user){d.content="#FF0063"}if(!e){var c={kolabID:d.user,colorVisible:true,color:d.content};KolabInReal.currentSquareMembers.push(c);createCSSRules()}addUserCursorManagement(d.user)}function manageCursorChangeEvent(j,h,e,a,i,d,f){var c={};var b;var g;c.custom=true;if(i){c.isCollapsed=false;b=childAtPos($doc('p.paragraphContainer[klb="'+i+'"]'),d);c.anchorNode=b[0];c.anchorOffset=b[1];c.isCollapsed=false}else{c.isCollapsed=true;g=$doc("div.selAnchor#"+h).parent();$doc("div.selAnchor#"+h).remove();if(g.length){mergeAllNode($.makeArray($(g)[0].childNodes))}}b=childAtPos($doc('p.paragraphContainer[klb="'+e+'"]'),a);c.focusNode=b[0];c.focusOffset=b[1];manageSelectionChange(c,h,j,f)}function sendPasteEvent(d,a,c){var b={};b.action="paste";b.content=c;b.extra=klbGenerator();sendMessage(b,d,a)}function sendParagraphChangeEvent(f,d,e,c,a){var b={};b.action=f;b.content=d;b.extra=e;sendMessage(b,c,a)}function sendKeyEventToServer(f,g,b,e,a,d){var c={};c.action=f;c.content=g;c.extra=b;if(d){c.undo=d}sendMessage(c,e,a)}function sendPageEvent(d,e,c,a){var b={};b.action="page";b.content=d;b.extra=e;sendMessage(b,c,a)}function sendPositionChangeEventToServer(a,g,f,c,e,b){var d={};d.action="cursor";d.content=g+","+a;d.extra=c?c+","+f:null;sendMessage(d,e,b)}function sendClientReady(d,c,a){var b={};b.status="ready";b.content=c;sendStatus(b,d,a)}function sendStatus(c,b,a){c.doc=document.location.pathname.substr(1);c.user=b;a.emit("status",c)}function sendMessage(c,b,a){c.id=(Math.floor(Math.random()*10000));c.doc=document.location.pathname.substr(1);c.user=b;a.emit("changeset",c)};function initPasteManager(c,b,a){$("iframe#r_engine").contents()[0].addEventListener("paste",function(g){g.preventDefault(true);var d=managePaste(g,c,"kolab");sendPasteEvent(c,a,d);checkToolbarState(c);Cursor.setCursor(c,"#FF0063");var f=$("iframe#r_engine").contents()[0].getSelection();f.removeAllRanges()});$("iframe#r_engine").contents()[0].addEventListener("copy",function(d){d.preventDefault(true);var f=manageCopy(c);if(f){d.clipboardData.setData("text/html",f);d.clipboardData.setData("text",f.replace(/<(span|p).*?>|<\/(span|p)>/g,""))}});$("iframe#r_engine").contents()[0].addEventListener("cut",function(d){d.preventDefault(true);var f=manageCopy(c);if(f){d.clipboardData.setData("text/html",f);d.clipboardData.setData("text",f.replace(/<(span|p).*?>|<\/(span|p)>/g,""))}selectionDelete(c,b,"undo")})}function manageCopy(k){if($doc("div.selAnchor#"+k).length){var l,c,p,j,d,h,n;if($doc("div.selAnchor#"+k).parents("p.paragraphContainer").attr("klb")==$doc("div.cursor#"+k).parents("p.paragraphContainer").attr("klb")){d=$doc("div.selAnchor#"+k).parents("p.paragraphContainer")[0].outerHTML.replace(/<div class="selection(Start|End)?Box".*?><\/div>/g,"");if($($doc("div.selAnchor#"+k+",div.cursor#"+k)[0]).is("div.selAnchor#"+k)){h="selAnchor";n="cursor"}else{h="cursor";n="selAnchor"}j=new RegExp('(<p.*?>).*?<div class="'+h+'" id="'+k+'"></div>(.*?)<div class="'+n+'" id="'+k+'"></div>.*?</p>');l=new RegExp('(<div class="'+h+'" id="'+k+'"></div>)');c=new RegExp('(<div class="'+n+'" id="'+k+'"></div>)');p=$doc("div."+h+"#"+k);d=d.replace(l,'$1<span author="'+p.parents("span[author]").attr("author")+'" style="'+p.parents("span[author]").attr("style")+'">');d=d.replace(c,"</span>$1");d=d.replace(j,"$1$2")+"</p>";d=d.replace(/<span author=".*?><\/span>/g,"");d=d.replace(/class="paragraphContainer.*?"/g,'class="paragraphContainer"')}else{if($($doc("div.selAnchor#"+k+",div.cursor#"+k)[0]).is("div.selAnchor#"+k)){h="selAnchor";n="cursor"}else{h="cursor";n="selAnchor"}var o=new RegExp('(<p.*?>).*?<div class="'+h+'" id="'+k+'"></div>(.*?</p>)');var q=new RegExp('(<p.*?>.*?)<div class="'+n+'" id="'+k+'"></div>.*?</p>');l=new RegExp('(<div class="'+h+'" id="'+k+'"></div>)');c=new RegExp('(<div class="'+n+'" id="'+k+'"></div>)');p=$doc("div."+h+"#"+k);var f=p.parents("p.paragraphContainer");var e=$doc("div."+n+"#"+k).parents("p.paragraphContainer");var a=f[0].outerHTML;a=a.replace(/<div class="selection(Start|End)?Box".*?><\/div>/g,"");a=a.replace(l,'$1<span author="'+p.parents("span[author]").attr("author")+'" style="'+p.parents("span[author]").attr("style")+'">');a=a.replace(o,"$1$2");a=a.replace(/<span author=".*?><\/span>/g,"");d=a;var g=$(f[0].nextSibling);while(!g.is(e)){d+=g[0].outerHTML;if(!$(g[0].nextSibling).length&&g.parent()[0].nextSibling){var m=$(g.parent()[0].nextSibling);if(m.hasClass("pageBreak")){m=$(m[0].nextSibling)}g=m.children(":first")}else{g=$(g[0].nextSibling)}}var b=e[0].outerHTML;b=b.replace(/<div class="selection(Start|End)?Box".*?><\/div>/g,"");b=b.replace(c,"</span>$1");b=b.replace(q,"$1")+"</p>";console.log(b);b=b.replace(/<span author=".*?><\/span>/g,"");window.console.log(b);d+=b;d=d.replace(/class="paragraphContainer.*?"/g,'class="paragraphContainer"');if(d.match(/<iframe.*?>/)){d=d.match(/<p class="paragraphContainer.*?>.*?<\/p>/g);for(i=0;i<d.length;i++){if(d[i].match(/<iframe.*?>/)){d.splice(i,1);i--}}d=d.join("")}window.console.log(d)}return applyHeadToText(d)}return null}function managePaste(f,c,b){var d=f.clipboardData.getData("text/html");var a="font-family:arial,helvetica,sans-serif;font-size:16px;background-color:transparent;font-weight:normal;font-style:normal;text-decoration:none;";if(!d.length==0){if(d.match(/<p class="paragraphContainer.*?" klb=".*?>/)){d=d.replace(/[\n\r]/g,"").replace(/.+<!--StartFragment-->/,"").replace(/<!--EndFragment-->.+/,"");d=d.replace(/(<p.*?klb=").*?(".*?>)/g,function(e,h,g){return(h+klbGenerator()+g)})}else{if(d.match(/<w:WordDocument>/)){d=manageWordPaste(d,c)}else{if(d.match(/<.*?CONTENT="OpenOffice.*?>/)){d=manageOpenOfficePaste(d,c)}else{if(d.match(/<(span|strong|u|i|p).*?>/)){d=manageHtmlPaste(d,c)}else{d=$(d).text();d='<p class="paragraphContainer" klb="'+klbGenerator()+'"><span author="rosendaEngine" style="'+a+'">'+d+"</span></p>"}}}}}else{var d=f.clipboardData.getData("text");d=$(d).text();d='<p class="paragraphContainer" klb="'+klbGenerator()+'"><span author="rosendaEngine" style="'+a+'">'+d+"</span></p>"}manageInsertHtml(d,c,b,"undo");return d}function manageWordPaste(f,d){var c="font-family:arial,helvetica,sans-serif;font-size:16px;background-color:transparent;font-weight:normal;font-style:normal;text-decoration:none;";f=f.replace(/[\n\r]/g,"").replace(/.+<!--StartFragment-->/,"").replace(/<!--EndFragment-->.+/,"").replace(/(<.*?>)|(<\/.*?>)/g,function(j,h){if(h.match(/<\/?(span|b|u|i|p)/)){return h}else{return""}});f=f.match(htmlPartsPlus);var g=[];g.push(0);g.push("");window.console.log(g[0]);for(i=0;i<f.length;i++){if(f[i].match(/<p.*?>/)){if(f[i].match(/<p.*?style=["'].+?["'].*?>/)){f[i]=f[i].replace(/<p.*?style=["'](.*?)["'].*?>/g,function(j,l){var h="";var k=null;k=l.match(/line-height: ?(150|200|250)%/);if(k){switch(k[1]){case"150":h+="line-height: 1.5;";break;case"200":h+="line-height: 2.0;";break;case"250":h+="line-height: 2.5;";break}}else{h+="line-height: normal;"}k=l.match(/text-align: ?(center|right|justify)/);h+=k!=null?"text-align: "+k[1]+";":"text-align: left;";return'<p class="paragraphContainer" klb="'+klbGenerator()+'" style="'+h+'">'})}else{f[i]='<p class="paragraphContainer" klb="'+klbGenerator()+'">'}g[0]=1;g[1]=f[i]}else{if(f[i].match(/<\/p>/)){g[0]=0;g[1]=""}else{if(f[i].match(/<b.*?>/)){window.console.log(g);if(i!=0&&f[i-1].match(/<span.*?>/)){f[i-1].replace(/font-weight:.*?;/,"font-weight: bold;");f.splice(i,1);g[1]=f[i-1]}else{if(g[0]<=1){f[i]='<span author="'+d+'" style="'+c+'">'}else{f[i]='<span author="'+d+'" style="'+g[1].match(/<span.*?style="(.+?)".*?>/)[1]+'">'}f[i]=f[i].replace(/font-weight:.*?;/,"font-weight: bold;");if(g[0]==2){f[i]="</span>"+f[i];g[0]=3}else{if(g[0]>2){f[i]="</span>"+f[i];g[0]++;g.push(f[i])}else{g[0]=2;g[1]=f[i]}}}}else{if(f[i].match(/<i.*?>/)){window.console.log(g[0]);if(i!=0&&f[i-1].match(/<span.*?>/)){f[i-1].replace(/font-style:.*?;/,"font-style: italic;");f.splice(i,1);g[1]=f[i-1];i--}else{if(g[0]<=1){f[i]='<span author="'+d+'" style="'+c+'">'}else{f[i]='<span author="'+d+'" style="'+g[1].match(/<span.*?style="(.+?)".*?>/)[1]+'">'}f[i]=f[i].replace(/font-style:.*?;/,"font-style: italic;");if(g[0]==2){f[i]="</span>"+f[i];g[0]=3}else{if(g[0]>2){f[i]="</span>"+f[i];g[0]++;g.push(f[i])}else{g[0]=2;g[1]=f[i]}}}}else{if(f[i].match(/<u.*?>/)){window.console.log(g[0]);if(i!=0&&f[i-1].match(/<span.*?>/)){f[i-1].replace(/text-decoration:.*?;/,"text-decoration: underline;");f.splice(i,1);g[1]=f[i-1];i--}else{if(g[0]<=1){f[i]='<span author="'+d+'" style="'+c+'">'}else{f[i]='<span author="'+d+'" style="'+g[1].match(/<span.*?style="(.+?)".*?>/)[1]+'">'}f[i]=f[i].replace(/text-decoration:.*?;/,"text-decoration: underline;");if(g[0]==2){f[i]="</span>"+f[i];g[0]=3}else{if(g[0]>2){f[i]="</span>"+f[i];g[0]++;g.push(f[i])}else{g[0]=2;g[1]=f[i]}}}}else{if(f[i].match(/<\/(span|b|i|u)>/)){if(i!=0&&f[i-1].match(/<\/span>/)){f.splice(i,1);i--}else{f[i]="</span>";if(g[0]>3){if(!(i!=f.length-1&&f[i+1].match(/<\/span>/))){f[i]+=g.pop();g[0]--}}else{if(g[0]==3){if(!(i!=f.length-1&&f[i+1].match(/<\/span>/))){f[i]+=g[1];g[0]=2;g[1]=""}}else{g[0]=1;g[1]=""}}}}else{if(f[i].match(/<span.*?style='.+?'.*?>/)){var e=f[i].match(/<span.*?style='(.+?)'.*?>/)[1];if(i!=0&&f[i-1].match(/<span.*?>/)){var b=f[i-1].match(/<span.*?style='(.+?)'.*?>/)[1]}else{var b=c}var a;a=e.match(/background: ?(yellow|lime|aqua|fuchsia|purple|red|silver)/);if(a){b=b.replace(/background-color:.*?;/,function(){switch(a[1]){case"yellow":return"background-color:#FFFF00;";break;case"lime":return"background-color:#48FF48;";break;case"aqua":return"background-color:#40FFFF;";break;case"fuchsia":return"background-color:#FF82FF;";break;case"purple":return"background-color:#7171FF;";break;case"red":return"background-color:#FF4242;";break;case"silver":return"background-color:#C0C0C0;";break}})}a=e.match(/font-size: ?(8|9|10|11|14|16|18|20|22|24|26|28|36|48|72).0pt/);if(a){b=b.replace(/font-size:.*?;/,function(){switch(a[1]){case"8":return"font-size: 11px;";break;case"9":return"font-size: 12px;";break;case"10":return"font-size: 13px;";break;case"11":return"font-size: 15px;";break;case"14":return"font-size: 19px;";break;case"16":return"font-size: 22px;";break;case"18":return"font-size: 24px;";break;case"20":return"font-size: 26px;";break;case"22":return"font-size: 29px;";break;case"24":return"font-size: 32px;";break;case"26":return"font-size: 35px;";break;case"28":return"font-size: 37px;";break;case"36":return"font-size: 48px;";break;case"48":return"font-size: 64px;";break;case"72":return"font-size: 96px;";break}})}a=e.match(/font-family: ?("Arial","sans-serif"|"Arial Black","sans-serif"|"Georgia","serif"|"Impact","sans-serif"|"Lucida Sans Unicode","sans-serif"|"Myriad Pro","sans-serif"|"Tahoma","sans-serif"|"Times New Roman","serif"|"Trebuchet MS","sans-serif"|"Verdana","sans-serif")/);if(a){b=b.replace(/font-family:.*?;/,convertFont(a[1]))}if(i!=0&&f[i-1].match(/<span.*?>/)){f[i-1]=f[i-1].replace(/(<span.*?style=["']).*?(["'].*?>)/,"$1"+b+"$2");f.splice(i,1);g[1]=f[i-1];i--}else{f[i]='<span author="'+d+'" style="'+b+'">';if(g[0]==3){f[i]="</span>"+[f[i]];g[0]=3}else{if(g[0]>3){f[i]="</span>"+f[i];g[0]++;g.push(f[i])}else{g[0]=2;g[1]=f[i];window.console.log(g)}}}}else{if(f[i].match(/<.*?>/)){f.splice(i,1);i--}else{if(g[0]==1){f[i]='<span author="'+d+'" style="'+c+'">'+f[i]+"</span>"}}}}}}}}}}f=f.join("");f=f.replace(/<span .*?>(.*?)<\/span>/g,function(h,j){if(!j.length){return""}else{return h}});return f}function manageOpenOfficePaste(f,d){var b="font-family:arial,helvetica,sans-serif;font-size:16px;background-color:transparent;font-weight:normal;font-style:normal;text-decoration:none;";f=f.toLowerCase();f=f.replace(/[\n\r]/g,"").replace(/.+<body.*?>/,"").replace(/<\/body>.+/,"").replace(/(<.*?>)|(<\/.*?>)/g,function(j,h){if(h.match(/<\/?(span|font|b|u|i|p)/)){return h}else{return""}});f=f.match(htmlPartsPlus);var g=[0,""];for(i=0;i<f.length;i++){if(f[i].match(/<p.*?>/)){if(f[i].match(/<p.*?style.*?>/)){f[i]=f[i].replace(/<p.*?style=["'](.*?)["'].*?>/g,function(j,l){var h="";var k=null;k=l.match(/line-height: ?(150|200|250)%/);if(k){switch(k[1]){case"150":h+="line-height: 1.5;";break;case"200":h+="line-height: 2.0;";break;case"250":h+="line-height: 2.5;";break}}else{h+="line-height: normal;"}k=j.match(/align= ?(center|right|justify)/);h+=k!=null?"text-align: "+k[1]+";":"text-align: left;";return'<p class="paragraphContainer" klb="'+klbGenerator()+'" style="'+h+'">'})}else{f[i]='<p class="paragraphContainer" klb="'+klbGenerator()+'">'}g[0]=1;g[1]=f[i]}else{if(f[i].match(/<\/p>/)){g[0]=0;g[1]=""}else{if(f[i].match(/<b.*?>/)){if(i!=0&&f[i-1].match(/<span.*?>/)){f[i-1]=f[i-1].replace(/font-weight:.*?;/,"font-weight: bold;");f.splice(i,1);g[1]=f[i-1];i--}else{if(g[0]<=1){f[i]='<span author="'+d+'" style="'+b+'">'}else{f[i]='<span author="'+d+'" style="'+g[1].match(/<span.*?style="(.+?)".*?>/)[1]+'">'}f[i]=f[i].replace(/font-weight:.*?;/,"font-weight: bold;");if(g[0]==2){f[i]="</span>"+f[i];g[0]=3}else{if(g[0]>2){f[i]="</span>"+f[i];g[0]++;g.push(f[i])}else{g[0]=2;g[1]=f[i]}}}}else{if(f[i].match(/<i.*?>/)){if(i!=0&&f[i-1].match(/<span.*?>/)){f[i-1]=f[i-1].replace(/font-style:.*?;/,"font-style: italic;");f.splice(i,1);g[1]=f[i-1];i--}else{if(g[0]<=1){f[i]='<span author="'+d+'" style="'+b+'">'}else{f[i]='<span author="'+d+'" style="'+g[1].match(/<span.*?style="(.+?)".*?>/)[1]+'">'}f[i]=f[i].replace(/font-style:.*?;/,"font-style: italic;");if(g[0]==2){f[i]="</span>"+f[i];g[0]=3}else{if(g[0]>2){f[i]="</span>"+f[i];g[0]++;g.push(f[i])}else{g[0]=2;g[1]=f[i]}}}}else{if(f[i].match(/<u.*?>/)){if(i!=0&&f[i-1].match(/<span.*?>/)){f[i-1]=f[i-1].replace(/text-decoration:.*?;/,"text-decoration: underline;");f.splice(i,1);g[1]=f[i-1];i--}else{if(g[0]<=1){f[i]='<span author="'+d+'" style="'+b+'">'}else{f[i]='<span author="'+d+'" style="'+g[1].match(/<span.*?style="(.+?)".*?>/)[1]+'">'}f[i]=f[i].replace(/text-decoration:.*?;/,"text-decoration: underline;");if(g[0]==2){f[i]="</span>"+f[i];g[0]=3}else{if(g[0]>2){f[i]="</span>"+f[i];g[0]++;g.push(f[i])}else{g[0]=2;g[1]=f[i]}}}}else{if(f[i].match(/<font.*?size=.*?>/)){var c=f[i].replace(/<font.*?size=(\d)( .*?style="(.*?)".*?)?>/,function(k,j,h,l){if(l){switch(l.match(/font-size: ?(\d{1,2})pt/)[1]){case"8":return"font-size: 11px;";break;case"9":return"font-size: 12px;";break;case"11":return"font-size: 15px;";break;case"16":return"font-size: 22px;";break;case"20":return"font-size: 26px;";break;case"22":return"font-size: 29px;";break;case"26":return"font-size: 35px;";break;case"28":return"font-size: 37px;";break;case"48":return"font-size: 64px;";break;case"72":return"font-size: 96px;";break;default:return"font-size: 16px;"}}else{switch(j){case"2":return"font-size :13px;";break;case"3":return"font-size :16px;";break;case"4":return"font-size :19px;";break;case"5":return"font-size :24px;";break;case"6":return"font-size :32px;";break;case"7":return"font-size :48px;";break}}});if(i!=0&&f[i-1].match(/<span.*?>/)){f[i-1]=f[i-1].replace(/font-size:.*?;/,c);console.log(f[i],f[i+1]);f.splice(i,1);g[1]=f[i-1];i--}else{if(g[0]<=1){f[i]='<span author="'+d+'" style="'+b+'">'}else{f[i]='<span author="'+d+'" style="'+g[1].match(/<span.*?style="(.+?)".*?>/)[1]+'">'}f[i]=f[i].replace(/font-size:.*?;/,c);if(g[0]==2){f[i]="</span>"+f[i];g[0]=3}else{if(g[0]>2){f[i]="</span>"+f[i];g[0]++;g.push(f[i])}else{g[0]=2;g[1]=f[i]}}}}else{if(f[i].match(/<font.*?face=.*?>/)){var e=convertFont(f[i].match(/<font.*?face="(.*?)".*?>/)[1]);if(i!=0&&f[i-1].match(/<span.*?>/)){f[i-1]=f[i-1].replace(/font-family:.*?;/,e);f.splice(i,1);g[1]=f[i-1];i--}else{if(g[0]<=1){f[i]='<span author="'+d+'" style="'+b+'">'}else{f[i]='<span author="'+d+'" style="'+g[1].match(/<span.*?style="(.+?)".*?>/)[1]+'">'}f[i]=f[i].replace(/font-family:.*?;/,e);if(g[0]==2){f[i]="</span>"+f[i];g[0]=3}else{if(g[0]>2){f[i]="</span>"+f[i];g[0]++;g.push(f[i])}else{g[0]=2;g[1]=f[i]}}}}else{if(f[i].match(/<span.*?style=.*?>/)){var a=f[i].replace(/<span.*?style="(.*?").*?>/,function(j,h){switch(h.match(/background: ?(.*?)[" ]/)[1]){case"#ffff00":return"background-color: #FFFF00;";break;case"#00ff00":return"background-color: #48FF48;";break;case"#00ffff":return"background-color: #40FFFF;";break;case"#ff00ff":return"background-color: #FF82FF;";break;case"#800080":return"background-color: #7171FF;";break;case"#ff0000":return"background-color: #FF4242;";break;case"#c0c0c0":return"background-color: #C0C0C0;";break;default:return"background-color: transparent;";break}});if(i!=0&&f[i-1].match(/<span.*?>/)){f[i-1]=f[i-1].replace(/background-color:.*?;/,a);f.splice(i,1);g[1]=f[i-1];i--}else{if(g[0]<=1){f[i]='<span author="'+d+'" style="'+b+'">'}else{f[i]='<span author="'+d+'" style="'+g[1].match(/<span.*?style="(.+?)".*?>/)[1]+'">'}f[i]=f[i].replace(/background-color:.*?;/,a);if(g[0]==2){f[i]="</span>"+f[i];g[0]=3}else{if(g[0]>2){f[i]="</span>"+f[i];g[0]++;g.push(f[i])}else{g[0]=2;g[1]=f[i]}}}}else{if(f[i].match(/<\/(span|font|b|i|u)>/)){if(i!=0&&f[i-1].match(/<\/span>/)){f.splice(i,1);i--}else{f[i]="</span>";if(g[0]==3){if(!(i!=f.length-1&&f[i+1].match(/<\/span>/))){f[i]+=g[1];g[0]=2;g[1]=""}}else{if(g[0]>3){f[i]="</span>"+f[i];g[0]++;g.push(f[i])}else{g[0]=1;g[1]=""}}}}else{if(f[i].match(/<.*?>/)){f.splice(i,1);i--}else{if(g[0]==1){f[i]='<span author="'+d+'" style="'+b+'">'+f[i]+"</span>"}}}}}}}}}}}}f=f.join("");return f}function manageHtmlPaste(c,b){var a="font-family:arial,helvetica,sans-serif;font-size:16px;background-color:transparent;font-weight:normal;font-style:normal;text-decoration:none;";c=c.replace(/[\n\r]/g,"").replace(/.+<!--StartFragment-->/,"").replace(/<!--EndFragment-->.+/,"").replace(/(<.*?>)|(<\/.*?>)/g,function(e,d){if(d.match(/<\/?(span|strong|u|i|p|br)/)){return d}else{return""}});c=c.replace(/<span class="Apple-converted-space">.*?<\/span>/g," ");c=c.replace(/<(span|strong|u|i).*?style="(.*?)".*?>(.*?)<\/(span|strong|u|i)>/g,function(g,d,h,j){var f="";var e;e=h.match(/font-family:(.*?);/);f+=e!=null?convertFont(e[1]):"font-family: arial,helvetica,sans-serif;";e=h.match(/font-size: ?(11px|12px|13px|15px|19px|22px|24px|26px|29px|32px|35px|37px|48px|64px|96px);?/);f+=e!=null?"font-size: "+e[1]+";":"font-size: 16px;";e=h.match(/background-color: ?((rgb(255,255,0)|#FFFF00|#ffff00)|(rgb(72,255,72)|#48FF48|#48ff48))|(rgb(64,255,255)|#40FFFF|#40ffff)|(rgb(255,130,255)|#FF82FF|#ff82ff)|(rgb(113,113,255)|#7171FF|#7171ff)|(rgb(255,66,66)|#FF4242|#ff4242)|(rgb(192,192,192)|#C0C0C0|#c0c0c0);?/);f+=e!=null?"background-color: "+e[1]+";":"background-color: transparent;";e=h.match(/font-weight: ?bold;?/);f+=e!=null?"font-weight: bold;":"font-weight: normal;";e=h.match(/font-style: ?italic;?/);f+=e!=null?"font-style: italic;":"font-style: normal;";e=h.match(/text-decoration: ?underline;?/);f+=e!=null?"text-decoration: underline;":"text-decoration: none;";if(d=="strong"){if(f.match(/font-weight:normal;/)){f.replace(/font-weight:normal;/,"font-weight: bold;")}else{f+="font-weight: bold;"}}else{if(d=="i"){if(f.match(/font-style:normal;/)){f.replace(/font-style:normal;/,"font-style: italic;")}else{f+="font-style: italic;"}}else{if(d=="u"){if(f.match(/text-decoration:none;/)){f.replace(/text-decoration:none;/,"text-decoration:underline;")}else{f+="text-decoration:underline;"}}}}return'<span author="rosendaEditor" style="'+f+'">'+j+"</span>"});c=c.replace(/<p.*?style="(.*?)".*?>(.*?)<\/p>/g,function(f,h,j){var e="";var d="";var g=null;g=h.match(/line-height: ?(1.5|2|2.5);?/);e+=g!=null?"line-height: "+g[1]+";":"line-height: normal;";g=h.match(/text-align: ?(center|right|justify);?/);e+=g!=null?"text-align: "+g[1]+";":"text-align: left;";g=h.match(/padding-left: ?(30px|60px|90px|120px);?/);e+=g!=null?"padding-left: "+g[1]+";":"padding-left: 0px;";g=h.match(/font-family:(.*?);/);d+=g!=null?convertFont(g[1]):"";g=h.match(/font-size: ?(11px|12px|13px|15px|19px|22px|24px|26px|29px|32px|35px|37px|48px|64px|96px);?/);d+=g!=null?"font-size: "+g[1]+";":"";g=h.match(/background-color: ?((rgb(255,255,0)|#FFFF00)|(rgb(72,255,72)|#48FF48))|(rgb(64,255,255)|#40FFFF)|(rgb(255,130,255)|#FF82FF)|(rgb(113,113,255)|#7171FF)|(rgb(255,66,66)|#FF4242)|(rgb(192,192,192)|#C0C0C0);?/);d+=g!=null?"background-color: "+g[1]+";":"";g=h.match(/font-weight: ?bold;?/);d+=g!=null?"font-weight: bold;":"";g=h.match(/font-style: ?italic;?/);d+=g!=null?"font-style: italic;":"";g=h.match(/text-decoration: ?underline;?/);d+=g!=null?"text-decoration: underline;":"";if(d.lenght){return'<p class="paragraphContainer" klb="'+klbGenerator()+'" style="'+e+'"><span author="rosendaEditor" style="'+d+'">'+j+"</span></p>"}else{return'<p class="paragraphContainer" klb="'+klbGenerator()+'" style="'+e+'">'+j+"</p>"}});if(!c.match(/<p/)){window.console.log("bob1");c='<p class="paragraphContainer" klb="'+klbGenerator()+'">'+c+"</p>";if(c.match(/<br/)){console.log("br");c=c.replace(/(<br.*?>)+/g,'</p><p class="paragraphContainer" klb="'+klbGenerator()+'">')}}else{if(c.match(/<br/)){c=c.replace(/<br.*?>/,"")}}return c}function manageInsertHtml(d,g,l,a){if(a=="undo"||a=="redo"){var e={};e.klb=$doc("div.cursor#"+g).parents("p.paragraphContainer").attr("klb");e.pos=evaluateCursorPosInText(g,"cursor")}if($doc("div.selAnchor#"+g).length){selectionDelete(g,l)}d=d.match(/<p class="paragraphContainer".*?<\/p>|.*/g);for(i=0;i<d.length;i++){if(!d[i].length){d.splice(i,1);i--}else{if(!d[i].match(/<p/)){d[i]='<p class="paragraphContainer" klb="'+klbGenerator()+'">'+d[i]+"</p>"}}}var k=$doc("div.cursor#"+g);var b=k.parents("span[author]");var h;if($doc("div.cursor#"+g)[0].nextSibling&&$doc("div.cursor#"+g)[0].previousSibling){b.after('<span author="'+k.parents("span[author]").attr("author")+'" style="'+k.parents("span[author]").attr("style")+'"></span>');h=$(b[0].nextSibling);while($doc("div.cursor#"+g)[0].nextSibling){h.prepend($doc("div.cursor#"+g)[0].nextSibling)}}if(d.length==1){if(!$doc("div.cursor#"+g)[0].previousSibling){k.remove();b.before(d[0].replace(/<p.*?>(.*?)<\/span><\/p>/,'$1<div class="cursor" id="'+g+'"></div></span>'));b=$(b[0].previousSibling)}else{k.remove();b.after(d[0].replace(/<p.*?>(.*?)<\/span><\/p>/,'$1<div class="cursor" id="'+g+'"></div></span>'))}if(b.attr("author")==b.next("span[author]").attr("author")&&b.attr("style")==b.next("span[author]").attr("style")){combineSpanAuthor(b,b.next("span[author]"));if(b.attr("author")==b.next("span[author]").attr("author")&&b.attr("style")==b.next("span[author]").attr("style")){combineSpanAuthor(b,b.next("span[author]"))}}}else{if(!$doc("div.cursor#"+g)[0].previousSibling){b.after('<span author="'+k.parents("span[author]").attr("author")+'" style="'+k.parents("span[author]").attr("style")+'"></span>');h=$(b[0].nextSibling);while($doc("div.cursor#"+g)[0].nextSibling){h.prepend($doc("div.cursor#"+g)[0].nextSibling)}}h=k.parents("span[author]")[0].nextSibling;var f="",j;while(h){f+=h.outerHTML;j=h.nextSibling;$(h).remove();h=j}b.after(d[0].replace(/<p.*?>(.*?)<\/p>/,"$1"));k=$doc("div.cursor#"+g);if(b.attr("author")==b.next("span[author]").attr("author")&&b.attr("style")==b.next("span[author]").attr("style")){combineSpanAuthor(b,b.next("span[author]"))}var c=k.parents("p.paragraphContainer");k.remove();for(i=1;i<d.length;i++){c.after(d[i]);c=$(c[0].nextSibling)}if(!b[0].childNodes.length){b.remove()}b=c.children("span[author]:last");b.append('<div class="cursor" id="'+g+'"></div>');b.after(f);if(b.attr("author")==b.next("span[author]").attr("author")&&b.attr("style")==b.next("span[author]").attr("style")){combineSpanAuthor(b,b.next("span[author]"))}}if(a=="undo"||a=="redo"){var k={};k.klb=$doc("div.cursor#"+g).parents("p.paragraphContainer").attr("klb");k.pos=evaluateCursorPosInText(g,"cursor")}if(a=="undo"){Undo.addElement("break");Undo.addElement({action:"spec",content:"BAK",user:g,extra:""});Undo.addElement({action:"cursor",content:(k.klb+","+k.pos),user:g,extra:(e.klb+","+e.pos)})}else{if(a=="redo"){Redo.addElement("break");Redo.addElement({action:"spec",content:"BAK",user:g,extra:""});Redo.addElement({action:"cursor",content:(k.klb+","+k.pos),user:g,extra:(e.klb+","+e.pos)})}}setParagraphLock(g,l)}function convertFont(a){if(a.match(/[Aa]rial [Bb]lack/)){return"font-family: arial black,helvetica,sans-serif;"}else{if(a.match(/[Gg]eorgia/)){return"font-family: georgia,serif;"}else{if(a.match(/[Ii]mpact/)){return"font-family: impact,cursive;"}else{if(a.match(/[Ll]ucida [Ss]ans [Uu]nicode/)){return"font-family: lucida sans unicode, lucida grande, sans-serif;"}else{if(a.match(/[Mm]yriad[- ][Pp]ro/)){return"font-family: myriad-pro,sans-serif;"}else{if(a.match(/[Tt]ahoma/)){return"font-family: tahoma,geneva,sans-serif;"}else{if(a.match(/[Tt]imes [Nn]ew [Rr]oman/)){return"font-family: times new roman, times, serif;"}else{if(a.match(/[Tt]rebuchet [Mm][Ss]/)){return"font-family: trebuchet ms,helvetica,sans-serif;"}else{if(a.match(/[Vv]erdana/)){return"font-family: verdana,geneva,sans-serif;"}else{return"font-family: arial,helvetica,sans-serif;"}}}}}}}}}};/*
Copyright 2012 Adobe Systems Inc.;
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
!function(){if(typeof String.prototype.trim!=="function"){String.prototype.trim=function(a){return a.replace(/^\s+/,"").replace(/\s+$/,"")}}if(typeof Array.prototype.forEach!=="function"){Array.prototype.forEach=function(e,b){if(typeof e!=="function"){throw new TypeError("Invalid parameter. Expected 'function', got "+typeof e)}var c=Object(this),a=c.length,d=0;for(d;d<a;d++){e.call(b,this[d],d,c)}}}if(typeof Array.prototype.indexOf!=="function"){Array.prototype.indexOf=function(b){var a=Object(this),c=-1;a.forEach(function(e,d){if(e===b){c=d;return}});return c}}}()
/*
Copyright 2012 Adobe Systems Inc.;
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
;!(function(c){function d(){var h=document,j=[];if(typeof h.querySelectorAll=="function"){j=h.querySelectorAll('link[rel="stylesheet"], style');j=Array.prototype.slice.call(j,0)}else{var f=h.getElementsByTagName("link");if(f.length){for(var g=0,e=f.length;g<e;g++){if(f[g].getAttribute("rel")==="stylesheet"){j.push(f[g])}}}f=h.getElementsByTagName("style");for(var g=0,e=f.length;g<e;g++){j.push(f[g])}}return j}function b(e){this.source=e;this.url=e.href||null;this.cssText=""}b.prototype.load=function(i,g,f){var e=this;if(this.url){var h=new XMLHttpRequest();h.onreadystatechange=function(){if(h.readyState===4){if(h.status===200){e.cssText=h.responseText;i.call(f,e)}else{g.call(f,e)}}};h.open("GET",this.url,false);h.send(null)}else{this.cssText=this.source.textContent;i.call(f,e)}};function a(e){if(!(this instanceof a)){return new a(e)}this.stylesheets=[];this.queueCount=0;this.callback=e||function(){};this.init()}a.prototype.init=function(){var h=d(),e=h.length,g,f;this.queueCount=e;for(f=0;f<e;f++){g=new b(h[f]);this.stylesheets.push(g);g.load(this.onStyleSheetLoad,this.onStyleSheetError,this)}};a.prototype.onStyleSheetLoad=function(e){this.queueCount--;this.onComplete.call(this)};a.prototype.onStyleSheetError=function(g){var e=this.stylesheets.length,f;for(f=0;f<e;f++){if(g.source===this.stylesheets[f].source){this.stylesheets.splice(f,1);this.queueCount--;this.onComplete.call(this);return}}};a.prototype.onComplete=function(){if(this.queueCount===0){this.callback.call(this,this.stylesheets)}};c.StyleLoader=a})(window);
/*
Copyright 2012 Adobe Systems Inc.;
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
!function(c){function b(){this.selectorText=null;this.style={};this.type="rule"}b.prototype={setSelector:function(d){this.selectorText=d;var e=d.match(/^@([^\s]+)\s*([^{]+)?/);if(e&&e[1]){switch(e[1]){case"template":this.type="template";this.cssRules=[];break;case"slot":this.type="slot";break;default:this.type="unknown"}this.identifier=e[2]||"auto"}},setStyle:function(d){if(!d){throw new TypeError("CSSRule.setStyles(). Invalid input. Expected 'object', got "+d)}this.style=d||{};return this.style},setParentRule:function(d){if(!d){throw new TypeError("CSSRule.setParentRule(). Invalid input. Expected 'object', got "+properties)}this.parentRule=d;return this.parentRule}};function a(){function f(i){var j=i.trim().split(";");if(j.length){return j.pop().trim()}return null}function d(i){var j={},k=i.trim().split(";");if(!k||!k.length){return j}k.forEach(function(o){if(o.indexOf(":")==-1){return}var l,m,n=o.split(":");if(n[0]!==undefined&&n[1]!==undefined){l=n[0].trim();m=n[1].trim().replace(/[\"\']/g,"");j[l]=m}});return j}function g(o,s,t){var j=o.indexOf("{"),q,r=new b,k=o.substring(0,j),l=f(k),u=o.substr(j+1,o.length),n=u.indexOf("}"),i=u.indexOf("{");if(j>0){r.setSelector(l);if(t){r.setParentRule(t);q=d(k);t.setStyle(q)}if(i>-1&&i<n){n=p(u,1);var m=u.substring(0,n);q=d(k);r.setStyle(q);r.cssRules=r.cssRules||[];g(m,r.cssRules,r);u=u.substring(n+1,u.length)}else{q=d(u.substring(0,n));r.setStyle(q);u=u.substring(n+1,o.length)}g(u,s);s.unshift(r)}function p(w,x){var v=0;while(x){switch(w.charAt(v)){case"{":x++;break;case"}":x--;break}v++}return(v-1)}}function e(l){if(!l){throw new Error("CSSParser.cascadeRules(). No css rules available for cascade")}if(!l.length){return l}var k=[],i={},j=[];l.forEach(function(m){if(m.cssRules){m.cssRules=e(m.cssRules)}if(!i[m.selectorText]){j.push(m.selectorText);i[m.selectorText]=m}else{i[m.selectorText]=h({},i[m.selectorText],m)}});j.forEach(function(m){k.push(i[m])},this);i=null;j=null;return k}function h(j){var i=Array.prototype.slice.call(arguments,1);i.forEach(function(l){for(var k in l){if(k==="parentRule"){return}if(typeof j[k]==="object"&&j[k]){if(typeof j[k].slice==="function"){j[k]=e(j[k].concat(l[k]))}else{j[k]=h({},j[k],l[k])}}else{j[k]=l[k]}}});return j}return{cssRules:[],parse:function(i){i=i.replace(/[\n\t]+/g,"").replace(/\/\*[\s\S]*?\*\//g,"").trim();g.call(this,i,this.cssRules)},parseCSSDeclaration:function(i){var j=[];g.call(this,i,j);if(j.length&&j.length===1){return j.pop()}else{return null}},clear:function(){this.cssRules=[]},cascade:function(i){if(!i||!i.length){this.cssRules=e.call(this,this.cssRules);return}return e.call(this,i)},doExtend:h}}c=c||window;c.CSSParser=a}(window);
/*
Copyright 2012 Adobe Systems Inc.;
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
window.CSSRegions=function(c){function w(){this.setup()}w.prototype={hasNativeSupport:false,prefixes:{css:"-adobe-",om:"adobe"},getPrefixedProperty:function(C){return this.prefixes.css.concat(C)},getPrefixedOMProperty:function(C){return this.prefixes.om.concat((C.charAt(0).toUpperCase()+C.slice(1)))},getPrefixedEvent:function(C){return this.prefixes.om.concat(C)},init:function(){var C=this;if(!window.StyleLoader){console.error("Missing StyleLoader.js");return}new StyleLoader(function(){return function(D){C.onStylesLoaded(D)}}())},setup:function(){this.namedFlows=[];this.namedFlowCollection=null},onStylesLoaded:function(H){if(!window.CSSParser){console.error("Missing CSSParser.js");return}var F,D,E,C,G=new CSSParser();this.setup();H.forEach(function(I){G.parse(I.cssText)});if(G.cssRules.length===0){console.log("There is no inline CSS for CSS Regions!");return}F=this.getNamedFlowRules(G.cssRules);for(D in F){E=F[D].contentNodesSelectors;C=F[D].regionsSelectors;this.namedFlows.push(new u(D,E,C))}this.namedFlowCollection=new z(this.namedFlows,"name");this.exposeGlobalOM();this.doLayout()},getNamedFlowRules:function(F){var H,J,I,C=F.length,L={},K=this.getPrefixedProperty("flow"),E=this.getPrefixedProperty("flow-into"),G=this.getPrefixedProperty("flow-from");for(var D=0;D<C;D++){H=F[D];for(J in H.style){if(J.indexOf(K)!==-1){I=H.style[J];L[I]=L[I]||{contentNodesSelectors:[],regionsSelectors:[]};if(J.indexOf(E)!==-1){L[I].contentNodesSelectors.push(H.selectorText)}if(J.indexOf(G)!==-1){L[I].regionsSelectors.push(H.selectorText)}break}}}return L},doLayout:function(){if(!this.namedFlows||!this.namedFlows.length){console.warn("No named flow / regions CSS rules");return}h++;if(h>1){return}while(h>0){o();h--}},exposeGlobalOM:function(){var D="getNamedFlows",C=this.getPrefixedOMProperty(D);document[D]=document[C]=this.getNamedFlows.bind(this)},getNamedFlows:function(){return this.namedFlowCollection},addSourceToNamedFlow:function(C,E){var D=this.getNamedFlows().namedItem(C);if(!D){D=new u(C);this.namedFlows.push(D);this.namedFlowCollection=new z(this.namedFlows,"name")}D.contentNodes.push(E);p[D.name]=false},addRegionToNamedFlow:function(C,E){var D=this.getNamedFlows().namedItem(C);if(!D){D=new u(C);this.namedFlows.push(D);this.namedFlowCollection=new z(this.namedFlows,"name")}D.regions.push(E);p[D.name]=false},NamedFlow:u,Collection:z};var h=0;var p={};var b=function(I){var H,F,C,E,G=[],D=I.length;for(H=0;H<D;H++){E=document.querySelectorAll(I[H]);for(F=0,C=E.length;F<C;++F){G.push(E[F])}}return e(document.body,NodeFilter.SHOW_ELEMENT,{acceptNode:function(J){if(G.indexOf(J)>=0){return NodeFilter.FILTER_ACCEPT}else{return NodeFilter.FILTER_SKIP}}})};var s=function(D){var E,C,F,G=[];for(E=0,C=D.length;E<C;E++){F=D[E].cloneNode(true);G.push(F);if(F.style.display==="none"){F.style.display=F["data-display"]||""}if(getComputedStyle(D[E]).display!=="none"){D[E]["data-display"]=D[E].style.display;D[E].style.display="none"}}return G};var f=function(H,E){var F,D,G,C=[];for(F=0,D=H.length;F<D;F++){G=H[F];if(getComputedStyle(G).display!=="none"){C.push(G);G["data-display"]=true;if(E.lastRegionWithContentIndex<F&&(G["data-w"]!==getComputedStyle(G).width||G["data-h"]!==getComputedStyle(G).height)){a([E.name])}}else{if(G["data-display"]){a([E.name]);delete (G["data-display"])}}}return C};var o=function(){var G,P,K,F,M,H,I,E,L,J,C=[],O=document.getNamedFlows();var D=t.getPrefixedOMProperty("regionOverset");for(K=0,F=O.length;K<F;K++){P=O[K];P.regionsByContent={content:[],regions:[]};P.firstEmptyRegionIndex=-1;I=f(P.getRegions(),P);P.overset=false;if(p[P.name]){L=I[P.lastRegionWithContentIndex].childNodes;for(M=0,H=L.length;M<H;++M){C.push(L[M])}M=P.lastRegionWithContentIndex}else{C=s(P.contentNodes);M=0}for(H=I.length;M<H;M++){G=I[M];G.innerHTML="";if(C.length===0){if(P.firstEmptyRegionIndex===-1){P.firstEmptyRegionIndex=M}G[D]="empty";continue}E=C.shift();if((M+1)===H){J=G.nextSibling||null;L=G.parentNode;L.removeChild(G);while(E){G.appendChild(E.cloneNode(true));d(E,-1,G,P);E=C.shift()}if(J){L.insertBefore(G,J);J=null}else{L.appendChild(G)}L=null;P.lastRegionWithContentIndex=M;if(n(G)){G[D]="overset";P.overset=true}}else{while(E){E=j(E,G,P);G["data-w"]=getComputedStyle(G).width;G["data-h"]=getComputedStyle(G).height;if(E){C.unshift(E);break}else{E=C.shift()}}G[D]="fit"}p[P.name]=true}if(P.regions.length>0){var N=t.getPrefixedEvent("regionlayoutupdate");P.fire({type:N,target:P})}}};var j=function(H,L,N){var E,G,D,J,I=-1,K=null,C=[],M=[],F=H;L.appendChild(F);if(n(L)){L.removeChild(F);C=e(F,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT,{acceptNode:function(O){if(O.nodeName.toLowerCase()==="img"||O.nodeName.toLowerCase()==="fig"||(O.nodeName.toLowerCase()==="#text"&&O.data.replace(/^\s+|\s+$/g,"")!=="")){return NodeFilter.FILTER_ACCEPT}else{return NodeFilter.FILTER_SKIP}}});if(C.length===1&&(C[0].nodeName.toLowerCase()==="img"||C[0].nodeName.toLowerCase()==="fig")){K=H}else{y(C);I=q(L,F,C,M);if(I<0){K=H}else{E=C[I];if(E.nodeName==="#text"){J=M[I].replace(/^\s+|\s+$/g,"");D=J.split(" ");G=i(L,F,E,D);M[I]=A(D,G,D.length-1)}L.appendChild(B(F.cloneNode(true)));d(L.lastChild,L,N);k(I,C,M,F);K=F}}}else{d(F,L,N)}return K};var y=function(D){var G,C,E,H,F;for(G=0,C=D.length;G<C;G++){F=D[G];if(F.nodeName==="#text"){continue}E=0;H=F;while((H=H.previousSibling)!==null){E++}F["data-index"]=E}};var q=function(M,F,D,N){var E,K,H,G,L=D.length,I=D.length,C=0,J=D.length-1;while(J>=C){H=C+Math.round((J-C)/2);for(L=H;L<I;L++){E=D[L];if(E.nodeName==="#text"){if(E.data!==""){N[L]=E.data;E.data=""}else{break}}else{if(E.parentNode){N[L]=E.parentNode;E.parentNode.removeChild(E)}else{break}}}M.appendChild(F);if(n(M)){J=H-1;if(J<C){C=J}}else{C=H+1;if(J>=C){G=C+Math.round((J-C)/2)+1;for(K=H;K<G;K++){E=D[K];if(E.nodeName==="#text"){E.data=N[K]}else{N[K].insertBefore(E,N[K].childNodes.item(E["data-index"]))}delete (N[K])}}}M.removeChild(F)}return H};var B=function(E){var D,C,F;C=e(E,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT,{acceptNode:function(G){if(G.nodeName.toLowerCase()==="img"||G.nodeName.toLowerCase()==="fig"||(G.nodeName.toLowerCase()==="#text"&&G.data.replace(/^\s+|\s+$/g,"")!=="")){return NodeFilter.FILTER_ACCEPT}else{return NodeFilter.FILTER_SKIP}}});F=C[C.length-1];D=F.nextSibling;while(D){m(D);D=D.nextSibling}D=F.parentNode.nextSibling;while(D){m(D);D=D.nextSibling}D=F.parentNode;while(D){if(D.parentNode===E){while(D.nextSibling){D.parentNode.removeChild(D.nextSibling)}break}D=D.parentNode}return E};var m=function(F){var C,E,D;if(F.nodeName==="#text"){F.parentNode.removeChild(F);return}C=F.childNodes;for(E=C.length-1;E>=0;E--){D=C.item(E);if(D.nodeName!=="#text"){if(D.childNodes.length===0){D.parentNode.removeChild(D)}else{m(D)}}else{D.parentNode.removeChild(D)}}if(F.childNodes.length===0){F.parentNode.removeChild(F)}};var d=function(F,J,K){var H,E,I,D,G,C;C=e(F,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT,{acceptNode:function(L){if(L.nodeName.toLowerCase()==="img"||L.nodeName.toLowerCase()==="fig"||(L.nodeName.toLowerCase()==="#text"&&L.data.replace(/^\s+|\s+$/g,"")!=="")){return NodeFilter.FILTER_ACCEPT}else{return NodeFilter.FILTER_SKIP}}});if(!K.regionsByContent){K.regionsByContent={content:[],regions:[]}}for(H=0,E=C.length;H<E;H++){D=C[H];if(D.nodeName.toLowerCase()==="#text"){D=D.parentNode}G=K.regionsByContent.content.indexOf(D);if(G===-1){K.regionsByContent.content.push(D);G=K.regionsByContent.content.length-1}I=K.regionsByContent.regions[G]||[];I.push(J);K.regionsByContent.regions[G]=I}};var i=function(I,G,F,H){var D=0,E=0,C=H.length-1;while(C>=E){D=E+Math.round((C-E)/2);F.data=A(H,0,D-1);I.appendChild(G);if(n(I)){C=D-1;if(C<E){E=C}}else{E=D+1}I.removeChild(G)}return D};var k=function(H,C,K,E){var D,I,G,F,J=[];for(I=H,G=C.length;I<G;I++){D=C[I];if(D.nodeName==="#text"){D.data=K[I]}else{K[I].insertBefore(D,K[I].childNodes.item(D["data-index"]))}}for(I=0;I<H;I++){D=C[I];if(D.nodeName==="#text"){F=D.parentNode;F.removeChild(D);while(F&&F.childNodes.length===0){F=F.parentNode;F.removeChild(F.childNodes.item(0))}if(F){J.push(F)}}else{J.push(D.parentNode);D.parentNode.removeChild(D)}}for(I=0,G=J.length;I<G;I++){F=J[I];while(F&&F.childNodes.length===0){F=F.parentNode;if(F){F.removeChild(F.childNodes.item(0))}}}F=C[H].parentNode;while(F){if(F.parentNode===E){while(F.previousSibling){F.parentNode.removeChild(F.previousSibling)}break}F=F.parentNode}};var e=function(C,G,H){var F,E,D=[];F=document.createNodeIterator(C,G,H,false);while(E=F.nextNode()){D.push(E)}return D};var A=function(C,E,D){return C.slice(E,D+1).join(" ")+" "};var n=function(D){var E,C=D.style.overflow;if(!C||C==="visible"){D.style.overflow="hidden"}E=D.clientHeight<(D.scrollHeight-1);D.style.overflow=C;return E};var a=function(D){var E,C,F;if(D&&D.length){D.forEach(function(G){p[G]=false})}else{F=document.getNamedFlows();for(E=0,C=F.length;E<C;E++){p[F[E].name]=false}}};function v(){}v.prototype={constructor:v,addEventListener:function(C,D){if(!this._listeners[C]){this._listeners[C]=[]}this._listeners[C].push(D);t.doLayout()},fire:function(F){var E,D,C;if(this._listeners[F.type] instanceof Array){E=this._listeners[F.type];for(D=0,C=E.length;D<C;D++){E[D].call(this,F)}}},removeEventListener:function(F,G){var E,D,C;if(this._listeners[F] instanceof Array){E=this._listeners[F];for(D=0,C=E.length;D<C;D++){if(E[D]===G){E.splice(D,1);break}}}}};function z(C,F){var E,D;if(typeof C.pop!="function"){throw"Invalid input. Expected an array, got: "+typeof C}this.map={};this.length=0;for(E=0,D=C.length;E<D;E++){this[E]=C[E];this.length++;if(F&&C[E][F]){this.map[C[E][F]]=this[E]}}}z.prototype={item:function(C){return this[C]||null},namedItem:function(C){return this.map[C]||null}};function u(D,E,C){this.name=D||"none";this.overset=true;this.contentNodes=[];this.regions=[];this.regionsByContent={};this._listeners={};this.firstEmptyRegionIndex=-1;this.lastRegionWithContentIndex=-1;if(E&&E.length){this.contentNodes=b(E)}if(C&&C.length){this.regions=b(C)}}u.prototype=new v();u.prototype.constructor=u;u.prototype.getRegions=function(){return this.regions};u.prototype.getRegionsByContent=function(E){var C,D=[];C=this.regionsByContent.content.indexOf(E);if(C!==-1){D=this.regionsByContent.regions[C]}return D};var r=(function(){var D=" -webkit- -moz- -o- -ms- ";function C(G,F){var E=F.join(G+" ").split(" ");return E.slice(0,E.length-1)}return{cssProperty:function(J,I){var I=I||document.body;var F=D.split(" ");var H=C(J,F);for(var G=0,E=H.length;G<E;G++){if(I.style[H[G]]!==undefined){this.supportedProperty=H[G];return true}}return false},omProperty:function(K,J){var J=J||document;var F=D.replace(/-/g,"").split(" ");F=F.slice(1,F.length);var G=K.charAt(0).toUpperCase()+K.slice(1);var I=C(G,F);I=I.slice(0,I.length-1);I.unshift(K);for(var H=0,E=I.length;H<E;H++){if(I[H] in J){this.supportedProperty=I[H];return true}}return false},getSupportedProperty:function(G,E,I){var I=!!I;var H=function(){};var F=new H;F.supportedProperty=G;if(I){r.omProperty.call(F,G,E)}else{r.cssProperty.call(F,G,E)}return F.supportedProperty}}})();function x(){var C,H=document.createElement("span"),E=false,G=r.getSupportedProperty("flow-into"),D=r.getSupportedProperty("getNamedFlows",document,true);H.id="test-regions-support";H.style[G]="testflow";document.body.appendChild(H);try{C=document[D].call(document)["testflow"];E=(typeof C.overset!=="undefined")}catch(F){}finally{H.style[G]="none";H.parentNode.removeChild(H);C=null;return !!E}}if(typeof c.addEventListener==="undefined"){c.addEventListener=function(C,D){c.attachEvent("on"+C,D)}}var g,t=new w,l=document.documentElement;c.addEventListener("load",function(){if(r.cssProperty("flow-into")&&r.omProperty("getNamedFlows")&&x()){t.hasNativeSupport=true;l.className+=" regions";return}t.init();l.className+=" no-regions";c.addEventListener("resize",function(){window.clearTimeout(g);g=window.setTimeout(function(){a();t.doLayout()},300)})});return t}(window);var disableWriting=false;function placeCursorInOrder(d,e,h,g){if(d){var c=nextNodeSearch(e);if(c!="lastLine"){e=c}}var b=false;var a=$(e)[0].previousSibling;var f=KolabInReal.authorOrder.indexOf(h);while(!b){if(!a){if($(e).is("div.cursor")||$(e).is("div.selAnchor")){var i=$(e).attr("id");if(KolabInReal.authorOrder.indexOf(i)<f){$(e).after('<div class="'+g+'" id="'+h+'"></div>')}else{$(e).before('<div class="'+g+'" id="'+h+'"></div>')}}else{$(e).before('<div class="'+g+'" id="'+h+'"></div>')}b=true;break}else{if($(a).is("div.cursor")||$(a).is("div.selAnchor")){var i=$(a).attr("id");if(KolabInReal.authorOrder.indexOf(i)<f){$(a).after('<div class="'+g+'" id="'+h+'"></div>');b=true;break}else{e=a;a=$(e)[0].previousSibling}}else{if(a.nodeType==3){$(e).before('<div class="'+g+'" id="'+h+'"></div>');b=true;break}}}}}function evaluateCursorPosInText(e,b){var h=0;var g=$doc("div."+b+"#"+e).parents("p.paragraphContainer");var a=$(g).children("span[author]");for(var d=0;d<a.length;d++){if($(a[d]).is($doc("div."+b+"#"+e).parents("span[author]"))){var c=$(a[d])[0].childNodes;for(var d=0;d<c.length;d++){if($(c[d]).is($doc("div."+b+"#"+e))){break}else{if(c[d].nodeType==3){h+=$(c[d]).text().length}}}break}else{h+=$(a[d]).text().length}}var f=g.attr("klb");if($klb(f).length>1){$klb(f).each(function(){if(!$(this).is(g)){h+=$(this).text().length}else{return false}})}return h}function addUserCursorManagement(a){if(!$("iframe#r_engine").contents().children("html").children("head").children("style#cursorheight"+a).length){$("iframe#r_engine").contents().children("html").children("head").append('<style id="cursorheight'+a+'"></style>');$("iframe#r_engine").contents().children("html").children("head").append('<style id="anchorheight'+a+'"></style>')}}function removeUserCursorManagement(a){$("iframe#r_engine").contents().children("html").children("head").children("style#cursorheight"+a).remove();$("iframe#r_engine").contents().children("html").children("head").children("style#anchorheight"+a).remove()}function updateUserCursorManagement(d,b,e,a,c){var f=$doc("div."+b+"#"+d).position().top;$("iframe#r_engine").contents().children("html").children("head").children("style#"+e+d).html("div."+b+'[id="'+d+'"]:before{ background-color:'+c+"; height: "+a+"px; top: "+f+"; } div."+b+'[id="'+d+'"]{ height: '+a+"px; }")}function lineHeightAdjustment(b){var a=$(b).css("line-height");if(a=="normal"){return 3}else{a=parseInt(a);if(a==24){return 5}else{if(a==32){return 10}else{if(a==40){return 15}}}}}function cursorManagement(c,b){var d=0;var a=lineHeightAdjustment($doc("div.cursor#"+c).parents("p.paragraphContainer"));d=verifyCursorHeight(c,"cursor")+a;updateUserCursorManagement(c,"cursor","cursorheight",d,b);if($doc("div.selAnchor#"+c).length){var d=0;a=lineHeightAdjustment($doc("div.cursor#"+c).parents("p.paragraphContainer"));d=verifyCursorHeight(c,"selAnchor")+a;updateUserCursorManagement(c,"selAnchor","anchorheight",d,b)}}function verifyCursorHeight(c,d){var b=$doc("div."+d+"#"+c).parents("p.paragraphContainer");var a=0;var e=$doc("div."+d+"#"+c).position().top;b.children().each(function(){if($(this).position().top<=e&&$(this).position().top+$(this).height()>e){var f=parseInt($(this).css("font-size"));if(f>a){a=f}}else{return a}});return a}var Cursor=(function(){function a(){$("span#klb").html(cursor.klbStart);$("span#pos").html(cursor.absoluteStart)}function b(d,c){cursorManagement(d,c);setSelectionBox(d,c)}return{showState:a,setCursor:b}})();(function(){function a(){this.Diff_Timeout=1;this.Diff_EditCost=4;this.Match_Threshold=0.5;this.Match_Distance=1000;this.Patch_DeleteThreshold=0.5;this.Patch_Margin=4;this.Match_MaxBits=32}a.prototype.diff_main=function(i,h,n,m){"undefined"==typeof m&&(m=0>=this.Diff_Timeout?Number.MAX_VALUE:(new Date).getTime()+1000*this.Diff_Timeout);if(null==i||null==h){throw Error("Null input. (diff_main)")}if(i==h){return i?[[0,i]]:[]}"undefined"==typeof n&&(n=!0);var l=n,k=this.diff_commonPrefix(i,h),n=i.substring(0,k),i=i.substring(k),h=h.substring(k),k=this.diff_commonSuffix(i,h),j=i.substring(i.length-k),i=i.substring(0,i.length-k),h=h.substring(0,h.length-k),i=this.diff_compute_(i,h,l,m);n&&i.unshift([0,n]);j&&i.push([0,j]);this.diff_cleanupMerge(i);return i};a.prototype.diff_compute_=function(i,h,n,m){if(!i){return[[1,h]]}if(!h){return[[-1,i]]}var l=i.length>h.length?i:h,k=i.length>h.length?h:i,j=l.indexOf(k);if(-1!=j){return n=[[1,l.substring(0,j)],[0,k],[1,l.substring(j+k.length)]],i.length>h.length&&(n[0][0]=n[2][0]=-1),n}if(1==k.length){return[[-1,i],[1,h]]}return(l=this.diff_halfMatch_(i,h))?(k=l[0],i=l[1],j=l[2],h=l[3],l=l[4],k=this.diff_main(k,j,n,m),n=this.diff_main(i,h,n,m),k.concat([[0,l]],n)):n&&100<i.length&&100<h.length?this.diff_lineMode_(i,h,m):this.diff_bisect_(i,h,m)};a.prototype.diff_lineMode_=function(i,h,n){var m=this.diff_linesToChars_(i,h),i=m.chars1,h=m.chars2,m=m.lineArray,i=this.diff_main(i,h,!1,n);this.diff_charsToLines_(i,m);this.diff_cleanupSemantic(i);i.push([0,""]);for(var l=m=h=0,k="",j="";h<i.length;){switch(i[h][0]){case 1:l++;j+=i[h][1];break;case -1:m++;k+=i[h][1];break;case 0:if(1<=m&&1<=l){i.splice(h-m-l,m+l);h=h-m-l;m=this.diff_main(k,j,!1,n);for(l=m.length-1;0<=l;l--){i.splice(h,0,m[l])}h+=m.length}m=l=0;j=k=""}h++}i.pop();return i};a.prototype.diff_bisect_=function(R,Q,P){for(var O=R.length,N=Q.length,M=Math.ceil((O+N)/2),L=M,K=2*M,I=Array(K),J=Array(K),H=0;H<K;H++){I[H]=-1,J[H]=-1}I[L+1]=0;J[L+1]=0;for(var H=O-N,C=0!=H%2,B=0,z=0,D=0,w=0,x=0;x<M&&!((new Date).getTime()>P);x++){for(var E=-x+B;E<=x-z;E+=2){var G=L+E,F;F=E==-x||E!=x&&I[G-1]<I[G+1]?I[G+1]:I[G-1]+1;for(var A=F-E;F<O&&A<N&&R.charAt(F)==Q.charAt(A);){F++,A++}I[G]=F;if(F>O){z+=2}else{if(A>N){B+=2}else{if(C&&(G=L+H-E,0<=G&&G<K&&-1!=J[G])){var y=O-J[G];if(F>=y){return this.diff_bisectSplit_(R,Q,F,A,P)}}}}}for(E=-x+D;E<=x-w;E+=2){G=L+E;y=E==-x||E!=x&&J[G-1]<J[G+1]?J[G+1]:J[G-1]+1;for(F=y-E;y<O&&F<N&&R.charAt(O-y-1)==Q.charAt(N-F-1);){y++,F++}J[G]=y;if(y>O){w+=2}else{if(F>N){D+=2}else{if(!C&&(G=L+H-E,0<=G&&G<K&&-1!=I[G]&&(F=I[G],A=L+F-G,y=O-y,F>=y))){return this.diff_bisectSplit_(R,Q,F,A,P)}}}}}return[[-1,R],[1,Q]]};a.prototype.diff_bisectSplit_=function(i,h,n,m,l){var k=i.substring(0,n),j=h.substring(0,m),i=i.substring(n),h=h.substring(m),k=this.diff_main(k,j,!1,l),l=this.diff_main(i,h,!1,l);return k.concat(l)};a.prototype.diff_linesToChars_=function(i,h){function n(e){for(var d="",s=0,r=-1,o=m.length;r<e.length-1;){r=e.indexOf("\n",s);-1==r&&(r=e.length-1);var p=e.substring(s,r+1),s=r+1;(l.hasOwnProperty?l.hasOwnProperty(p):void 0!==l[p])?d+=String.fromCharCode(l[p]):(d+=String.fromCharCode(o),l[p]=o,m[o++]=p)}return d}var m=[],l={};m[0]="";var k=n(i),j=n(h);return{chars1:k,chars2:j,lineArray:m}};a.prototype.diff_charsToLines_=function(h,g){for(var l=0;l<h.length;l++){for(var k=h[l][1],j=[],i=0;i<k.length;i++){j[i]=g[k.charCodeAt(i)]}h[l][1]=j.join("")}};a.prototype.diff_commonPrefix=function(h,g){if(!h||!g||h.charAt(0)!=g.charAt(0)){return 0}for(var l=0,k=Math.min(h.length,g.length),j=k,i=0;l<j;){h.substring(i,j)==g.substring(i,j)?i=l=j:k=j,j=Math.floor((k-l)/2+l)}return j};a.prototype.diff_commonSuffix=function(h,g){if(!h||!g||h.charAt(h.length-1)!=g.charAt(g.length-1)){return 0}for(var l=0,k=Math.min(h.length,g.length),j=k,i=0;l<j;){h.substring(h.length-j,h.length-i)==g.substring(g.length-j,g.length-i)?i=l=j:k=j,j=Math.floor((k-l)/2+l)}return j};a.prototype.diff_commonOverlap_=function(h,g){var l=h.length,k=g.length;if(0==l||0==k){return 0}l>k?h=h.substring(l-k):l<k&&(g=g.substring(0,l));l=Math.min(l,k);if(h==g){return l}for(var k=0,j=1;;){var i=h.substring(l-j),i=g.indexOf(i);if(-1==i){return k}j+=i;if(0==i||h.substring(l-j)==g.substring(0,j)){k=j,j++}}};a.prototype.diff_halfMatch_=function(r,q){function p(C,B,A){for(var z=C.substring(A,A+Math.floor(C.length/4)),y=-1,x="",w,v,s,u;-1!=(y=B.indexOf(z,y+1));){var t=m.diff_commonPrefix(C.substring(A),B.substring(y)),f=m.diff_commonSuffix(C.substring(0,A),B.substring(0,y));x.length<f+t&&(x=B.substring(y-f,y)+B.substring(y,y+t),w=C.substring(0,A-f),v=C.substring(A+t),s=B.substring(0,y-f),u=B.substring(y+t))}return 2*x.length>=C.length?[w,v,s,u,x]:null}if(0>=this.Diff_Timeout){return null}var o=r.length>q.length?r:q,n=r.length>q.length?q:r;if(4>o.length||2*n.length<o.length){return null}var m=this,l=p(o,n,Math.ceil(o.length/4)),o=p(o,n,Math.ceil(o.length/2)),k;if(!l&&!o){return null}k=o?l?l[4].length>o[4].length?l:o:o:l;var i;r.length>q.length?(l=k[0],o=k[1],n=k[2],i=k[3]):(n=k[0],i=k[1],l=k[2],o=k[3]);k=k[4];return[l,o,n,i,k]};a.prototype.diff_cleanupSemantic=function(t){for(var s=!1,r=[],q=0,p=null,o=0,n=0,m=0,k=0,l=0;o<t.length;){0==t[o][0]?(r[q++]=o,n=k,m=l,l=k=0,p=t[o][1]):(1==t[o][0]?k+=t[o][1].length:l+=t[o][1].length,p&&p.length<=Math.max(n,m)&&p.length<=Math.max(k,l)&&(t.splice(r[q-1],0,[-1,p]),t[r[q-1]+1][0]=1,q--,q--,o=0<q?r[q-1]:-1,l=k=m=n=0,p=null,s=!0)),o++}s&&this.diff_cleanupMerge(t);this.diff_cleanupSemanticLossless(t);for(o=1;o<t.length;){if(-1==t[o-1][0]&&1==t[o][0]){s=t[o-1][1];r=t[o][1];q=this.diff_commonOverlap_(s,r);p=this.diff_commonOverlap_(r,s);if(q>=p){if(q>=s.length/2||q>=r.length/2){t.splice(o,0,[0,r.substring(0,q)]),t[o-1][1]=s.substring(0,s.length-q),t[o+1][1]=r.substring(q),o++}}else{if(p>=s.length/2||p>=r.length/2){t.splice(o,0,[0,s.substring(0,p)]),t[o-1][0]=1,t[o-1][1]=r.substring(0,r.length-p),t[o+1][0]=-1,t[o+1][1]=s.substring(p),o++}}o++}o++}};a.prototype.diff_cleanupSemanticLossless=function(v){function u(E,D){if(!E||!D){return 6}var C=E.charAt(E.length-1),B=D.charAt(0),A=C.match(a.nonAlphaNumericRegex_),z=B.match(a.nonAlphaNumericRegex_),y=A&&C.match(a.whitespaceRegex_),x=z&&B.match(a.whitespaceRegex_),C=y&&C.match(a.linebreakRegex_),B=x&&B.match(a.linebreakRegex_),w=C&&E.match(a.blanklineEndRegex_),k=B&&D.match(a.blanklineStartRegex_);return w||k?5:C||B?4:A&&!y&&x?3:y||x?2:A||z?1:0}for(var t=1;t<v.length-1;){if(0==v[t-1][0]&&0==v[t+1][0]){var s=v[t-1][1],r=v[t][1],q=v[t+1][1],p=this.diff_commonSuffix(s,r);if(p){var o=r.substring(r.length-p),s=s.substring(0,s.length-p),r=o+r.substring(0,r.length-p),q=o+q}for(var p=s,o=r,m=q,n=u(s,r)+u(r,q);r.charAt(0)===q.charAt(0);){var s=s+r.charAt(0),r=r.substring(1)+q.charAt(0),q=q.substring(1),l=u(s,r)+u(r,q);l>=n&&(n=l,p=s,o=r,m=q)}v[t-1][1]!=p&&(p?v[t-1][1]=p:(v.splice(t-1,1),t--),v[t][1]=o,m?v[t+1][1]=m:(v.splice(t+1,1),t--))}t++}};a.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/;a.whitespaceRegex_=/\s/;a.linebreakRegex_=/[\r\n]/;a.blanklineEndRegex_=/\n\r?\n$/;a.blanklineStartRegex_=/^\r?\n\r?\n/;a.prototype.diff_cleanupEfficiency=function(t){for(var s=!1,r=[],q=0,p=null,o=0,n=!1,m=!1,k=!1,l=!1;o<t.length;){if(0==t[o][0]){t[o][1].length<this.Diff_EditCost&&(k||l)?(r[q++]=o,n=k,m=l,p=t[o][1]):(q=0,p=null),k=l=!1}else{if(-1==t[o][0]?l=!0:k=!0,p&&(n&&m&&k&&l||p.length<this.Diff_EditCost/2&&3==n+m+k+l)){t.splice(r[q-1],0,[-1,p]),t[r[q-1]+1][0]=1,q--,p=null,n&&m?(k=l=!0,q=0):(q--,o=0<q?r[q-1]:-1,k=l=!1),s=!0}}o++}s&&this.diff_cleanupMerge(t)};a.prototype.diff_cleanupMerge=function(i){i.push([0,""]);for(var h=0,n=0,m=0,l="",k="",j;h<i.length;){switch(i[h][0]){case 1:m++;k+=i[h][1];h++;break;case -1:n++;l+=i[h][1];h++;break;case 0:1<n+m?(0!==n&&0!==m&&(j=this.diff_commonPrefix(k,l),0!==j&&(0<h-n-m&&0==i[h-n-m-1][0]?i[h-n-m-1][1]+=k.substring(0,j):(i.splice(0,0,[0,k.substring(0,j)]),h++),k=k.substring(j),l=l.substring(j)),j=this.diff_commonSuffix(k,l),0!==j&&(i[h][1]=k.substring(k.length-j)+i[h][1],k=k.substring(0,k.length-j),l=l.substring(0,l.length-j))),0===n?i.splice(h-m,n+m,[1,k]):0===m?i.splice(h-n,n+m,[-1,l]):i.splice(h-n-m,n+m,[-1,l],[1,k]),h=h-n-m+(n?1:0)+(m?1:0)+1):0!==h&&0==i[h-1][0]?(i[h-1][1]+=i[h][1],i.splice(h,1)):h++,n=m=0,k=l=""}}""===i[i.length-1][1]&&i.pop();n=!1;for(h=1;h<i.length-1;){0==i[h-1][0]&&0==i[h+1][0]&&(i[h][1].substring(i[h][1].length-i[h-1][1].length)==i[h-1][1]?(i[h][1]=i[h-1][1]+i[h][1].substring(0,i[h][1].length-i[h-1][1].length),i[h+1][1]=i[h-1][1]+i[h+1][1],i.splice(h-1,1),n=!0):i[h][1].substring(0,i[h+1][1].length)==i[h+1][1]&&(i[h-1][1]+=i[h+1][1],i[h][1]=i[h][1].substring(i[h+1][1].length)+i[h+1][1],i.splice(h+1,1),n=!0)),h++}n&&this.diff_cleanupMerge(i)};a.prototype.diff_xIndex=function(i,h){var n=0,m=0,l=0,k=0,j;for(j=0;j<i.length;j++){1!==i[j][0]&&(n+=i[j][1].length);-1!==i[j][0]&&(m+=i[j][1].length);if(n>h){break}l=n;k=m}return i.length!=j&&-1===i[j][0]?k:k+(h-l)};a.prototype.diff_prettyHtml=function(r){for(var q=[],p=/&/g,o=/</g,n=/>/g,m=/\n/g,l=0;l<r.length;l++){var k=r[l][0],i=r[l][1],i=i.replace(p,"&amp;").replace(o,"&lt;").replace(n,"&gt;").replace(m,"&para;<br>");switch(k){case 1:q[l]='<ins style="background:#e6ffe6;">'+i+"</ins>";break;case -1:q[l]='<del style="background:#ffe6e6;">'+i+"</del>";break;case 0:q[l]="<span>"+i+"</span>"}}return q.join("")};a.prototype.diff_text1=function(e){for(var d=[],f=0;f<e.length;f++){1!==e[f][0]&&(d[f]=e[f][1])}return d.join("")};a.prototype.diff_text2=function(e){for(var d=[],f=0;f<e.length;f++){-1!==e[f][0]&&(d[f]=e[f][1])}return d.join("")};a.prototype.diff_levenshtein=function(i){for(var h=0,n=0,m=0,l=0;l<i.length;l++){var k=i[l][0],j=i[l][1];switch(k){case 1:n+=j.length;break;case -1:m+=j.length;break;case 0:h+=Math.max(n,m),m=n=0}}return h+=Math.max(n,m)};a.prototype.diff_toDelta=function(e){for(var d=[],f=0;f<e.length;f++){switch(e[f][0]){case 1:d[f]="+"+encodeURI(e[f][1]);break;case -1:d[f]="-"+e[f][1].length;break;case 0:d[f]="="+e[f][1].length}}return d.join("\t").replace(/%20/g," ")};a.prototype.diff_fromDelta=function(t,s){for(var r=[],q=0,p=0,o=s.split(/\t/g),n=0;n<o.length;n++){var m=o[n].substring(1);switch(o[n].charAt(0)){case"+":try{r[q++]=[1,decodeURI(m)]}catch(k){throw Error("Illegal escape in diff_fromDelta: "+m)}break;case"-":case"=":var l=parseInt(m,10);if(isNaN(l)||0>l){throw Error("Invalid number in diff_fromDelta: "+m)}m=t.substring(p,p+=l);"="==o[n].charAt(0)?r[q++]=[0,m]:r[q++]=[-1,m];break;default:if(o[n]){throw Error("Invalid diff operation in diff_fromDelta: "+o[n])}}}if(p!=t.length){throw Error("Delta length ("+p+") does not equal source text length ("+t.length+").")}return r};a.prototype.match_main=function(e,d,f){if(null==e||null==d||null==f){throw Error("Null input. (match_main)")}f=Math.max(0,Math.min(f,e.length));return e==d?0:e.length?e.substring(f,f+d.length)==d?f:this.match_bitap_(e,d,f):-1};a.prototype.match_bitap_=function(D,C,B){function A(b,h){var f=b/C.length,c=Math.abs(B-h);return !y.Match_Distance?c?1:f:f+c/y.Match_Distance}if(C.length>this.Match_MaxBits){throw Error("Pattern too long for this browser.")}var z=this.match_alphabet_(C),y=this,x=this.Match_Threshold,w=D.indexOf(C,B);-1!=w&&(x=Math.min(A(0,w),x),w=D.lastIndexOf(C,B+C.length),-1!=w&&(x=Math.min(A(0,w),x)));for(var t=1<<C.length-1,w=-1,u,r,m=C.length+D.length,l,F=0;F<C.length;F++){u=0;for(r=m;u<r;){A(F,B+r)<=x?u=r:m=r,r=Math.floor((m-u)/2+u)}m=r;u=Math.max(1,B-r+1);var n=Math.min(B+r,D.length)+C.length;r=Array(n+2);for(r[n+1]=(1<<F)-1;n>=u;n--){var E=z[D.charAt(n-1)];r[n]=0===F?(r[n+1]<<1|1)&E:(r[n+1]<<1|1)&E|(l[n+1]|l[n])<<1|1|l[n+1];if(r[n]&t&&(E=A(F,n-1),E<=x)){if(x=E,w=n-1,w>B){u=Math.max(1,2*B-w)}else{break}}}if(A(F+1,B)>x){break}l=r}return w};a.prototype.match_alphabet_=function(e){for(var d={},f=0;f<e.length;f++){d[e.charAt(f)]=0}for(f=0;f<e.length;f++){d[e.charAt(f)]|=1<<e.length-f-1}return d};a.prototype.patch_addContext_=function(f,e){if(0!=e.length){for(var h=e.substring(f.start2,f.start2+f.length1),g=0;e.indexOf(h)!=e.lastIndexOf(h)&&h.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin;){g+=this.Patch_Margin,h=e.substring(f.start2-g,f.start2+f.length1+g)}g+=this.Patch_Margin;(h=e.substring(f.start2-g,f.start2))&&f.diffs.unshift([0,h]);(g=e.substring(f.start2+f.length1,f.start2+f.length1+g))&&f.diffs.push([0,g]);f.start1-=h.length;f.start2-=h.length;f.length1+=h.length+g.length;f.length2+=h.length+g.length}};a.prototype.patch_make=function(v,u,t){var s;if("string"==typeof v&&"string"==typeof u&&"undefined"==typeof t){s=v,u=this.diff_main(s,u,!0),2<u.length&&(this.diff_cleanupSemantic(u),this.diff_cleanupEfficiency(u))}else{if(v&&"object"==typeof v&&"undefined"==typeof u&&"undefined"==typeof t){u=v,s=this.diff_text1(u)}else{if("string"==typeof v&&u&&"object"==typeof u&&"undefined"==typeof t){s=v}else{if("string"==typeof v&&"string"==typeof u&&t&&"object"==typeof t){s=v,u=t}else{throw Error("Unknown call format to patch_make.")}}}}if(0===u.length){return[]}for(var t=[],v=new a.patch_obj,r=0,q=0,p=0,o=s,m=0;m<u.length;m++){var n=u[m][0],l=u[m][1];if(!r&&0!==n){v.start1=q,v.start2=p}switch(n){case 1:v.diffs[r++]=u[m];v.length2+=l.length;s=s.substring(0,p)+l+s.substring(p);break;case -1:v.length1+=l.length;v.diffs[r++]=u[m];s=s.substring(0,p)+s.substring(p+l.length);break;case 0:l.length<=2*this.Patch_Margin&&r&&u.length!=m+1?(v.diffs[r++]=u[m],v.length1+=l.length,v.length2+=l.length):l.length>=2*this.Patch_Margin&&r&&(this.patch_addContext_(v,o),t.push(v),v=new a.patch_obj,r=0,o=s,q=p)}1!==n&&(q+=l.length);-1!==n&&(p+=l.length)}r&&(this.patch_addContext_(v,o),t.push(v));return t};a.prototype.patch_deepCopy=function(h){for(var g=[],l=0;l<h.length;l++){var k=h[l],j=new a.patch_obj;j.diffs=[];for(var i=0;i<k.diffs.length;i++){j.diffs[i]=k.diffs[i].slice()}j.start1=k.start1;j.start2=k.start2;j.length1=k.length1;j.length2=k.length2;g[l]=j}return g};a.prototype.patch_apply=function(x,w){if(0==x.length){return[w,[]]}var x=this.patch_deepCopy(x),v=this.patch_addPadding(x),w=v+w+v;this.patch_splitMax(x);for(var u=0,t=[],s=0;s<x.length;s++){var r=x[s].start2+u,q=this.diff_text1(x[s].diffs),n,o=-1;if(q.length>this.Match_MaxBits){if(n=this.match_main(w,q.substring(0,this.Match_MaxBits),r),-1!=n&&(o=this.match_main(w,q.substring(q.length-this.Match_MaxBits),r+q.length-this.Match_MaxBits),-1==o||n>=o)){n=-1}}else{n=this.match_main(w,q,r)}if(-1==n){t[s]=!1,u-=x[s].length2-x[s].length1}else{if(t[s]=!0,u=n-r,r=-1==o?w.substring(n,n+q.length):w.substring(n,o+this.Match_MaxBits),q==r){w=w.substring(0,n)+this.diff_text2(x[s].diffs)+w.substring(n+q.length)}else{if(r=this.diff_main(q,r,!1),q.length>this.Match_MaxBits&&this.diff_levenshtein(r)/q.length>this.Patch_DeleteThreshold){t[s]=!1}else{this.diff_cleanupSemanticLossless(r);for(var q=0,m,o=0;o<x[s].diffs.length;o++){var l=x[s].diffs[o];0!==l[0]&&(m=this.diff_xIndex(r,q));1===l[0]?w=w.substring(0,n+m)+l[1]+w.substring(n+m):-1===l[0]&&(w=w.substring(0,n+m)+w.substring(n+this.diff_xIndex(r,q+l[1].length)));-1!==l[0]&&(q+=l[1].length)}}}}}w=w.substring(v.length,w.length-v.length);return[w,t]};a.prototype.patch_addPadding=function(h){for(var g=this.Patch_Margin,l="",k=1;k<=g;k++){l+=String.fromCharCode(k)}for(k=0;k<h.length;k++){h[k].start1+=g,h[k].start2+=g}var k=h[0],j=k.diffs;if(0==j.length||0!=j[0][0]){j.unshift([0,l]),k.start1-=g,k.start2-=g,k.length1+=g,k.length2+=g}else{if(g>j[0][1].length){var i=g-j[0][1].length;j[0][1]=l.substring(j[0][1].length)+j[0][1];k.start1-=i;k.start2-=i;k.length1+=i;k.length2+=i}}k=h[h.length-1];j=k.diffs;0==j.length||0!=j[j.length-1][0]?(j.push([0,l]),k.length1+=g,k.length2+=g):g>j[j.length-1][1].length&&(i=g-j[j.length-1][1].length,j[j.length-1][1]+=l.substring(0,i),k.length1+=i,k.length2+=i);return l};a.prototype.patch_splitMax=function(t){for(var s=this.Match_MaxBits,r=0;r<t.length;r++){if(!(t[r].length1<=s)){var q=t[r];t.splice(r--,1);for(var p=q.start1,o=q.start2,n="";0!==q.diffs.length;){var m=new a.patch_obj,k=!0;m.start1=p-n.length;m.start2=o-n.length;if(""!==n){m.length1=m.length2=n.length,m.diffs.push([0,n])}for(;0!==q.diffs.length&&m.length1<s-this.Patch_Margin;){var n=q.diffs[0][0],l=q.diffs[0][1];1===n?(m.length2+=l.length,o+=l.length,m.diffs.push(q.diffs.shift()),k=!1):-1===n&&1==m.diffs.length&&0==m.diffs[0][0]&&l.length>2*s?(m.length1+=l.length,p+=l.length,k=!1,m.diffs.push([n,l]),q.diffs.shift()):(l=l.substring(0,s-m.length1-this.Patch_Margin),m.length1+=l.length,p+=l.length,0===n?(m.length2+=l.length,o+=l.length):k=!1,m.diffs.push([n,l]),l==q.diffs[0][1]?q.diffs.shift():q.diffs[0][1]=q.diffs[0][1].substring(l.length))}n=this.diff_text2(m.diffs);n=n.substring(n.length-this.Patch_Margin);l=this.diff_text1(q.diffs).substring(0,this.Patch_Margin);""!==l&&(m.length1+=l.length,m.length2+=l.length,0!==m.diffs.length&&0===m.diffs[m.diffs.length-1][0]?m.diffs[m.diffs.length-1][1]+=l:m.diffs.push([0,l]));k||t.splice(++r,0,m)}}}};a.prototype.patch_toText=function(e){for(var d=[],f=0;f<e.length;f++){d[f]=e[f]}return d.join("")};a.prototype.patch_fromText=function(j){var i=[];if(!j){return i}for(var j=j.split("\n"),p=0,o=/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/;p<j.length;){var n=j[p].match(o);if(!n){throw Error("Invalid patch string: "+j[p])}var m=new a.patch_obj;i.push(m);m.start1=parseInt(n[1],10);""===n[2]?(m.start1--,m.length1=1):"0"==n[2]?m.length1=0:(m.start1--,m.length1=parseInt(n[2],10));m.start2=parseInt(n[3],10);""===n[4]?(m.start2--,m.length2=1):"0"==n[4]?m.length2=0:(m.start2--,m.length2=parseInt(n[4],10));for(p++;p<j.length;){n=j[p].charAt(0);try{var l=decodeURI(j[p].substring(1))}catch(k){throw Error("Illegal escape in patch_fromText: "+l)}if("-"==n){m.diffs.push([-1,l])}else{if("+"==n){m.diffs.push([1,l])}else{if(" "==n){m.diffs.push([0,l])}else{if("@"==n){break}else{if(""!==n){throw Error('Invalid patch mode "'+n+'" in: '+l)}}}}}p++}}return i};a.patch_obj=function(){this.diffs=[];this.start2=this.start1=null;this.length2=this.length1=0};a.patch_obj.prototype.toString=function(){var e,d;e=0===this.length1?this.start1+",0":1==this.length1?this.start1+1:this.start1+1+","+this.length1;d=0===this.length2?this.start2+",0":1==this.length2?this.start2+1:this.start2+1+","+this.length2;e=["@@ -"+e+" +"+d+" @@\n"];var f;for(d=0;d<this.diffs.length;d++){switch(this.diffs[d][0]){case 1:f="+";break;case -1:f="-";break;case 0:f=" "}e[d+1]=f+encodeURI(this.diffs[d][1])+"\n"}return e.join("").replace(/%20/g," ")};this.diff_match_patch=a;this.DIFF_DELETE=-1;this.DIFF_INSERT=1;this.DIFF_EQUAL=0})();function diff_match_patch(){this.Diff_Timeout=1;this.Diff_EditCost=4;this.Match_Threshold=0.5;this.Match_Distance=1000;this.Patch_DeleteThreshold=0.5;this.Patch_Margin=4;this.Match_MaxBits=32}var DIFF_DELETE=-1;var DIFF_INSERT=1;var DIFF_EQUAL=0;diff_match_patch.Diff;diff_match_patch.prototype.diff_main=function(b,a,d,f){if(typeof f=="undefined"){if(this.Diff_Timeout<=0){f=Number.MAX_VALUE}else{f=(new Date).getTime()+this.Diff_Timeout*1000}}var i=f;if(b==null||a==null){throw new Error("Null input. (diff_main)")}if(b==a){if(b){return[[DIFF_EQUAL,b]]}return[]}if(typeof d=="undefined"){d=true}var j=d;var e=this.diff_commonPrefix(b,a);var h=b.substring(0,e);b=b.substring(e);a=a.substring(e);e=this.diff_commonSuffix(b,a);var c=b.substring(b.length-e);b=b.substring(0,b.length-e);a=a.substring(0,a.length-e);var g=this.diff_compute_(b,a,j,i);if(h){g.unshift([DIFF_EQUAL,h])}if(c){g.push([DIFF_EQUAL,c])}this.diff_cleanupMerge(g);return g};diff_match_patch.prototype.diff_compute_=function(c,b,q,p){var j;if(!c){return[[DIFF_INSERT,b]]}if(!b){return[[DIFF_DELETE,c]]}var m=c.length>b.length?c:b;var d=c.length>b.length?b:c;var f=m.indexOf(d);if(f!=-1){j=[[DIFF_INSERT,m.substring(0,f)],[DIFF_EQUAL,d],[DIFF_INSERT,m.substring(f+d.length)]];if(c.length>b.length){j[0][0]=j[2][0]=DIFF_DELETE}return j}if(d.length==1){return[[DIFF_DELETE,c],[DIFF_INSERT,b]]}m=d=null;var a=this.diff_halfMatch_(c,b);if(a){var l=a[0];var h=a[1];var o=a[2];var n=a[3];var e=a[4];var k=this.diff_main(l,o,q,p);var g=this.diff_main(h,n,q,p);return k.concat([[DIFF_EQUAL,e]],g)}if(q&&c.length>100&&b.length>100){return this.diff_lineMode_(c,b,p)}return this.diff_bisect_(c,b,p)};diff_match_patch.prototype.diff_lineMode_=function(d,c,n){var k=this.diff_linesToChars_(d,c);d=k.chars1;c=k.chars2;var e=k.lineArray;var g=this.diff_main(d,c,false,n);this.diff_charsToLines_(g,e);this.diff_cleanupSemantic(g);g.push([DIFF_EQUAL,""]);var b=0;var m=0;var l=0;var i="";var h="";while(b<g.length){switch(g[b][0]){case DIFF_INSERT:l++;h+=g[b][1];break;case DIFF_DELETE:m++;i+=g[b][1];break;case DIFF_EQUAL:if(m>=1&&l>=1){g.splice(b-m-l,m+l);b=b-m-l;var k=this.diff_main(i,h,false,n);for(var f=k.length-1;f>=0;f--){g.splice(b,0,k[f])}b=b+k.length}l=0;m=0;i="";h="";break}b++}g.pop();return g};diff_match_patch.prototype.diff_bisect_=function(n,l,A){var v=n.length;var g=l.length;var h=Math.ceil((v+g)/2);var r=h;var o=2*h;var e=new Array(o);var b=new Array(o);for(var m=0;m<o;m++){e[m]=-1;b[m]=-1}e[r+1]=0;b[r+1]=0;var B=v-g;var i=(B%2!=0);var s=0;var p=0;var u=0;var t=0;for(var z=0;z<h;z++){if((new Date()).getTime()>A){break}for(var k=-z+s;k<=z-p;k+=2){var q=r+k;var y;if(k==-z||(k!=z&&e[q-1]<e[q+1])){y=e[q+1]}else{y=e[q-1]+1}var f=y-k;while(y<v&&f<g&&n.charAt(y)==l.charAt(f)){y++;f++}e[q]=y;if(y>v){p+=2}else{if(f>g){s+=2}else{if(i){var a=r+B-k;if(a>=0&&a<o&&b[a]!=-1){var w=v-b[a];if(y>=w){return this.diff_bisectSplit_(n,l,y,f,A)}}}}}}for(var j=-z+u;j<=z-t;j+=2){var a=r+j;var w;if(j==-z||(j!=z&&b[a-1]<b[a+1])){w=b[a+1]}else{w=b[a-1]+1}var c=w-j;while(w<v&&c<g&&n.charAt(v-w-1)==l.charAt(g-c-1)){w++;c++}b[a]=w;if(w>v){t+=2}else{if(c>g){u+=2}else{if(!i){var q=r+B-j;if(q>=0&&q<o&&e[q]!=-1){var y=e[q];var f=r+y-q;w=v-w;if(y>=w){return this.diff_bisectSplit_(n,l,y,f,A)}}}}}}}return[[DIFF_DELETE,n],[DIFF_INSERT,l]]};diff_match_patch.prototype.diff_bisectSplit_=function(d,c,i,h,k){var f=d.substring(0,i);var b=c.substring(0,h);var e=d.substring(i);var a=c.substring(h);var g=this.diff_main(f,b,false,k);var j=this.diff_main(e,a,false,k);return g.concat(j)};diff_match_patch.prototype.diff_linesToChars_=function(g,e){var d=[];var a={};d[0]="";function f(m){var k="";var i=0;var l=-1;var j=d.length;while(l<m.length-1){l=m.indexOf("\n",i);if(l==-1){l=m.length-1}var h=m.substring(i,l+1);i=l+1;if(a.hasOwnProperty?a.hasOwnProperty(h):(a[h]!==undefined)){k+=String.fromCharCode(a[h])}else{k+=String.fromCharCode(j);a[h]=j;d[j++]=h}}return k}var c=f(g);var b=f(e);return{chars1:c,chars2:b,lineArray:d}};diff_match_patch.prototype.diff_charsToLines_=function(e,b){for(var a=0;a<e.length;a++){var c=e[a][1];var d=[];for(var f=0;f<c.length;f++){d[f]=b[c.charCodeAt(f)]}e[a][1]=d.join("")}};diff_match_patch.prototype.diff_commonPrefix=function(e,d){if(!e||!d||e.charAt(0)!=d.charAt(0)){return 0}var b=0;var f=Math.min(e.length,d.length);var a=f;var c=0;while(b<a){if(e.substring(c,a)==d.substring(c,a)){b=a;c=b}else{f=a}a=Math.floor((f-b)/2+b)}return a};diff_match_patch.prototype.diff_commonSuffix=function(d,c){if(!d||!c||d.charAt(d.length-1)!=c.charAt(c.length-1)){return 0}var b=0;var e=Math.min(d.length,c.length);var a=e;var f=0;while(b<a){if(d.substring(d.length-a,d.length-f)==c.substring(c.length-a,c.length-f)){b=a;f=b}else{e=a}a=Math.floor((e-b)/2+b)}return a};diff_match_patch.prototype.diff_commonOverlap_=function(b,a){var g=b.length;var e=a.length;if(g==0||e==0){return 0}if(g>e){b=b.substring(g-e)}else{if(g<e){a=a.substring(0,g)}}var h=Math.min(g,e);if(b==a){return h}var d=0;var c=1;while(true){var f=b.substring(h-c);var i=a.indexOf(f);if(i==-1){return d}c+=i;if(i==0||b.substring(h-c)==a.substring(0,c)){d=c;c++}}};diff_match_patch.prototype.diff_halfMatch_=function(c,b){if(this.Diff_Timeout<=0){return null}var j=c.length>b.length?c:b;var d=c.length>b.length?b:c;if(j.length<4||d.length*2<j.length){return null}var n=this;function k(v,o,r){var t=v.substring(r,r+Math.floor(v.length/4));var p=-1;var z="";var s,q,y,x;while((p=o.indexOf(t,p+1))!=-1){var u=n.diff_commonPrefix(v.substring(r),o.substring(p));var w=n.diff_commonSuffix(v.substring(0,r),o.substring(0,p));if(z.length<w+u){z=o.substring(p-w,p)+o.substring(p,p+u);s=v.substring(0,r-w);q=v.substring(r+u);y=o.substring(0,p-w);x=o.substring(p+u)}}if(z.length*2>=v.length){return[s,q,y,x,z]}else{return null}}var g=k(j,d,Math.ceil(j.length/4));var f=k(j,d,Math.ceil(j.length/2));var a;if(!g&&!f){return null}else{if(!f){a=g}else{if(!g){a=f}else{a=g[4].length>f[4].length?g:f}}}var i,h,m,l;if(c.length>b.length){i=a[0];h=a[1];m=a[2];l=a[3]}else{m=a[0];l=a[1];i=a[2];h=a[3]}var e=a[4];return[i,h,m,l,e]};diff_match_patch.prototype.diff_cleanupSemantic=function(m){var n=false;var l=[];var e=0;var f=null;var a=0;var k=0;var j=0;var i=0;var h=0;while(a<m.length){if(m[a][0]==DIFF_EQUAL){l[e++]=a;k=i;j=h;i=0;h=0;f=m[a][1]}else{if(m[a][0]==DIFF_INSERT){i+=m[a][1].length}else{h+=m[a][1].length}if(f&&(f.length<=Math.max(k,j))&&(f.length<=Math.max(i,h))){m.splice(l[e-1],0,[DIFF_DELETE,f]);m[l[e-1]+1][0]=DIFF_INSERT;e--;e--;a=e>0?l[e-1]:-1;k=0;j=0;i=0;h=0;f=null;n=true}}a++}if(n){this.diff_cleanupMerge(m)}this.diff_cleanupSemanticLossless(m);a=1;while(a<m.length){if(m[a-1][0]==DIFF_DELETE&&m[a][0]==DIFF_INSERT){var g=m[a-1][1];var b=m[a][1];var d=this.diff_commonOverlap_(g,b);var c=this.diff_commonOverlap_(b,g);if(d>=c){if(d>=g.length/2||d>=b.length/2){m.splice(a,0,[DIFF_EQUAL,b.substring(0,d)]);m[a-1][1]=g.substring(0,g.length-d);m[a+1][1]=b.substring(d);a++}}else{if(c>=g.length/2||c>=b.length/2){m.splice(a,0,[DIFF_EQUAL,g.substring(0,c)]);m[a-1][0]=DIFF_INSERT;m[a-1][1]=b.substring(0,b.length-c);m[a+1][0]=DIFF_DELETE;m[a+1][1]=g.substring(c);a++}}a++}a++}};diff_match_patch.prototype.diff_cleanupSemanticLossless=function(i){function c(r,y){if(!r||!y){return 6}var t=r.charAt(r.length-1);var s=y.charAt(0);var x=t.match(diff_match_patch.nonAlphaNumericRegex_);var w=s.match(diff_match_patch.nonAlphaNumericRegex_);var o=x&&t.match(diff_match_patch.whitespaceRegex_);var n=w&&s.match(diff_match_patch.whitespaceRegex_);var q=o&&t.match(diff_match_patch.linebreakRegex_);var p=n&&s.match(diff_match_patch.linebreakRegex_);var v=q&&r.match(diff_match_patch.blanklineEndRegex_);var u=p&&y.match(diff_match_patch.blanklineStartRegex_);if(t.match(/[<.+?>]/)){return 5}else{if(v||u){return 5}else{if(q||p){return 4}else{if(x&&!o&&n){return 3}else{if(o||n){return 2}else{if(x||w){return 1}}}}}}return 0}var a=1;while(a<i.length-1){if(i[a-1][0]==DIFF_EQUAL&&i[a+1][0]==DIFF_EQUAL){var m=i[a-1][1];var l=i[a][1];var k=i[a+1][1];var j=this.diff_commonSuffix(m,l);if(j){var b=l.substring(l.length-j);m=m.substring(0,m.length-j);l=b+l.substring(0,l.length-j);k=b+k}var g=m;var h=l;var f=k;var e=c(m,l)+c(l,k);while(l.charAt(0)===k.charAt(0)){m+=l.charAt(0);l=l.substring(1)+k.charAt(0);k=k.substring(1);var d=c(m,l)+c(l,k);if(d>=e){e=d;g=m;h=l;f=k}}if(i[a-1][1]!=g){if(g){i[a-1][1]=g}else{i.splice(a-1,1);a--}i[a][1]=h;if(f){i[a+1][1]=f}else{i.splice(a+1,1);a--}}}a++}};diff_match_patch.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/;diff_match_patch.whitespaceRegex_=/\s/;diff_match_patch.linebreakRegex_=/[\r\n]/;diff_match_patch.blanklineEndRegex_=/\n\r?\n$/;diff_match_patch.blanklineStartRegex_=/^\r?\n\r?\n/;diff_match_patch.prototype.diff_cleanupEfficiency=function(g){var i=false;var f=[];var c=0;var d=null;var a=0;var h=false;var j=false;var b=false;var e=false;while(a<g.length){if(g[a][0]==DIFF_EQUAL){if(g[a][1].length<this.Diff_EditCost&&(b||e)){f[c++]=a;h=b;j=e;d=g[a][1]}else{c=0;d=null}b=e=false}else{if(g[a][0]==DIFF_DELETE){e=true}else{b=true}if(d&&((h&&j&&b&&e)||((d.length<this.Diff_EditCost/2)&&(h+j+b+e)==3))){g.splice(f[c-1],0,[DIFF_DELETE,d]);g[f[c-1]+1][0]=DIFF_INSERT;c--;d=null;if(h&&j){b=e=true;c=0}else{c--;a=c>0?f[c-1]:-1;b=e=false}i=true}}a++}if(i){this.diff_cleanupMerge(g)}};diff_match_patch.prototype.diff_cleanupMerge=function(h){h.push([DIFF_EQUAL,""]);var g=0;var f=0;var e=0;var c="";var b="";var a;while(g<h.length){switch(h[g][0]){case DIFF_INSERT:e++;b+=h[g][1];g++;break;case DIFF_DELETE:f++;c+=h[g][1];g++;break;case DIFF_EQUAL:if(f+e>1){if(f!==0&&e!==0){a=this.diff_commonPrefix(b,c);if(a!==0){if((g-f-e)>0&&h[g-f-e-1][0]==DIFF_EQUAL){h[g-f-e-1][1]+=b.substring(0,a)}else{h.splice(0,0,[DIFF_EQUAL,b.substring(0,a)]);g++}b=b.substring(a);c=c.substring(a)}a=this.diff_commonSuffix(b,c);if(a!==0){h[g][1]=b.substring(b.length-a)+h[g][1];b=b.substring(0,b.length-a);c=c.substring(0,c.length-a)}}if(f===0){h.splice(g-e,f+e,[DIFF_INSERT,b])}else{if(e===0){h.splice(g-f,f+e,[DIFF_DELETE,c])}else{h.splice(g-f-e,f+e,[DIFF_DELETE,c],[DIFF_INSERT,b])}}g=g-f-e+(f?1:0)+(e?1:0)+1}else{if(g!==0&&h[g-1][0]==DIFF_EQUAL){h[g-1][1]+=h[g][1];h.splice(g,1)}else{g++}}e=0;f=0;c="";b="";break}}if(h[h.length-1][1]===""){h.pop()}var d=false;g=1;while(g<h.length-1){if(h[g-1][0]==DIFF_EQUAL&&h[g+1][0]==DIFF_EQUAL){if(h[g][1].substring(h[g][1].length-h[g-1][1].length)==h[g-1][1]){h[g][1]=h[g-1][1]+h[g][1].substring(0,h[g][1].length-h[g-1][1].length);h[g+1][1]=h[g-1][1]+h[g+1][1];h.splice(g-1,1);d=true}else{if(h[g][1].substring(0,h[g+1][1].length)==h[g+1][1]){h[g-1][1]+=h[g+1][1];h[g][1]=h[g][1].substring(h[g+1][1].length)+h[g+1][1];h.splice(g+1,1);d=true}}}g++}if(d){this.diff_cleanupMerge(h)}};diff_match_patch.prototype.diff_xIndex=function(g,f){var d=0;var b=0;var e=0;var c=0;var a;for(a=0;a<g.length;a++){if(g[a][0]!==DIFF_INSERT){d+=g[a][1].length}if(g[a][0]!==DIFF_DELETE){b+=g[a][1].length}if(d>f){break}e=d;c=b}if(g.length!=a&&g[a][0]===DIFF_DELETE){return c}return c+(f-e)};diff_match_patch.prototype.diff_prettyHtml=function(f){var d=[];var h=/&/g;var c=/</g;var a=/>/g;var g=/\n/g;for(var i=0;i<f.length;i++){var e=f[i][0];var b=f[i][1];var j=b.replace(h,"&amp;").replace(c,"&lt;").replace(a,"&gt;").replace(g,"&para;<br>");switch(e){case DIFF_INSERT:d[i]='<ins style="background:#e6ffe6;">'+j+"</ins>";break;case DIFF_DELETE:d[i]='<del style="background:#ffe6e6;">'+j+"</del>";break;case DIFF_EQUAL:d[i]="<span>"+j+"</span>";break}}return d.join("")};diff_match_patch.prototype.diff_text1=function(c){var b=[];for(var a=0;a<c.length;a++){if(c[a][0]!==DIFF_INSERT){b[a]=c[a][1]}}return b.join("")};diff_match_patch.prototype.diff_text2=function(c){var b=[];for(var a=0;a<c.length;a++){if(c[a][0]!==DIFF_DELETE){b[a]=c[a][1]}}return b.join("")};diff_match_patch.prototype.diff_levenshtein=function(f){var e=0;var b=0;var d=0;for(var a=0;a<f.length;a++){var g=f[a][0];var c=f[a][1];switch(g){case DIFF_INSERT:b+=c.length;break;case DIFF_DELETE:d+=c.length;break;case DIFF_EQUAL:e+=Math.max(b,d);b=0;d=0;break}}e+=Math.max(b,d);return e};diff_match_patch.prototype.diff_toDelta=function(c){var b=[];for(var a=0;a<c.length;a++){switch(c[a][0]){case DIFF_INSERT:b[a]="+"+encodeURI(c[a][1]);break;case DIFF_DELETE:b[a]="-"+c[a][1].length;break;case DIFF_EQUAL:b[a]="="+c[a][1].length;break}}return b.join("\t").replace(/%20/g," ")};diff_match_patch.prototype.diff_fromDelta=function(b,j){var f=[];var e=0;var a=0;var h=j.split(/\t/g);for(var i=0;i<h.length;i++){var d=h[i].substring(1);switch(h[i].charAt(0)){case"+":try{f[e++]=[DIFF_INSERT,decodeURI(d)]}catch(g){throw new Error("Illegal escape in diff_fromDelta: "+d)}break;case"-":case"=":var c=parseInt(d,10);if(isNaN(c)||c<0){throw new Error("Invalid number in diff_fromDelta: "+d)}var k=b.substring(a,a+=c);if(h[i].charAt(0)=="="){f[e++]=[DIFF_EQUAL,k]}else{f[e++]=[DIFF_DELETE,k]}break;default:if(h[i]){throw new Error("Invalid diff operation in diff_fromDelta: "+h[i])}}}if(a!=b.length){throw new Error("Delta length ("+a+") does not equal source text length ("+b.length+").")}return f};diff_match_patch.prototype.match_main=function(c,a,b){if(c==null||a==null||b==null){throw new Error("Null input. (match_main)")}b=Math.max(0,Math.min(b,c.length));if(c==a){return 0}else{if(!c.length){return -1}else{if(c.substring(b,b+a.length)==a){return b}else{return this.match_bitap_(c,a,b)}}}};diff_match_patch.prototype.match_bitap_=function(l,t,i){if(t.length>this.Match_MaxBits){throw new Error("Pattern too long for this browser.")}var m=this.match_alphabet_(t);var a=this;function b(y,d){var s=y/t.length;var j=Math.abs(i-d);if(!a.Match_Distance){return j?1:s}return s+(j/a.Match_Distance)}var o=this.Match_Threshold;var c=l.indexOf(t,i);if(c!=-1){o=Math.min(b(0,c),o);c=l.lastIndexOf(t,i+t.length);if(c!=-1){o=Math.min(b(0,c),o)}}var v=1<<(t.length-1);c=-1;var f,k;var g=t.length+l.length;var h;for(var u=0;u<t.length;u++){f=0;k=g;while(f<k){if(b(u,i+k)<=o){f=k}else{g=k}k=Math.floor((g-f)/2+f)}g=k;var e=Math.max(1,i-k+1);var n=Math.min(i+k,l.length)+t.length;var p=Array(n+2);p[n+1]=(1<<u)-1;for(var q=n;q>=e;q--){var w=m[l.charAt(q-1)];if(u===0){p[q]=((p[q+1]<<1)|1)&w}else{p[q]=(((p[q+1]<<1)|1)&w)|(((h[q+1]|h[q])<<1)|1)|h[q+1]}if(p[q]&v){var r=b(u,q-1);if(r<=o){o=r;c=q-1;if(c>i){e=Math.max(1,2*i-c)}else{break}}}}if(b(u+1,i)>o){break}h=p}return c};diff_match_patch.prototype.match_alphabet_=function(c){var b={};for(var a=0;a<c.length;a++){b[c.charAt(a)]=0}for(var a=0;a<c.length;a++){b[c.charAt(a)]|=1<<(c.length-a-1)}return b};diff_match_patch.prototype.patch_addContext_=function(f,e){if(e.length==0){return}var b=e.substring(f.start2,f.start2+f.length1);var d=0;while(e.indexOf(b)!=e.lastIndexOf(b)&&b.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin){d+=this.Patch_Margin;b=e.substring(f.start2-d,f.start2+f.length1+d)}d+=this.Patch_Margin;var a=e.substring(f.start2-d,f.start2);if(a){f.diffs.unshift([DIFF_EQUAL,a])}var c=e.substring(f.start2+f.length1,f.start2+f.length1+d);if(c){f.diffs.push([DIFF_EQUAL,c])}f.start1-=a.length;f.start2-=a.length;f.length1+=a.length+c.length;f.length2+=a.length+c.length};diff_match_patch.prototype.patch_make=function(o,c,p){var d,k;if(typeof o=="string"&&typeof c=="string"&&typeof p=="undefined"){d=(o);k=this.diff_main(d,(c),true);if(k.length>2){this.diff_cleanupSemantic(k);this.diff_cleanupEfficiency(k)}}else{if(o&&typeof o=="object"&&typeof c=="undefined"&&typeof p=="undefined"){k=(o);d=this.diff_text1(k)}else{if(typeof o=="string"&&c&&typeof c=="object"&&typeof p=="undefined"){d=(o);k=(c)}else{if(typeof o=="string"&&typeof c=="string"&&p&&typeof p=="object"){d=(o);k=(p)}else{throw new Error("Unknown call format to patch_make.")}}}}if(k.length===0){return[]}var b=[];var e=new diff_match_patch.patch_obj();var h=0;var j=0;var i=0;var g=d;var m=d;for(var n=0;n<k.length;n++){var f=k[n][0];var l=k[n][1];if(!h&&f!==DIFF_EQUAL){e.start1=j;e.start2=i}switch(f){case DIFF_INSERT:e.diffs[h++]=k[n];e.length2+=l.length;m=m.substring(0,i)+l+m.substring(i);break;case DIFF_DELETE:e.length1+=l.length;e.diffs[h++]=k[n];m=m.substring(0,i)+m.substring(i+l.length);break;case DIFF_EQUAL:if(l.length<=2*this.Patch_Margin&&h&&k.length!=n+1){e.diffs[h++]=k[n];e.length1+=l.length;e.length2+=l.length}else{if(l.length>=2*this.Patch_Margin){if(h){this.patch_addContext_(e,g);b.push(e);e=new diff_match_patch.patch_obj();h=0;g=m;j=i}}}break}if(f!==DIFF_INSERT){j+=l.length}if(f!==DIFF_DELETE){i+=l.length}}if(h){this.patch_addContext_(e,g);b.push(e)}return b};diff_match_patch.prototype.patch_deepCopy=function(c){var d=[];for(var b=0;b<c.length;b++){var f=c[b];var a=new diff_match_patch.patch_obj();a.diffs=[];for(var e=0;e<f.diffs.length;e++){a.diffs[e]=f.diffs[e].slice()}a.start1=f.start1;a.start2=f.start2;a.length1=f.length1;a.length2=f.length2;d[b]=a}return d};diff_match_patch.prototype.patch_apply=function(a,p){if(a.length==0){return[p,[]]}a=this.patch_deepCopy(a);var c=this.patch_addPadding(a);p=c+p+c;this.patch_splitMax(a);var o=0;var g=[];for(var n=0;n<a.length;n++){var b=a[n].start2+o;var e=this.diff_text1(a[n].diffs);var f;var k=-1;if(e.length>this.Match_MaxBits){f=this.match_main(p,e.substring(0,this.Match_MaxBits),b);if(f!=-1){k=this.match_main(p,e.substring(e.length-this.Match_MaxBits),b+e.length-this.Match_MaxBits);if(k==-1||f>=k){f=-1}}}else{f=this.match_main(p,e,b)}if(f==-1){g[n]=false;o-=a[n].length2-a[n].length1}else{g[n]=true;o=f-b;var d;if(k==-1){d=p.substring(f,f+e.length)}else{d=p.substring(f,k+this.Match_MaxBits)}if(e==d){p=p.substring(0,f)+this.diff_text2(a[n].diffs)+p.substring(f+e.length)}else{var i=this.diff_main(e,d,false);if(e.length>this.Match_MaxBits&&this.diff_levenshtein(i)/e.length>this.Patch_DeleteThreshold){g[n]=false}else{this.diff_cleanupSemanticLossless(i);var j=0;var h;for(var m=0;m<a[n].diffs.length;m++){var l=a[n].diffs[m];if(l[0]!==DIFF_EQUAL){h=this.diff_xIndex(i,j)}if(l[0]===DIFF_INSERT){p=p.substring(0,f+h)+l[1]+p.substring(f+h)}else{if(l[0]===DIFF_DELETE){p=p.substring(0,f+h)+p.substring(f+this.diff_xIndex(i,j+l[1].length))}}if(l[0]!==DIFF_DELETE){j+=l[1].length}}}}}}p=p.substring(c.length,p.length-c.length);return[p,g]};diff_match_patch.prototype.patch_addPadding=function(d){var c=this.Patch_Margin;var b="";for(var a=1;a<=c;a++){b+=String.fromCharCode(a)}for(var a=0;a<d.length;a++){d[a].start1+=c;d[a].start2+=c}var g=d[0];var f=g.diffs;if(f.length==0||f[0][0]!=DIFF_EQUAL){f.unshift([DIFF_EQUAL,b]);g.start1-=c;g.start2-=c;g.length1+=c;g.length2+=c}else{if(c>f[0][1].length){var e=c-f[0][1].length;f[0][1]=b.substring(f[0][1].length)+f[0][1];g.start1-=e;g.start2-=e;g.length1+=e;g.length2+=e}}g=d[d.length-1];f=g.diffs;if(f.length==0||f[f.length-1][0]!=DIFF_EQUAL){f.push([DIFF_EQUAL,b]);g.length1+=c;g.length2+=c}else{if(c>f[f.length-1][1].length){var e=c-f[f.length-1][1].length;f[f.length-1][1]+=b.substring(0,e);g.length1+=e;g.length2+=e}}return b};diff_match_patch.prototype.patch_splitMax=function(a){var i=this.Match_MaxBits;for(var l=0;l<a.length;l++){if(a[l].length1<=i){continue}var f=a[l];a.splice(l--,1);var c=f.start1;var b=f.start2;var g="";while(f.diffs.length!==0){var e=new diff_match_patch.patch_obj();var j=true;e.start1=c-g.length;e.start2=b-g.length;if(g!==""){e.length1=e.length2=g.length;e.diffs.push([DIFF_EQUAL,g])}while(f.diffs.length!==0&&e.length1<i-this.Patch_Margin){var h=f.diffs[0][0];var k=f.diffs[0][1];if(h===DIFF_INSERT){e.length2+=k.length;b+=k.length;e.diffs.push(f.diffs.shift());j=false}else{if(h===DIFF_DELETE&&e.diffs.length==1&&e.diffs[0][0]==DIFF_EQUAL&&k.length>2*i){e.length1+=k.length;c+=k.length;j=false;e.diffs.push([h,k]);f.diffs.shift()}else{k=k.substring(0,i-e.length1-this.Patch_Margin);e.length1+=k.length;c+=k.length;if(h===DIFF_EQUAL){e.length2+=k.length;b+=k.length}else{j=false}e.diffs.push([h,k]);if(k==f.diffs[0][1]){f.diffs.shift()}else{f.diffs[0][1]=f.diffs[0][1].substring(k.length)}}}}g=this.diff_text2(e.diffs);g=g.substring(g.length-this.Patch_Margin);var d=this.diff_text1(f.diffs).substring(0,this.Patch_Margin);if(d!==""){e.length1+=d.length;e.length2+=d.length;if(e.diffs.length!==0&&e.diffs[e.diffs.length-1][0]===DIFF_EQUAL){e.diffs[e.diffs.length-1][1]+=d}else{e.diffs.push([DIFF_EQUAL,d])}}if(!j){a.splice(++l,0,e)}}}};diff_match_patch.prototype.patch_toText=function(b){var c=[];for(var a=0;a<b.length;a++){c[a]=b[a]}return c.join("")};diff_match_patch.prototype.patch_fromText=function(g){var a=[];if(!g){return a}var h=g.split("\n");var j=0;var b=/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/;while(j<h.length){var e=h[j].match(b);if(!e){throw new Error("Invalid patch string: "+h[j])}var c=new diff_match_patch.patch_obj();a.push(c);c.start1=parseInt(e[1],10);if(e[2]===""){c.start1--;c.length1=1}else{if(e[2]=="0"){c.length1=0}else{c.start1--;c.length1=parseInt(e[2],10)}}c.start2=parseInt(e[3],10);if(e[4]===""){c.start2--;c.length2=1}else{if(e[4]=="0"){c.length2=0}else{c.start2--;c.length2=parseInt(e[4],10)}}j++;while(j<h.length){var d=h[j].charAt(0);try{var i=decodeURI(h[j].substring(1))}catch(f){throw new Error("Illegal escape in patch_fromText: "+i)}if(d=="-"){c.diffs.push([DIFF_DELETE,i])}else{if(d=="+"){c.diffs.push([DIFF_INSERT,i])}else{if(d==" "){c.diffs.push([DIFF_EQUAL,i])}else{if(d=="@"){break}else{if(d===""){}else{throw new Error('Invalid patch mode "'+d+'" in: '+i)}}}}}j++}}return a};diff_match_patch.patch_obj=function(){this.diffs=[];this.start1=null;this.start2=null;this.length1=0;this.length2=0};diff_match_patch.patch_obj.prototype.toString=function(){var b,e;if(this.length1===0){b=this.start1+",0"}else{if(this.length1==1){b=this.start1+1}else{b=(this.start1+1)+","+this.length1}}if(this.length2===0){e=this.start2+",0"}else{if(this.length2==1){e=this.start2+1}else{e=(this.start2+1)+","+this.length2}}var c=["@@ -"+b+" +"+e+" @@\n"];var d;for(var a=0;a<this.diffs.length;a++){switch(this.diffs[a][0]){case DIFF_INSERT:d="+";break;case DIFF_DELETE:d="-";break;case DIFF_EQUAL:d=" ";break}c[a+1]=d+encodeURI(this.diffs[a][1])+"\n"}return c.join("").replace(/%20/g," ")};this["diff_match_patch"]=diff_match_patch;this["DIFF_DELETE"]=DIFF_DELETE;this["DIFF_INSERT"]=DIFF_INSERT;this["DIFF_EQUAL"]=DIFF_EQUAL;var $dyncss=function(){var a=$("iframe#r_engine").contents().children("html").children("head").children('style[title="dynamicstyle"]');if(!a.length){$("iframe#r_engine").contents().children("html").children("head").append('<style title="dynamicstyle"></style>');a=$("iframe#r_engine").contents().children("html").children("head").children('style[title="dynamicstyle"]')}return a};function createCSSRules(){if(typeof KolabInReal!="object"||!KolabInReal.hasOwnProperty("currentSquareMembers")){return}var a="";KolabInReal.currentSquareMembers.forEach(function(b){if(b.hasOwnProperty("colorVisible")&&b.colorVisible){a+='span[author="'+b.kolabID+'"] {color:'+b.color+";}\n"}else{a+='span[author="'+b.kolabID+'"] {color:#000000;}\n';b.colorVisible=false}});$dyncss().text(a)}function updateCSSRules(){if(typeof KolabInReal!="object"||!KolabInReal.hasOwnProperty("currentSquareMembers")){return}var d=false,a=$dyncss().text(),c=[],b=-1;a.split("\n").forEach(function(e){b=e.indexOf('"',13);if(e.indexOf('span[author="')===0&&b!==-1){c.push(e.substring(13,b))}});KolabInReal.currentSquareMembers.forEach(function(e){if(c.indexOf(e.kolabID)==-1){d=true;a+='span[author="'+e.kolabID+'"] {color:#000000;}\n';e.colorVisible=false}});if(d){$dyncss().text(a)}return d}function getCSSRule(c,e){var e=typeof e!="undefined"?e:false;var a=$dyncss().text(),b,f,d="";a.split("\n").forEach(function(g){if(d){return}b=g.indexOf('"',13);if(g.indexOf('span[author="')===0&&b!==-1&&g.substring(13,b)===c){b=g.indexOf("{color:");f=g.indexOf(";",b+1);d=g.substring(b+7,f);return}});if(!d&&!e){updateCSSRules();d=getCSSRule(c,true)}return d}function setCSSRule(d,c){window.console.log(c);if(typeof KolabInReal!="object"||!KolabInReal.hasOwnProperty("currentSquareMembers")){return}var f=false,g=false,a=$dyncss().text().split("\n"),b=-1,e="";if(a[a.length-1]==""){a.pop()}a.forEach(function(h,i){b=h.indexOf('"',13);if(h.indexOf('span[author="')===0&&b!==-1&&h.substring(13,b)===d){f=true;b=h.indexOf("{color:");temp2=h.indexOf(";",b+1);e=h.substring(b+7,temp2);window.console.log(e);if(e!=c){g=true;a[i]=h.substring(0,b+7)+c+h.substring(temp2)}}});if(!f){a.push('span[author="'+d+'"] {color:'+c+";}");g=true;f=true}if(g){$dyncss().text(a.join("\n"))}return g}function toggleCSSRule(c){if(typeof KolabInReal!="object"||!KolabInReal.hasOwnProperty("currentSquareMembers")){return}var d=getCSSRule(c),b="",a=null;KolabInReal.currentSquareMembers.forEach(function(e){if(e.kolabID==c){b=e.color}});if(d==b){setCSSRule(c,"#000000");if(a){a.colorVisible=false}}else{setCSSRule(c,b);if(a){a.colorVisible=true}}};function initExports(a){$("#copyAll").zclip({path:a+"exports/Clipboard/ZeroClipboard10.swf",copy:function(){var b=$doc().html().replace(/(<div.*?>|<\/div>)/g,"");console.log(b);return applyHeadToText(b)}});$("#copyAllBrute").zclip({path:a+"exports/Clipboard/ZeroClipboard.swf",copy:$doc().text()});$("#pdf").bind("click",function(){managePdf("D")});$("#pdfPrint").bind("click",function(){managePdf("P")})}function managePdf(a){$("#PDFchoice").val(a);var b=$doc().html().replace(/^<div class="page.*?>/,"<page>").replace(/<\/div\>$/,"</page>").replace(/<\/div><div class="page.*?>/g,"</page><br clear=all><page>");b=b.replace(/(<div.*?>|<\/div>)/g,"");b=b.replace(/<iframe.*?link="(.*?)".*?><\/iframe>/,function(c,d){return'<qrcode value="'+d+'" ec="H" style="width: 50mm; background-color: white; color: black;"></qrcode>'});$("#PDFcontent").val(applyHeadToText(b));console.log(a,b)};function initHistoryManager(b,a){$("#userColor").bind("click",function(){toggleCSSRule(b);$("iframe#r_engine")[0].contentWindow.focus()})};function initImageManager(c,b,a){$("#imgAdd").bind("click",function(){$("#imgl,#imgi,#imgInsert").removeAttr("disabled");$("#imgAdd").attr("disabled","disabled");$("#imgInsert").bind("click",function(){insertImage(c,b)});$("#imgl").focus()})}function insertImage(c,b){if(verifyLink($("#imgl").val())){if($doc("div.selAnchor#"+c).length){selectionDelete(c,b)}if(previousNodeSearch($doc("div.cursor#"+c)[0])=="firstLine"){manageEnter(c,null,"kolab","undo",false);var h=$doc("div.cursor#"+c).parents("p.paragraphContainer").prev("p.paragraphContainer")}else{if(nextNodeSearch($doc("div.cursor#"+c)[0])=="lastLine"){manageEnter(c,null,"kolab","undo",false);var h=$doc("div.cursor#"+c).parents("p.paragraphContainer")}else{manageEnter(c,null,"kolab","undo",false);manageEnter(c,null,"kolab","undo",false);var h=$doc("div.cursor#"+c).parents("p.paragraphContainer").prev("p.paragraphContainer")}}h.html("");var g=klbGenerator();var d=$("#imgl").val();h.append('<img id="'+g+'" src="'+d+'"/>');h.append('<div id="'+g+'" class="info" contenteditable="false">'+$("#imgi").val()+"</div>");var a=$doc("img#"+g);var f=$doc("div#"+g);var e=$doc();$.preLoadImages([d],function(){if(a.width()>e.width()){a.css({width:e.width(),height:(e.width()*a.height())/a.width()});f.css("width",e.width())}else{f.css("width",a.width())}if(a.height()>e.height()){a.css({width:(e.height()*a.width())/a.height(),height:e.height()})}});$("#imgl,#imgi").val("");$("#imgInsert").unbind("click");$("#imgl,#imgi,#imgInsert").attr("disabled","disabled");$("#imgAdd").removeAttr("disabled");$("iframe#r_engine")[0].contentWindow.focus()}};(function(a){a.preLoadImages=function(g,f){var c=[],d,e,b=0;if(typeof g!="undefined"){if(a.isArray(g)){e=g.length;for(d=0;d<e;d++){c[d]=new Image();c[d].onload=function(){b++;if(b==e){if(a.isFunction(f)){f()}}};c[d].src=g[d]}}else{c[0]=new Image();if(a.isFunction(f)){c[0].onload=f}c[0].src=g}}else{if(a.isFunction(f)){f()}}c=undefined};a.preLoadCSSImages=function(h){var o=[],s,q=[],r=0,t,f=/url\((?:"|')?(?!data:)([^)"']+)(?:"|')?\)/i,l;var j=document.styleSheets,p,d="",n,k,m,u,b,e;for(b=0;b<j.length;b++){var g=j[b];if(typeof g.href=="string"&&g.href.length>0){l=g.href.split("/");l.pop();p=l.join("/")+"/"}else{p="./"}if(g.cssRules){d=g.cssRules}else{if(g.rules){d=g.rules}}if(d.length>0){for(e=0;e<d.length;e++){n=d[e];m=n.cssText?n.cssText:n.style.cssText;m=a.trim(m);if("@"===m.substr(0,1)){continue}k=f.exec(m);if(k!=null){u=k[1];if(u.substring(0,4)=="http"){q[q.length]=u}else{if(k[1].substring(1,2)=="/"){var c=p.split("/");c.pop();c.pop();p2x=c.join("/");q[q.length]=p2x+u}else{q[q.length]=p+u}}}}}}t=q.length;if(t>0){for(s=0;s<t;s++){o[s]=new Image();o[s].onload=function(){r++;if(r==t){if(a.isFunction(h)){h()}}};o[s].src=q[s]}}else{if(a.isFunction(h)){h()}}};a.preLoadAllImages=function(c,b){if(typeof c!="undefined"){if(a.isFunction(c)){b=c}else{if(!a.isArray(c)){c=[c]}}}a.preLoadCSSImages(function(){if(c.length>0){a.preLoadImages(c,b)}else{b()}})}})(jQuery);function initKeyController(b,a){$doc().bind("keypress",function(c){manageKeyPress(c,b,a)});$doc().bind("keydown",function(c){manageKeyDown(c,b,a)})}function manageKeyPress(f,c,b){if(!$doc("div.cursor#"+c).length||disableWriting){return}f.preventDefault(true);var d=$("iframe#r_engine").contents()[0].getSelection();d.removeAllRanges();if(f.which==13){if(f.shiftKey){return}var g=manageEnter(c,null,"kolab","undo",true);sendKeyEventToServer("spec","ENT",g,c,b);Cursor.setCursor(c,"#FF0063")}else{var a=String.fromCharCode(f.which);manageCharacterAdd(c,a,c,mapStyling,"kolab","undo");sendKeyEventToServer("add",a,stylesZip(mapStyling.style,mapStyling.value),c,b);if(mapStyling.style.length){checkToolbarState(c);mapStyling.style=[];mapStyling.value=[]}Cursor.setCursor(c,"#FF0063")}}function manageSpecialCharacterAdd(a,f,e,d,k,b){var h=$doc("div.cursor#"+a).parent();if(verifyAuthorStyle(h,e,d)){var c=$doc("div.cursor#"+a)[0].nextSibling;if(!c||c.nodeType!=3){$doc("div.cursor#"+a).after(f)}else{c.prependData(f)}}else{var j;if($($doc("div.cursor#"+a))[0].nextSibling&&$($doc("div.cursor#"+a))[0].nextSibling.nodeType==3){h.after('<span author="'+h.attr("author")+'" style="'+h.attr("style")+'"></span>');j=$(h[0].nextSibling);while($doc("div.cursor#"+a)[0].nextSibling){j.append($doc("div.cursor#"+a)[0].nextSibling)}h.after('<span author="'+e+'"></span>');j=$(h[0].nextSibling);for(i=0;i<d.style.length;i++){j.css(d.style[i],d.value[i])}}else{j=$(h[0].nextSibling);if(!verifyAuthorStyle(j,e,d)){h.after('<span author="'+e+'"></span>');j=$(h[0].nextSibling);for(i=0;i<d.style.length;i++){j.css(d.style[i],d.value[i])}}}j.prepend(f)}var g=h[0].childNodes[0];if($(g).text().match(/\u200b/)){$(g).remove();if(!h.text().length){j.prepend($doc("div.cursor#"+a));h.remove()}}pageRender.pageOverflow($doc("div.cursor#"+a).parents("div.page"));setParagraphLock(a,k);if(b=="undo"){Undo.addElement("break");Undo.addElement({action:"spec",content:"BAK",user:a,extra:""});Undo.addElement({action:"cursor",content:($doc("div.cursor#"+a).parents("p.paragraphContainer").attr("klb")+","+evaluateCursorPosInText(a,"cursor")),user:a,extra:""})}else{if(b=="redo"){Redo.addElement("break");Redo.addElement({action:"spec",content:"BAK",user:a,extra:""});Redo.addElement({action:"cursor",content:($doc("div.cursor#"+a).parents("p.paragraphContainer").attr("klb")+","+evaluateCursorPosInText(a,"cursor")),user:a,extra:""})}}}function manageCharacterAdd(v,h,p,m,o,r){var c=false;if($doc("div.selAnchor#"+v).length){selectionDelete(v,o,r);c=true}var b=$doc("div.cursor#"+v).parents("p.paragraphContainer").children("span[author]:first")[0].childNodes[0];var u={order:"",orderContent:""};if($(b).text().match(/\u200b/)){u.order=$(b).parent().attr("order");u.orderContent=$(b).parent().attr("orderContent");$(b).parent().removeAttr("order");$(b).parent().removeAttr("orderContent");$(b).remove()}else{if($doc("div.cursor#"+v).parent()[0]==$(b).parent()[0]){u.order=$doc("div.cursor#"+v).parent().attr("order");u.orderContent=$doc("div.cursor#"+v).parent().attr("orderContent");$doc("div.cursor#"+v).parent().removeAttr("order");$doc("div.cursor#"+v).parent().removeAttr("orderContent")}}if(h==" "){if(!$doc("div.cursor#"+v)[0].previousSibling&&!$doc("div.cursor#"+v).parent()[0].previousSibling){if(!$doc("div.cursor#"+v).parents("p")[0].previousSibling&&$doc("div.cursor#"+v).parents("div.page")[0].previousSibling){if($doc("div.cursor#"+v).parents("p").attr("klb")==$($doc("div.cursor#"+v).parents("div.page")[0].previousSibling).children(":last").attr("klb")){$($doc("div.cursor#"+v).parents("div.page")[0].previousSibling).children(":last").children(":last").append($doc("div.cursor#"+v))}}}}var w=true;var k=true;var g=true;var t=$doc("div.cursor#"+v).parent("span[author]");var f=t.attr("style");var e=t.attr("author");if($($doc("div.cursor#"+v))[0].previousSibling&&$($doc("div.cursor#"+v))[0].previousSibling.nodeType==3){w=false}if($($doc("div.cursor#"+v))[0].nextSibling&&$($doc("div.cursor#"+v))[0].nextSibling.nodeType==3){k=false}var a=false;if(e==p&&!m.style.length){a=true}if(w&&!a){var j=$(t[0].previousSibling);if(j.length&&j.attr("author")==p){if(m.style.length){for(var s=0;s<m.style.length;s++){if(j.css(m.style[s])!=m.value[s]){g=false;break}}}else{if(j.attr("style")!=t.attr("style")){g=false}}}else{g=false}if(!g){if(!t[0].previousSibling){t.before('<span author="'+p+'" style="'+f+'"></span>');j=$(t[0].previousSibling)}else{t.before('<span author="'+p+'" style="'+j.attr("style")+'"></span>');j=$(t[0].previousSibling)}for(s=0;s<m.style.length;s++){j.css(m.style[s],m.value[s])}}j.append($doc("div.cursor#"+v))}else{if(k&&!a){var n=$(t[0].nextSibling);if(n.length&&n.attr("author")==p){if(m.style.length){for(var s=0;s<m.style.length;s++){if(n.css(m.style[s])!=m.value[s]){g=false;break}}}else{if(n.attr("style")!=t.attr("style")){g=false}}}else{g=false}if(!g){t.after('<span author="'+p+'" style="'+f+'"></span>');n=$(t[0].nextSibling);for(s=0;s<m.style.length;s++){n.css(m.style[s],m.value[s])}}n.prepend($doc("div.cursor#"+v))}else{if(!a){t.before('<span author="'+e+'" style="'+f+'"></span>');var l=$(t[0].previousSibling);var d=t[0].childNodes;for(var s=0;s<d.length;s++){if(!$(d[s]).is($doc("div.cursor#"+v))){l.append($(d[s]));s--}else{break}}t.before('<span author="'+p+'" style="'+f+'"></span>');var j=$(t[0].previousSibling);for(s=0;s<m.style.length;s++){j.css(m.style[s],m.value[s])}j.append($doc("div.cursor#"+v))}}}if(!t[0].childNodes.length){t.remove()}var q=$doc("div.cursor#"+v)[0].previousSibling;if(!q||q.nodeType!=3){$doc("div.cursor#"+v).before(h)}else{q.appendData(h)}if(h==" "&&pageRender.verifyIfUnderflow(v)){pageRender.pageUnderflow($($doc("div.cursor#"+v).parents("div.page")[0].previousSibling),v,o)}pageRender.pageOverflow($doc("div.cursor#"+v).parents("div.page"));if(u.orderContent&&u.orderContent.length){$doc("div.cursor#"+v).parent().attr("order",u.order);$doc("div.cursor#"+v).parent().attr("orderContent",u.orderContent)}setParagraphLock(v,o);if(r=="undo"){if(!c){Undo.addElement("break")}Undo.addElement({action:"spec",content:"BAK",user:v,extra:""});Undo.addElement({action:"cursor",content:($doc("div.cursor#"+v).parents("p.paragraphContainer").attr("klb")+","+evaluateCursorPosInText(v,"cursor")),user:v,extra:""})}else{if(r=="redo"){if(!c){Redo.addElement("break")}Redo.addElement({action:"spec",content:"BAK",user:v,extra:""});Redo.addElement({action:"cursor",content:($doc("div.cursor#"+v).parents("p.paragraphContainer").attr("klb")+","+evaluateCursorPosInText(v,"cursor")),user:v,extra:""})}}}function manageKeyDown(h,c,a){if(!$doc("div.cursor#"+c).length||disableWriting){return}if(h.ctrlKey&&h.which!=17){}if(h.which==8){h.preventDefault(true);var g=$("iframe#r_engine").contents()[0].getSelection();g.removeAllRanges();if(!manageBackspace(c,"kolab","undo")){return}sendKeyEventToServer("spec","BAK",null,c,a);checkToolbarState(c);Cursor.setCursor(c,"#FF0063")}else{if(h.which>=37&&h.which<=40){var b=document.createRange();var d=window.getSelection();if(h.shiftKey){if(h.which==39){var f=nextNodeSearch($doc("div.cursor#"+c)[0]);if(f=="lastLine"){f=previousNodeSearch($doc("div.cursor#"+c)[0]);b.setStart(f,f.length);b.setEnd(f,f.length)}else{b.setStart(f,0);b.setEnd(f,0)}}else{var f=previousNodeSearch($doc("div.cursor#"+c)[0]);if(f=="firstLine"){f=nextNodeSearch($doc("div.cursor#"+c)[0]);b.setStart(f,0);b.setEnd(f,0)}else{b.setStart(f,f.length);b.setEnd(f,f.length)}}}else{$doc("div.selAnchor#"+c).remove();var f=previousNodeSearch($doc("div.cursor#"+c)[0]);if(f=="firstLine"){f=nextNodeSearch($doc("div.cursor#"+c)[0]);b.setStart(f,0);b.setEnd(f,0)}else{b.setStart(f,f.length);b.setEnd(f,f.length)}}d.removeAllRanges();d.addRange(b)}else{if(h.which==46){var g=$("iframe#r_engine").contents()[0].getSelection();g.removeAllRanges();h.preventDefault(true);if(!manageDelete(c,"kolab","undo")){return}sendKeyEventToServer("spec","DEL",null,c,a);checkToolbarState(c);Cursor.setCursor(c,"#FF0063")}else{if(h.which==9){var g=$("iframe#r_engine").contents()[0].getSelection();g.removeAllRanges();h.preventDefault(true);manageTab(c,h.shiftKey,"kolab","undo");sendKeyEventToServer("spec","TAB",null,c,a);checkToolbarState(c);Cursor.setCursor(c,"#FF0063")}}}}}function manageTab(d,a,c,f){var e=List.manageTab(d,a);if(e){if($doc("div.selAnchor#"+d).length){selectionDelete(d,c)}var b=$doc("div.cursor#"+d).parents("p.paragraphContainer");var g=b.height();$doc("div.cursor#"+d).before("&emsp;");pageRender.pageOverflow($doc("div.cursor#"+d).parents("div.page"));setParagraphLock(d,c)}}function manageBackspace(g,q,d){if($doc("div.selAnchor#"+g).length){selectionDelete(g,q,d);setParagraphLock(g,q);return true}var k=previousNodeSearch($doc("div.cursor#"+g)[0]);var a=$doc("div.cursor#"+g).parents("p.paragraphContainer");var c=a.height();var l=$doc("div.cursor#"+g).parents("div.page");if(k=="firstLine"||$(k).text().match(/\u200b/)){var m=$doc("div.cursor#"+g).parents("p.paragraphContainer");var f=$(m[0].previousSibling);if(m.hasClass("bullet")||m.hasClass("bulletLast")||m.hasClass("number")||m.hasClass("numberLast")){List.decreaseLevel(m);return true}else{if(f.hasClass("locked")&&!f.hasClass("background_kolab")){return false}}}var m;var f;if(k=="firstLine"){m=$doc("div.cursor#"+g).parents("p.paragraphContainer");f=$(m[0].previousSibling);if(!f.length){if(m.parent()[0].previousSibling){f=$(m.parent()[0].previousSibling).children(":last");if(f.attr("klb")==m.attr("klb")){var o=f.children(":last")[0].childNodes;k=o[o.length-1];l=f.parent()}}}}if($(k).text().match(/\u200b/)){$(k).remove();k=previousNodeSearch($doc("div.cursor#"+g)[0])}if(k=="firstLine"){if(f.length){if(!$(m).text().length){$(f).children(":last").append($(m).children(":first")[0].childNodes);m.remove()}else{if($(f).text().match(/\u200b/)){f.children(":first").remove()}$(f).children(":last").append($doc("div.cursor#"+g));if(f.children(":last").attr("author")==m.children(":first").attr("author")&&f.children(":last").attr("style")==m.children(":first").attr("style")){$(f).children(":last").append($(m).children(":first")[0].childNodes);$(m).children(":first").remove()}$(f).append($(m).children());$(m).remove()}var h=$doc("div.cursor#"+g).parent();var e=$(h[0].nextSibling);if(h.attr("author")==e.attr("author")&&h.attr("style")==e.attr("style")){combineSpanAuthor(h,e)}if(d=="undo"){Undo.addElement("break");Undo.addElement({action:"spec",content:"ENT",user:g,extra:$(m).attr("klb")});Undo.addElement({action:"cursor",content:($doc("div.cursor#"+g).parents("p.paragraphContainer").attr("klb")+","+evaluateCursorPosInText(g,"cursor")),user:g,extra:""})}else{if(d=="redo"){Redo.addElement("break");Redo.addElement({action:"spec",content:"ENT",user:g,extra:$(m).attr("klb")});Redo.addElement({action:"cursor",content:($doc("div.cursor#"+g).parents("p.paragraphContainer").attr("klb")+","+evaluateCursorPosInText(g,"cursor")),user:g,extra:""})}}}else{if(m.parent()[0].previousSibling){f=$(m.parent()[0].previousSibling).children(":last")}else{return false}}}else{if(d=="undo"&&d=="redo"){var n=Undo.getStyleMap(g);var b={};b.content=k.textContent.substr(k.textContent.length-1,1);b.extra=stylesZip(n[0],n[1]);b.undo=$doc("div.cursor#"+g).parents("span[author]").attr("author")}if(k.length>1){k.deleteData(k.data.length-1,1)}else{$(k).remove();if(!$doc("div.cursor#"+g)[0].previousSibling){var j=$doc("div.cursor#"+g).parent();var p=$doc("div.cursor#"+g)[0].nextSibling;if(j[0].previousSibling){$(j[0].previousSibling).append($doc("div.cursor#"+g))}else{if(j[0].nextSibling&&!p){$(j[0].nextSibling).prepend($doc("div.cursor#"+g))}else{if(!p){$doc("div.cursor#"+g).before("\u200b")}}}if(!j[0].childNodes.length){j.remove()}var h=$doc("div.cursor#"+g).parent();var e=$(h[0].nextSibling);if(h.attr("author")==e.attr("author")&&h.attr("style")==e.attr("style")){combineSpanAuthor(h,e)}}}if(d=="undo"){Undo.addElement("break");Undo.addElement({action:"add",content:b.content,user:g,extra:b.extra,undo:b.undo});Undo.addElement({action:"cursor",content:($doc("div.cursor#"+g).parents("p.paragraphContainer").attr("klb")+","+evaluateCursorPosInText(g,"cursor")),user:g,extra:""})}else{if(d=="redo"){Redo.addElement("break");Redo.addElement({action:"add",content:b.content,user:g,extra:b.extra,undo:b.undo});Redo.addElement({action:"cursor",content:($doc("div.cursor#"+g).parents("p.paragraphContainer").attr("klb")+","+evaluateCursorPosInText(g,"cursor")),user:g,extra:""})}}}pageRender.pageUnderflow(l,g,q);if(!$doc("div.cursor#"+g)[0].previousSibling&&!$doc("div.cursor#"+g).parent()[0].previousSibling){if(!$doc("div.cursor#"+g).parents("p")[0].previousSibling&&$doc("div.cursor#"+g).parents("div.page")[0].previousSibling){if($doc("div.cursor#"+g).parents("p").attr("klb")==$($doc("div.cursor#"+g).parents("div.page")[0].previousSibling).children(":last").attr("klb")){sendSpaceInPrevious($($doc("div.cursor#"+g).parents("div.page")[0].previousSibling).children(":last"),$doc("div.cursor#"+g).parents("p"),g)}}}setParagraphLock(g,q);return true}function sendSpaceInPrevious(b,f,d){if(f.children(":first").text()[0]!=" "){return}if($doc("div.cursor#"+d).parents("p.paragraphContainer").is(f)){b.children(":last").append($doc("div.cursor#"+d))}var c=b.children(":last");var a=f.children(":first");while(f.children(":first").text()[0]==" "){if(c.attr("author")!=a.attr("author")&&c.attr("style")!=a.attr("style")){b.append('<span author="'+a.attr("author")+'" style="'+a.attr("style")+'"></span>');c=b.children(":last")}c.append(" ");var e=a[0].childNodes[0];e.deleteData(0,1);if(!a.childNodes.length){a.remove()}c=b.children(":last");a=f.children(":first")}if(!f.children().length){f.remove()}}function manageDelete(j,r,d){if($doc("div.selAnchor#"+j).length){selectionDelete(j,r,d);setParagraphLock(j,r);return true}var f=nextNodeSearch($doc("div.cursor#"+j)[0]);var a=$doc("div.cursor#"+j).parents("p.paragraphContainer");var c=a.height();if(f=="lastLine"){var g=$doc("div.cursor#"+j).parents("p.paragraphContainer");var q=$(g[0].nextSibling);if(q.hasClass("locked")&&!q.hasClass("background_kolab")){return false}}var m;var q;if(f=="lastLine"){m=$doc("div.cursor#"+j).parents("p.paragraphContainer");q=$(m[0].nextSibling);if(!q.length){if(m.parent()[0].nextSibling){q=$(m.parent()[0].nextSibling).children(":first");if(q.attr("klb")==m.attr("klb")){var o=q.children(":first")[0].childNodes;f=o[0]}}}}if($(f).text().match(/\u200b/)){$(f).remove();f=nextNodeSearch($doc("div.cursor#"+j)[0])}if(f=="lastLine"){if(q.length){var b=$(q).attr("klb");if(!$(q).text().length){q.remove()}else{if($(m).text().match(/\u200b/)){if($(q).text().match(/\u200b/)){q.children(":first").append($doc("div.cursor#"+j))}else{q.children(":first").prepend($doc("div.cursor#"+j))}m.children(":first").remove()}if(m.children(":last").attr("author")==q.children(":first").attr("author")&&m.children(":last").attr("style")==q.children(":first").attr("style")){$(m).children(":last").append($(q).children(":first")[0].childNodes);$(q).children(":first").remove()}$(m).append($(q).children());$(q).remove();var k=$doc("div.cursor#"+j).parent();var e=$(k[0].nextSibling);if(k.attr("author")==e.attr("author")&&k.attr("style")==e.attr("style")){combineSpanAuthor(k,e)}}if(d=="undo"){Undo.addElement("break");Undo.addElement({action:"spec",content:"ENT",user:j,extra:b});Undo.addElement({action:"cursor",content:($doc("div.cursor#"+j).parents("p.paragraphContainer").attr("klb")+","+evaluateCursorPosInText(j,"cursor")),user:j,extra:""})}else{if(d=="redo"){Redo.addElement("break");Redo.addElement({action:"spec",content:"ENT",user:j,extra:b});Redo.addElement({action:"cursor",content:($doc("div.cursor#"+j).parents("p.paragraphContainer").attr("klb")+","+evaluateCursorPosInText(j,"cursor")),user:j,extra:""})}}}else{return false}}else{if(d=="undo"&&d=="redo"){var n=Undo.getStyleMap(j);var b={};b.content=f.textContent.substr(0,1);b.extra=stylesZip(n[0],n[1]);b.undo=$(f).parent().attr("author")}if(f.length>1){f.deleteData(0,1)}else{var h=$(f).parent();$(f).remove();var l=$doc("div.cursor#"+j).parent();var p=$doc("div.cursor#"+j)[0].previousSibling;if(!h.is(l)){h.remove()}else{if(l[0].nextSibling&&!p){$(l[0].nextSibling).prepend($doc("div.cursor#"+j))}else{if(!p){$doc("div.cursor#"+j).before("\u200b")}}}if(!l[0].childNodes.length){l.remove()}var k=$doc("div.cursor#"+j).parent();var e=$(k[0].nextSibling);if(k.attr("author")==e.attr("author")&&k.attr("style")==e.attr("style")){combineSpanAuthor(k,e)}}if(d=="undo"){Undo.addElement("break");Undo.addElement({action:"addSpec",content:b.content,user:j,extra:b.extra,undo:b.undo});Undo.addElement({action:"cursor",content:($doc("div.cursor#"+j).parents("p.paragraphContainer").attr("klb")+","+evaluateCursorPosInText(j,"cursor")),user:j,extra:""})}else{if(d=="redo"){var n=Undo.getStyleMap(j);Redo.addElement("break");Redo.addElement({action:"addSpec",content:b.content,user:j,extra:b.extra,undo:b.undo});Redo.addElement({action:"cursor",content:($doc("div.cursor#"+j).parents("p.paragraphContainer").attr("klb")+","+evaluateCursorPosInText(j,"cursor")),user:j,extra:""})}}}pageRender.pageUnderflow($doc("div.cursor#"+j).parents("div.page"),j,r);if(!$doc("div.cursor#"+j)[0].nextSibling&&!$doc("div.cursor#"+j).parent()[0].nextSibling){if(!$doc("div.cursor#"+j).parents("p")[0].nextSibling&&$doc("div.cursor#"+j).parents("div.page")[0].nextSibling){if($doc("div.cursor#"+j).parents("p").attr("klb")==$($doc("div.cursor#"+j).parents("div.page")[0].nextSibling).children(":first").attr("klb")){sendSpaceInPrevious($doc("div.cursor#"+j).parents("p"),$($doc("div.cursor#"+j).parents("div.page")[0].nextSibling).children(":first"),j)}}}else{if(!$doc("div.cursor#"+j)[0].previousSibling&&!$doc("div.cursor#"+j).parent()[0].previousSibling){if(!$doc("div.cursor#"+j).parents("p")[0].previousSibling&&$doc("div.cursor#"+j).parents("div.page")[0].previousSibling){if($doc("div.cursor#"+j).parents("p").attr("klb")==$($doc("div.cursor#"+j).parents("div.page")[0].previousSibling).children(":last").attr("klb")){sendSpaceInPrevious($($doc("div.cursor#"+j).parents("div.page")[0].previousSibling).children(":last"),$doc("div.cursor#"+j).parents("p"),j)}}}}setParagraphLock(j,r);return true}function manageEnter(d,r,g,k,p){var n=false;var b=false;if($doc("div.selAnchor#"+d).length){b=true;selectionDelete(d,g,k)}var l=$doc("div.cursor#"+d).parents("p.paragraphContainer");if(p&&(l.hasClass("bullet")||l.hasClass("bulletLast")||l.hasClass("number")||l.hasClass("numberLast"))){if(!l.text().length||l.text()=="\u200b"){List.manageChange(d);return l.attr("klb")}else{var o=l.attr("class");var q={};if(o.match(/bullet(Last)?/)){if(o.match(/bulletLast/)){q.type="bulletLast"}else{q.type="bullet"}q.listId=l.attr("listId");q.level=o.match(/(bullet\d)/)[1]}else{if(o.match(/numberLast/)){q.type="numberLast"}else{q.type="number"}q.listId=l.attr("listId");q.level=o.match(/(number\d)/)[1];q.order=parseInt(l.children("span[author]:first").attr("order"))}}}if(!r){r=klbGenerator()}var o="paragraphContainer";var j="";l.after('<p class="'+o+'" klb="'+r+'"'+j+"></div>");var f=$(l)[0].nextSibling;var h=false;$doc('p.paragraphContainer[klb="'+l.attr("klb")+'"]').each(function(){if(h){$(this).attr("klb",r)}else{if($(this).is(l)){h=true}}});$(f).css("padding-left",$(l).css("padding-left"));$(f).css("text-align",$(l).css("text-align"));if(!$doc("div.cursor#"+d)[0].nextSibling&&!$doc("div.cursor#"+d).parent()[0].nextSibling){var a;$(f).prepend('<span author="'+$doc("div.cursor#"+d).parents("span[author]").attr("author")+'" style="'+$doc("div.cursor#"+d).parents("span[style]").attr("style")+'"></span>');a=$(f).children("span[author]:first");$doc("div.cursor#"+d).remove();a.prepend("\u200b");a.append('<div class="cursor" id="'+d+'"></div>')}else{var e=$doc("div.cursor#"+d).parent();$.makeArray(e.nextAll()).reverse().forEach(function(t){$(f).prepend($(t))});if($doc("div.cursor#"+d)[0].nextSibling){$(f).prepend('<span author="'+e.attr("author")+'" style="'+e.attr("style")+'"></span>');var s=$(f).children(":first");var c=e[0].childNodes;for(var m=c.length-1;m>=0;m--){if($(c[m]).is($doc("div.cursor#"+d))){break}else{s.prepend($(c[m]))}}}s=$(f).children(":first");s.prepend($doc("div.cursor#"+d));if(!e[0].childNodes.length&&e.parent().children().length>1){e.remove()}}if(!$(l).text().length){$(l).children().prepend("\u200b")}pageRender.pageOverflow($doc("div.cursor#"+d).parents("div.page"));setParagraphLock(d,g);if(k=="undo"){if(!b){Undo.addElement("break")}Undo.addElement({action:"spec",content:"BAK",user:d,extra:""});Undo.addElement({action:"cursor",content:($doc("div.cursor#"+d).parents("p.paragraphContainer").attr("klb")+","+evaluateCursorPosInText(d,"cursor")),user:d,extra:""})}else{if(k=="redo"){if(!b){Redo.addElement("break")}Redo.addElement({action:"spec",content:"BAK",user:d,extra:""});Redo.addElement({action:"cursor",content:($doc("div.cursor#"+d).parents("p.paragraphContainer").attr("klb")+","+evaluateCursorPosInText(d,"cursor")),user:d,extra:""})}}return r}function selectionDelete(a,j,n){var o=manageCopy(a);if($($doc("div.selAnchor#"+a+",div.cursor#"+a)[0]).is("div.selAnchor#"+a)){var l=$doc("div.selAnchor#"+a)[0];var e=$doc("div.cursor#"+a)[0]}else{var l=$doc("div.cursor#"+a)[0];var e=$doc("div.selAnchor#"+a)[0]}var d={bool:false,listId:""};var t=$(e).parents("p.paragraphContainer");var g=t.next("p.paragraphContainer");if((g.hasClass("number")||g.hasClass("numberLast"))&&t.attr("listId")==g.attr("listId")){d.bool=true;d.listId=g.attr("listId")}var k=$(l).parent();var h=$(k).parent();var f=$(h).parent();var p=$(e).parent();var b=$(p).parent();var m=$(b).parent();if(!k.is(p)){k.nextAll().each(function(){if(!$(this).is($(p))){$(this).remove()}else{return false}})}while($(l)[0].nextSibling&&!$($(l)[0].nextSibling).is($(e))){$($(l)[0].nextSibling).remove()}if(!h.is(b)){h.nextAll().each(function(){if(!$(this).is($(b))){$(this).remove()}else{return false}});if(f[0]!=m[0]){b.prevAll().each(function(){$(this).remove()})}p.prevAll().each(function(){$(this).remove()});while($(e)[0].previousSibling){$($(e)[0].previousSibling).remove()}if(b.text().length>0){$(b).children().each(function(){$(this).remove().appendTo(h)})}b.remove()}else{while($(e)[0].previousSibling&&!$($(e)[0].previousSibling).is($(l))){$($(e)[0].previousSibling).remove()}}if($(l).is($doc("div.selAnchor#"+a))){$doc("div.selAnchor#"+a).after($doc("div.cursor#"+a))}$doc("div.selAnchor#"+a).remove();if(!$(h).text().length){$doc("div.cursor#"+a).before("\u200b")}var q=$doc("div.cursor#"+a).parent();var s=$(q[0].nextSibling);if(q.attr("author")==s.attr("author")&&q.attr("style")==s.attr("style")){combineSpanAuthor(q,s)}if(f[0]!=m[0]){var c=f[0].nextSibling;while(c!=m[0]){var r=c.nextSibling;$(c).remove();c=r}if(m.text().length>0){m.children().each(function(){$(this).remove().appendTo(f)})}m.remove()}if(d.bool){List.redistributeNumbers(d.listId)}if(n=="undo"){Undo.addElement("break");Undo.addElement({action:"paste",content:o,user:a,extra:klbGenerator()});Undo.addElement({action:"cursor",content:($doc("div.cursor#"+a).parents("p.paragraphContainer").attr("klb")+","+evaluateCursorPosInText(a,"cursor")),user:a,extra:""})}else{if(n=="redo"){Redo.addElement("break");Redo.addElement({action:"paste",content:o,user:a,extra:klbGenerator()});Redo.addElement({action:"cursor",content:($doc("div.cursor#"+a).parents("p.paragraphContainer").attr("klb")+","+evaluateCursorPosInText(a,"cursor")),user:a,extra:""})}}pageRender.pageUnderflow($doc("div.cursor#"+a).parents("div.page"),a,j)};function initLinkManager(c,b,a){$("#linkAdd").bind("click",function(){addLink(c,b)})}function addLink(d,c){var a=$doc("div.selAnchor#"+d).parents("p.paragraphContainer").attr("klb");var e=$doc("div.cursor#"+d).parents("p.paragraphContainer").attr("klb");var f="";if($doc("div.selAnchor#"+d).length){if(a==e){if($($doc("div.selAnchor#"+d+",div.cursor#"+d)[0]).is("div.selAnchor#"+d)){var g="selAnchor";var b="cursor"}else{var g="cursor";var b="selAnchor"}f=$doc("div.cursor#"+d).parents("p.paragraphContainer").html();f=f.replace(new RegExp('<div class="selection(Start|End)?Box" id="'+d+'".*?></div>',"g"),"");f=f.replace(new RegExp('.*?<div class="'+g+'" id="'+d+'"></div>(.*?)<div class="'+b+'" id="'+d+'"></div>.*'),"$1");f=f.replace(/<.*?>/g,"");$("#linktext").val(f)}}$("#link,#linktext,#linkInsert").removeAttr("disabled");$("#linkInsert").bind("click",function(){insertLink(d,c,f)});$("#linkAdd").attr("disabled","disabled");$("#link").focus()}function insertLink(e,j,i){if(verifyLink($("#link").val())){var f=$doc("div.selAnchor#"+e).parents("p.paragraphContainer").attr("klb");var a=$doc("div.cursor#"+e).parents("p.paragraphContainer").attr("klb");if($doc("div.selAnchor#"+e).length){console.log($("#linktext").val(),i);if(f!=a||$("#linktext").val()!=i){console.log("if",$doc("div.cursor#"+e)[0]);selectionDelete(e,j);var g=$("#linktext").val().length?$("#linktext").val():simplifyLink($("#link").val());$doc("div.cursor#"+e).before('<a id="'+klbGenerator()+'" href="'+$("#link").val()+'">'+g+"</a>")}else{console.log("else");removeLinkInSel(e);if($($doc("div.selAnchor#"+e+",div.cursor#"+e)[0]).is("div.selAnchor#"+e)){var b="selAnchor";var d="cursor"}else{var b="cursor";var d="selAnchor"}var h=$doc("div."+b+"#"+e).parent();var c=$doc("div."+d+"#"+e).parent();if(h[0]==c[0]){$($doc("div."+b+"#"+e)[0].nextSibling).wrap('<a id="'+klbGenerator()+'" href="'+$("#link").val()+'">')}else{var k=$doc("div."+b+"#"+e)[0].nextSibling;if(!k){k=h[0].childNodes[0]}$(k).wrap('<a href="'+$("#link").val()+'">');$($doc("div."+d+"#"+e)[0].previousSibling).wrap('<a id="'+klbGenerator()+'" href="'+$("#link").val()+'">');var k=h[0].nextSibling;while(k!=c[0]){$(k.childNodes[0]).wrap('<a id="'+klbGenerator()+'" href="'+$("#link").val()+'">');k=k.nextSibling}}}}else{var g=$("#linktext").val().length?$("#linktext").val():simplifyLink($("#link").val());$doc("div.cursor#"+e).before('<a id="'+klbGenerator()+'" href="'+$("#link").val()+'">'+g+"</a>")}}$("#link,#linktext").val("");$("#linkInsert").unbind("click");$("#link,#linktext,#linkInsert").attr("disabled","disabled");$("#linkAdd").removeAttr("disabled");$("iframe#r_engine")[0].contentWindow.focus()}function removeLinkInSel(d){if($($doc("div.selAnchor#"+d+",div.cursor#"+d)[0]).is("div.selAnchor#"+d)){var f="selAnchor";var c="cursor"}else{var f="cursor";var c="selAnchor"}var e=$doc("div."+f+"#"+d).parent();var b=$doc("div."+c+"#"+d).parent();if(e[0]==b[0]){var a=$doc("div."+f+"#"+d)[0].nextSibling;while(!$(a).is("div."+c+"#"+d)){if(a.nodeName=="A"){a.outerHTML=a.innerHTML}a=a.nextSibling}}else{var a=$doc("div."+f+"#"+d)[0].nextSibling;while(a){if(a.nodeName=="A"){a.outerHTML=a.innerHTML}a=a.nextSibling}a=b[0].childNodes[0];while(!$(a).is("div."+c+"#"+d)){if(a.nodeName=="A"){a.outerHTML=a.innerHTML}a=a.nextSibling}a=e[0].nextSibling;while(a!=b[0]){$(a).children("a").each(function(){this[0].outerHTML=this.html()});a=a.nextSibling}}}function simplifyLink(a){return a.replace(/^(ht|f)tps?:\/\//,"").replace(/\/.*/,"")}function removeLink(a){$("a#"+a)[0].outerHTML=$("a#"+a).html()};function initList(b,a){$("#listBtn").bind("click",function(){List.manageChange(b,"bullet")});$("#numListBtn").bind("click",function(){List.manageChange(b,"number")})}var List=(function(){function g(n,o){var p=$doc("div.cursor#"+n).parents("p.paragraphContainer");if(!p.attr("listId")){c(n,o)}else{j(n,o)}Cursor.setCursor(n,"#FF0063")}function c(s,t){if($doc("div.selAnchor#"+s).length){if($($doc("div.selAnchor#"+s+",div.cursor#"+s)[0]).is("div.selAnchor#"+s)){var q=$doc("div.selAnchor#"+s).parents("p.paragraphContainer");var p=$doc("div.cursor#"+s).parents("p.paragraphContainer")}else{var q=$doc("div.cursor#"+s).parents("p.paragraphContainer");var p=$doc("div.selAnchor#"+s).parents("p.paragraphContainer")}var r=q;var o=klbGenerator();var v=1;while(r[0]!=p[0]){r.attr("listId",o);if(t=="bullet"){r.addClass("bullet bullet1 s"+parseInt(r.children("span[author]:first").css("font-size")))}else{r.addClass("number number1");r.children("span[author]:first").attr("order",v);r.children("span[author]:first").attr("orderContent",l(v,1));v++}if(r.next("p.paragraphContainer").length){r=r.next("p.paragraphContainer")}else{r=r.parent("div.page").next("div.page").children("p.paragraphContainer:first")}}var u=r.hasClass(t);var n=r.attr("listId");p.attr("listId",o);if(t=="bullet"){p.addClass("bulletLast bullet1 s"+parseInt(r.children("span[author]:first").css("font-size")))}else{p.addClass("numberLast number1");p.children("span[author]:first").attr("order",v);p.children("span[author]:first").attr("orderContent",l(v,1));v++}}else{var r=$doc("div.cursor#"+s).parents("p.paragraphContainer");var o=klbGenerator();var u=r.hasClass(t);var n=r.attr("listId");r.attr("listId",o);if(t=="bullet"){r.addClass("bullet bullet1 s"+parseInt(r.children("span[author]:first").css("font-size")))}else{r.addClass("number number1");r.children("span[author]:first").attr("order",v);r.children("span[author]:first").attr("orderContent",l(v,1));v++}}if(u){if(r.next("p.paragraphContainer").length){r=r.next("p.paragraphContainer")}else{r=r.parent("div.page").next("div.page").children("p.paragraphContainer:first")}o=klbGenerator();while((r.hasClass(t)||r.hasClass(t+"Last"))&&n==r.attr("listId")){r.attr("listId",o);if(r.next("p.paragraphContainer").length){r=r.next("p.paragraphContainer")}else{r=r.parent("div.page").next("div.page").children("p.paragraphContainer:first")}}if(t=="number"){m(o)}}}function j(s,t){if($doc("div.selAnchor#"+s).length){if($($doc("div.selAnchor#"+s+",div.cursor#"+s)[0]).is("div.selAnchor#"+s)){var q=$doc("div.selAnchor#"+s).parents("p.paragraphContainer");var p=$doc("div.cursor#"+s).parents("p.paragraphContainer")}else{var q=$doc("div.cursor#"+s).parents("p.paragraphContainer");var p=$doc("div.selAnchor#"+s).parents("p.paragraphContainer")}var r=q;while(r[0]!=p[0]){r.removeAttr("listId");if(t=="bullet"){r.removeClass("bullet bulletLast bullet1 bullet2 bullet3 bullet4 bullet5 bullet6 s"+parseInt(r.children("span[author]:first").css("font-size")))}else{r.removeClass("number numberLast number1 number2 number3 number4 number5 number6");r.children("span[author]:first").removeAttr("order");r.children("span[author]:first").removeAttr("orderContent")}if(r.next("p.paragraphContainer").length){r=r.next("p.paragraphContainer")}else{r=r.parent("div.page").next("div.page").children("p.paragraphContainer:first")}}var u=r.hasClass(t);var o=r.attr("listId");p.removeAttr("listId");if(t=="bullet"){p.removeClass("bullet bulletLast bullet1 bullet2 bullet3 bullet4 bullet5 bullet6 s"+parseInt(r.children("span[author]:first").css("font-size")))}else{p.removeClass("number numberLast number1 number2 number3 number4 number5 number6");p.children("span[author]:first").removeAttr("order");p.children("span[author]:first").removeAttr("orderContent")}}else{var q=$doc("div.cursor#"+s).parents("p.paragraphContainer");var r=q;var u=r.hasClass(t);var o=r.attr("listId");r.removeAttr("listId");if(t=="bullet"){r.removeClass("bullet bulletLast bullet1 bullet2 bullet3 bullet4 bullet5 bullet6 s"+parseInt(r.children("span[author]:first").css("font-size")))}else{r.removeClass("number numberLast number1 number2 number3 number4 number5 number6");r.children("span[author]:first").removeAttr("order");r.children("span[author]:first").removeAttr("orderContent")}}if(q.prev("p.paragraphContainer").length){var v=q.prev("p.paragraphContainer")}else{if(q.prev("div.page")){var v=q.parent("div.page").prev("div.page").children("p.paragraphContainer:last")}}if(v.length&&v.hasClass(t)){v.removeClass(t);v.addClass(t+"Last")}var n=klbGenerator();if(u){if(r.next("p.paragraphContainer").length){r=r.next("p.paragraphContainer")}else{r=r.parent("div.page").next("div.page").children("p.paragraphContainer:first")}n=klbGenerator();while((r.hasClass(t)||r.hasClass(t+"Last"))){r.attr("listId",n);if(r.next("p.paragraphContainer").length){r=r.next("p.paragraphContainer")}else{r=r.parent("div.page").next("div.page").children("p.paragraphContainer:first")}}console.log("bob");if(t=="number"){console.log("bob2");m(n)}}}function f(q){var n=q.attr("class");var p;var o;n=n.replace(/(bullet|number)(\d)/,function(u,s,r){p=r;o=s;p=parseInt(p);if(p<6){p++}return o+p});q.attr("class",n);if(o=="number"){m(q.attr("listId"))}}function b(s){var t=false;var n;var v;var p=s.attr("class");p=p.replace(/(bullet|number)(\d)/,function(z,y,x){n=x;v=y;n=parseInt(n);if(n==1){t=true}else{n--}return v+n});console.log(t);if(t){s.removeAttr("listId");if(v=="bullet"){s.removeClass("bullet bulletLast bullet1 bullet2 bullet3 bullet4 bullet5 bullet6 s"+parseInt(r.children("span[author]:first").css("font-size")))}else{s.removeClass("number numberLast number1 number2 number3 number4 number5 number6");s.children("span[author]:first").removeAttr("order");s.children("span[author]:first").removeAttr("orderContent")}if(s.prev("p.paragraphContainer").length){var w=s.prev("p.paragraphContainer")}else{var w=s.parent("div.page").prev("div.page").children("p.paragraphContainer:last")}if(w.length&&w.hasClass("bullet")){w.removeClass("bullet");w.addClass("bulletLast")}if(s.next("p.paragraphContainer").length){var r=s.next("p.paragraphContainer")}else{var r=s.parent("div.page").next("div.page").children("p.paragraphContainer:first")}var o=klbGenerator();while(r.length&&(r.hasClass("bullet")||r.hasClass("bulletLast"))){r.attr("listId",o);if(r.next("p.paragraphContainer").length){r=r.next("p.paragraphContainer")}else{r=r.parent("div.page").next("div.page").children("p.paragraphContainer:first")}}if(v=="number"){m(o)}}else{s.attr("class",p);if(v=="number"){var q=1;var u=s.prevAll("p.number"+n).last();if(u&&u.attr("listId")==s.attr("listId")){q=(parseInt(u.children("span[author:first").attr("order"))+1)}s.children("span[author]:first").attr("order",q);s.children("span[author]:first").attr("orderContent",l(q,n))}if(v=="number"){m(s.attr("listId"))}}}function d(o){if(o.hasClass("bullet")||o.hasClass("bulletLast")){var n=o.children("span[author]:first").css("font-size");o.attr("class",o.attr("class").replace(/s\d{1,2}/,"s"+parseInt(n)))}}function l(n,o){console.log(n);switch(o){case 1:return(n+".");break;case 2:return(h(n)+".");break;case 3:return(e(n)+".");break;case 4:return(n+")");break;case 5:return(h(n)+")");break;case 6:return(e(n)+")");break}}function h(q){var p="",o;while(q>0){o=(q-1)%26;p="abcdefghijklmnopqrstuvwxyz"[o]+p;q=Math.floor((q-o)/26)}return p}function e(n){if(!+n){return false}var q=String(+n).split(""),p=["","c","cc","ccc","cd","d","dc","dcc","dccc","cm","","x","xx","xxx","xl","l","lx","lxx","lxxx","xc","","i","ii","iii","iv","v","vi","vii","viii","ix"],r="",o=3;while(o--){r=(p[+q.pop()+(o*10)]||"")+r}return Array(+q.join("")+1).join("m")+r}function m(n){console.log(n);var o=[];for(i=0;i<6;i++){o.push(1)}$doc('p[listId="'+n+'"]').each(function(){console.log(o);if($(this).attr("class").match(/number1/)){for(i=1;i<o.length;i++){o[i]=1}$(this).children("span[author]:first").attr("order",o[0]);$(this).children("span[author]:first").attr("orderContent",l(o[0],1));o[0]++}else{if($(this).attr("class").match(/number2/)){for(i=2;i<o.length;i++){o[i]=1}$(this).children("span[author]:first").attr("order",o[1]);$(this).children("span[author]:first").attr("orderContent",l(o[1],2));o[1]++}else{if($(this).attr("class").match(/number3/)){for(i=3;i<o.length;i++){o[i]=1}$(this).children("span[author]:first").attr("order",o[2]);$(this).children("span[author]:first").attr("orderContent",l(o[2],3));o[2]++}else{if($(this).attr("class").match(/number4/)){for(i=4;i<o.length;i++){o[i]=1}$(this).children("span[author]:first").attr("order",o[3]);$(this).children("span[author]:first").attr("orderContent",l(o[3],4));o[3]++}else{if($(this).attr("class").match(/number5/)){for(i=5;i<o.length;i++){o[i]=1}$(this).children("span[author]:first").attr("order",o[4]);$(this).children("span[author]:first").attr("orderContent",l(o[4],5));o[4]++}else{if($(this).attr("class").match(/number6/)){$(this).children("span[author]:first").attr("order",o[5]);$(this).children("span[author]:first").attr("orderContent",l(o[5],6));o[5]++}}}}}}})}function k(p,o){if(o.type=="bullet"||o.type=="bulletLast"){if(o.type=="bulletLast"){var n=p.prev("p.paragraphContainer");n.removeClass("bulletLast");n.addClass("bullet")}p.addClass(o.type+" "+o.level+" s16");p.attr("listId",o.listId);d(p)}else{if(o.type=="numberLast"){var n=p.prev("p.paragraphContainer");n.removeClass("numberLast");n.addClass("number")}p.addClass(o.type+" "+o.level);p.children("span[author]:first").attr("order",o.order);p.children("span[author]:first").attr("orderContent",l(o.order))}if(o.type=="number"){m(o.listId)}}function a(p,n){var s=true;if($doc("div.selAnchor#"+p).length){if($($doc("div.selAnchor#"+p+",div.cursor#"+p)[0]).is("div.selAnchor#"+p)){var q=$doc("div.selAnchor#"+p).parents("p.paragraphContainer");var o=$doc("div.cursor#"+p).parents("p.paragraphContainer")}else{var q=$doc("div.cursor#"+p).parents("p.paragraphContainer");var o=$doc("div.selAnchor#"+p).parents("p.paragraphContainer")}var r=q;while(r[0]!=o[0]){if(r.hasClass("bullet")||r.hasClass("bulletLast")||r.hasClass("number")||r.hasClass("numberLast")){if(n){b(r)}else{f(r)}s=false}if(r.next("p.paragraphContainer").length){r=r.next("p.paragraphContainer")}else{r=r.parent("div.page").next("div.page").children("p.paragraphContainer:first")}}if(o.hasClass("bullet")||o.hasClass("bulletLast")||o.hasClass("number")||o.hasClass("numberLast")){if(n){b(o)}else{f(o)}s=false}}else{var t=$doc("div.cursor#"+p).parents("p.paragraphContainer");if(t.hasClass("bullet")||t.hasClass("bulletLast")||t.hasClass("number")||t.hasClass("numberLast")){if(n){b(t)}else{f(t)}s=false}}return s}return{manageChange:g,increaseLevel:f,decreaseLevel:b,changeSize:d,redistributeNumbers:m,manageEnter:k}})();var pageRender=(function(){var e=100;var d="font-family:arial,helvetica,sans-serif;font-size:16px;background-color:transparent;font-weight:normal;font-style:normal;text-decoration:none;";function g(l,k){$("#newPage").bind("click",function(){var m=klbGenerator();a(l,"kolab",m);sendPageEvent("NEW",m,l,k);checkToolbarState(l);Cursor.setCursor(l,"#FF0063")});$("#pageBreak").bind("click",function(){var m=klbGenerator();j(l,"kolab",m);sendPageEvent("BRK",m,l,k);checkToolbarState(l);Cursor.setCursor(l,"#FF0063")})}function i(r){var s=false;while($(r).height()>e){s=true;var q=$(r[0].nextSibling);var k=r.children(":last");var m;if(!q.length||!q.hasClass("page")){r.after('<div class="page"></div>');q=$(r[0].nextSibling)}var n=$(r).position().top+e;var p=k.position().top;if(p>=n){if(q.children(":first").attr("klb")==k.attr("klb")){m=q.children(":first");var o=m.children(":first");var l=k.children(":last");if(o.attr("author")==l.attr("author")&&o.attr("style")==l.attr("style")){o.prepend(l[0].childNodes);l.remove();mergeAllNode($.makeArray($(o)[0].childNodes))}m.prepend(k.children());k.remove()}else{q.prepend(k)}}else{if(q.children(":first").attr("klb")!=k.attr("klb")){q.prepend('<p class="paragraphContainer" klb="'+k.attr("klb")+'"></p>');m=q.children(":first");$(m).css("padding-left",$(k).css("padding-left"));$(m).css("text-align",$(k).css("text-align"))}m=q.children(":first");h(k,m)}}if(s){i($(r[0].nextSibling))}}function h(k,n){var m=$("iframe#r_engine").contents()[0].getSelection();m.removeAllRanges();var l;var p;var o;var s;if(!k.text().match(/ /)){s=childAtPos(k,k.text().length-1)}else{if(k.text()==" "){s=childAtPos(k,k.text().length-1)}else{p=k.text().match(/\S+\s*$/)[0];o=k.text().length-p.length;s=childAtPos(k,o)}}var r;if(!s[0]){var q=k.children(":last")[0].childNodes;r=q[0]}else{if(s[0].length==s[1]){r=nextNodeSearch(s[0])}else{if(s[1]==0){r=s[0]}else{r=s[0].splitText(s[1])}}}l=$(r).parent();if(!k.children(":last").is(l)){if(k.children(":last").attr("author")==n.children(":first").attr("author")&&k.children(":last").attr("style")==n.children(":first").attr("style")){n.children(":first").prepend(k.children(":last")[0].childNodes);k.children(":last").remove();mergeAllNode($.makeArray($(n.children(":first"))[0].childNodes))}$.makeArray(l.nextAll()).reverse().forEach(function(u){n.prepend($(u))})}if(!(k.children(":last").attr("author")==n.children(":first").attr("author")&&k.children(":last").attr("style")==n.children(":first").attr("style"))){n.prepend('<span author="'+l.attr("author")+'" style="'+l.attr("style")+'"></span>')}var t=l[0].childNodes;while(!$(t[t.length-1]).is($(r))){n.children(":first").prepend(t[t.length-1])}n.children(":first").prepend(r);mergeAllNode($.makeArray($(n.children(":first"))[0].childNodes));if(!l[0].childNodes.length){l.remove()}if(!k[0].childNodes.length){k.remove()}}function c(o,q){var m=q.text().match(/^\S+\s*/)[0];var n=m.length;var l=childAtPos(q,n);var p;if(l[1]!=0&&l[1]!=l[0].length){var k=l[0].splitText(l[1]);p=$(k)[0].previousSibling}else{p=l[0]}$.makeArray($(p).parent().prevAll()).reverse().forEach(function(r){if(o.children(":last").attr("author")!=$(r).attr("author")||o.children(":last").attr("style")!=$(r).attr("style")){o.append('<span author="'+$(r).attr("author")+'" style="'+$(r).attr("style")+'"></span>')}o.children(":last").append($(r)[0].childNodes);$(r).remove()});if(o.children(":last").attr("author")!=q.children(":first").attr("author")||o.children(":last").attr("style")!=q.children(":first").attr("style")){o.append('<span author="'+q.children(":first").attr("author")+'" style="'+q.children(":first").attr("style")+'"></span>')}while(!$(q.children(":first")[0].childNodes[0]).is($(p))){o.children(":last").append(q.children(":first")[0].childNodes[0])}o.children(":last").append(q.children(":first")[0].childNodes[0]);mergeAllNode($.makeArray($(o.children(":last"))[0].childNodes));if(!q.children(":first")[0].childNodes.length){q.children(":first").remove()}if(!q[0].childNodes.length){q.remove()}return true}function b(n){var o=$doc("div.cursor#"+n).parents("div.page");var k=$($(o)[0].previousSibling);var m=$doc("div.cursor#"+n).parents("p.paragraphContainer").children();if(!k||$doc("div.cursor#"+n).parents("p.paragraphContainer")[0].previousSibling){return false}else{if(k.children(":last").attr("klb")!=o.children(":first").attr("klb")){return false}}var l=false;m.each(function(){var q=$(this.childNodes[0]).text().match(/ +/);if(q){if(q[0].length==1){var p=$(this.childNodes[0]).text();if((p.search(/ +/)+1)==p.length&&$($(this.childNodes[0])[0].nextSibling).is($doc("div.cursor#"+n))){l=true}}return false}else{return true}});return l}function f(n,m,l){var k=$(n[0].nextSibling);var q=false;if(!k.length||!k.hasClass("page")){return}var r=k.children(":first");var p=n.children(":last");var o=p.position().top+p.height()-n.position().top;if(e-o>r.height()){q=true;if(p.attr("klb")==r.attr("klb")){if(p.children(":last").attr("author")==r.children(":first").attr("author")&&p.children(":last").attr("style")==r.children(":first").attr("style")){p.children(":last").append(r.children(":first")[0].childNodes);r.children(":first").remove()}p.append(r.children());r.remove()}else{n.append(r)}}else{if(p.attr("klb")!=r.attr("klb")){n.append('<p class="paragraphContainer" klb="'+r.attr("klb")+'"></p>');p=n.children(":last");p.append('<span author="'+r.children(":first").attr("author")+'" style="'+r.children(":first").attr("style")+'"></span>')}if(c(p,r)){q=true}}if(!k[0].childNodes.length){k.remove()}if(q&&n[0].nextSibling&&$(n[0].nextSibling)[0].nextSibling){f($(n[0].nextSibling),m,l)}pageRender.pageOverflow(n)}function a(m,l,k){$doc("div.cursor#"+m).remove();$doc("div.selAnchor#"+m).remove();$doc().children("div.page:last").after('<div class="page"><p class="paragraphContainer" klb="'+k+'" ><span author="'+m+'" style="'+d+'"></span></p></div>');$doc().children("div.page:last").children(":first").children(":first").append('<div class="cursor" id="'+m+'"></div>');$doc().children("div.page:last").before('<div class="pageBreak" ></div>');$doc("div.cursor#"+m).before("\u200b");$("iframe#r_engine")[0].contentWindow.focus();setParagraphLock(m,l)}function j(n,u,m){var o=$($doc("div.cursor#"+n).parents("div.page")[0].nextSibling);if(!o.length||!o.hasClass("page")){$doc("div.cursor#"+n).parents("div.page").after('<div class="page"></div>');o=$($doc("div.cursor#"+n).parents("div.page")[0].nextSibling)}var k=$doc("div.cursor#"+n).parent();var s=k.parent();var r=s.parent();var t;var q;var p;if(o.children(":first").length&&o.children(":first").attr("klb")==r.children(":last").attr("klb")){if(r.children(":last").text().match(/\u200b/)&&!s.is(r.children(":last"))){r.children(":last").remove()}else{if(!s.is(r.children(":last"))){q=r.children(":last").children(":last");p=o.children(":first").children(":first");if(q.attr("author")==p.attr("author")&&q.attr("style")==p.attr("style")){p.prepend(q[0].childNodes);q.remove()}o.children(":first").prepend(r.children(":last").children());r.children(":last").remove()}}}$.makeArray(s.nextAll()).reverse().forEach(function(v){$(o).prepend($(v))});if(!(o.children(":first").length&&o.children(":first").attr("klb")==r.children(":last").attr("klb"))){$(o).prepend('<p class="paragraphContainer" klb="'+m+'"></p>')}t=o.children(":first");$(t).css("padding-left",$(s).css("padding-left"));$(t).css("text-align",$(s).css("text-align"));t.attr("klb",m);q=s.children(":last");p=t.children(":first");if(!q.is(k)&&q.attr("author")==p.attr("author")&&q.attr("style")==p.attr("style")){p.prepend(q[0].childNodes);q.remove()}$.makeArray(k.nextAll()).reverse().forEach(function(v){$(t).prepend($(v))});var l=t.children(":first");if(!(k.attr("author")==l.attr("author")&&k.attr("style")==l.attr("style"))){$(t).prepend('<span author="'+k.attr("author")+'" style="'+k.attr("style")+'"></span>');l=$(t).children(":first")}while($doc("div.cursor#"+n)[0].nextSibling){$(l).append($doc("div.cursor#"+n)[0].nextSibling)}$(l).prepend($doc("div.cursor#"+n));o.before('<div class="pageBreak" ></div>');if(k.parent().is(r.children(":first"))&&!k[0].childNodes.length&&s[0].childNodes.length==1){k.append("\u200b")}if(!k[0].childNodes.length){k.remove()}if(!s[0].childNodes.length){s.remove()}i(o);$("iframe#r_engine")[0].contentWindow.focus();setParagraphLock(n,u)}return{pageOverflow:i,pageUnderflow:f,newPage:a,pageBreak:j,initializePageControl:g,verifyIfUnderflow:b}})();function lockParagraph(c,b,a){$doc('p[klb="'+c+'"]').each(function(){$(this).addClass("locked")});$doc('p[klb="'+c+'"]').each(function(){$(this).addClass("background_"+a)})}function unlockParagraph(c,b){$doc('p[klb="'+c+'"]').each(function(){$(this).removeClass("locked")});var a=$doc('p[klb="'+c+'"]').attr("class").split(" ").reduce(function(d,g){if(g.match(/^background/)){return g}else{return d}},"");$doc('p[klb="'+c+'"]').removeClass(a);$doc('p[klb="'+c+'"]').each(function(){$(this).removeClass(a)})}function verifySingleLockedParagraph(c,b,a){if($doc('p[klb="'+c+'"]').hasClass("locked")&&!$doc('p[klb="'+c+'"]').hasClass("background_"+a)){return true}else{return false}}function searchLockedParagraph(f,c,a,b){var g=null;var d=null;if(a){g=f;d=c}else{g=c;d=f}if(g.hasClass("locked")&&!g.hasClass("background_"+b)){return true}else{if(d.hasClass("locked")&&!d.hasClass("background_"+b)){return true}else{if(!$(g).is(d)){var e=false;$(g).nextAll().each(function(){if($(this).hasClass("locked")&&!$(this).hasClass("background_"+b)){e=true;return false}if($(this).is(d)){return false}});return e}else{return false}}}}function setParagraphLock(d,b){var f=$doc("div.page").children().filter(function(){return($(this).hasClass("background_"+b))});f.removeClass("locked");f.removeClass("background_"+b);if(!$doc("div.selAnchor#"+d).length){lockParagraph($doc("div.cursor#"+d).parents("p.paragraphContainer").attr("klb"),d,b);return}if($($doc("div.selAnchor#"+d+",div.cursor#"+d)[0]).is("div.selAnchor#"+d)){var e=$doc("div.selAnchor#"+d).parents("p.paragraphContainer");var a=$doc("div.cursor#"+d).parents("p.paragraphContainer")}else{var e=$doc("div.cursor#"+d).parents("p.paragraphContainer");var a=$doc("div.selAnchor#"+d).parents("p.paragraphContainer")}var c=e;while(c.length&&c.attr("klb")!=a.attr("klb")){lockParagraph(c.attr("klb"),d,b);if(!$(c[0].nextSibling).length&&$(c.parents("div.page")[0].nextSibling).length){c=$(c.parents("div.page")[0].nextSibling).children(":first")}else{c=$(c[0].nextSibling)}}lockParagraph(a.attr("klb"),d,b)};var RosendaClipboard=(function(){var c="";function a(){return c}function b(d){c=d}return{getData:a,setData:b}})();var KolabInReal={};var color=["green","blue"];function load(c){var b="";if(c.length){b="/kolabEditor/"}$("iframe#r_engine").contents().children("html").children("head").append('<link rel="stylesheet" type="text/css" href="'+c+'css/rosendoc.css" />');$("iframe#r_engine").contents().children("html").children("head").append('<link rel="stylesheet" type="text/css" href="'+c+'css/list.css" />');klbGenerator=klbGeneratorGenerator(5,"klb");kolabID=klbGenerator();var d="green";var a=initMsgManager(kolabID,d);init("",kolabID);$("div#myUserColor").css("background-color",d);BrowserDetect.init();initKeyController(kolabID,a);initStylingManager(kolabID,a,b);initSelectionController(kolabID,a);initPasteManager(kolabID,d,a);initUndoRedoManager(kolabID,a);initLinkManager(kolabID,d,a);initImageManager(kolabID,d,a);initVideoManager(kolabID,d,a);initList(kolabID,a);initExports(b);pageRender.initializePageControl(kolabID,a);KolabInReal.currentSquareMembers=[];KolabInReal.authorOrder=[];$("iframe#r_engine")[0].contentWindow.focus();manageUpdateUserInfo(kolabID,{user:kolabID,content:d})}function init(e){console.log("TODO : init the client document");$doc().attr("contentEditable",true);$doc().attr("spellcheck",false);var b="font-family:arial,helvetica,sans-serif;font-size:16px;background-color:transparent;font-weight:normal;font-style:normal;text-decoration:none;";var g='<span author="rosendaEditor" style="'+b+'">Welcom the newWelcome to the new rosenda_engine editor on chrome</span>';var a='<span author="rosendaEditor" style="'+b+'">123456789 dsfkjhdsfkjh sdfkjdshfkjh sdfkjdshfkh</span>';var f='<span author="'+e+'1" style="'+b+'">\u200b</span>';var d='<span author="'+e+'1" style="'+b+'"><img src="https://pbs.twimg.com/profile_images/604644048/sign051.gif" height="200" width="200"></span>';var c='<span author="'+e+'2" style="'+b+'"> </span>';$doc().append('<div class="page" id="page1"></div>');$doc().children().append('<p class="paragraphContainer" klb="initialKlb">'+g+"</p>");$doc().children().append('<p class="paragraphContainer" klb="initialKlb3">'+g+"</p>");$doc().children().append('<p class="paragraphContainer" klb="initialKlb4">'+c+"</p>");$doc().append('<div class="page" id="page2"></div>');$doc().children(":last").append('<p class="paragraphContainer" klb="initialKlb5">'+a+"</p>")}function initClientDocument(c){$doc().append('<div class="page"></div>');var b=$doc().children(":first");for(var a=0;a<c.length;a++){if(c[a]=="pageBreak"){b.after('<div class="pageBreak"></div>');b.after('<div class="page"></div>');b=$(b[0].nextSibling.nextSibling)}else{b.append(c[a]);pageRender.pageOverflow(b);b=$doc().children(":last")}}}function initUsersPosition(d,f){for(var c=0;c<f.length;c++){var g=f[c].pos;var e=f[c].klb;var b=f[c].apos?f[c].apos:null;var a=f[c].aklb?f[c].aklb:null;manageCursorChangeEvent(f[c].userColor,f[c].id,e,g,a,b);Cursor.setCursor(f[c].user,f[c].color);manageUpdateUserInfo(d,{user:f[c].user,content:f[c].color})}};var BrowserDetect={init:function(){this.browser=this.searchString(this.dataBrowser)||"An unknown browser";this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version";this.OS=this.searchString(this.dataOS)||"an unknown OS"},searchString:function(d){for(var a=0;a<d.length;a++){var b=d[a].string;var c=d[a].prop;this.versionSearchString=d[a].versionSearch||d[a].identity;if(b){if(b.indexOf(d[a].subString)!=-1){return d[a].identity}}else{if(c){return d[a].identity}}}},searchVersion:function(b){var a=b.indexOf(this.versionSearchString);if(a==-1){return}return parseFloat(b.substring(a+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};var eventCheck;function initSelectionController(b,a){$("iframe#r_engine").contents().bind("selectionchange",function(c){onSelectionChange(b,a,c)});$("iframe#r_engine").contents().bind("mousedown",function(c){$doc("div.selAnchor#"+b).remove()});$("iframe#r_engine").contents().bind("mouseup",function(c){});$("iframe#r_engine").contents().on("drag",function(d){var c=$("iframe#r_engine").contents()[0].getSelection();c.removeAllRanges();$doc("div.cursor#"+b).remove();d.preventDefault(true)});$("iframe#r_engine").contents().on("drop",function(d){var c=$("iframe#r_engine").contents()[0].getSelection();c.removeAllRanges();d.preventDefault(true)})}function handleDeniedParagraph(b,a){$doc("div.cursor#"+b).remove();$doc("div.selAnchor#"+b).remove();var c=$doc("div.page").children().filter(function(){return($(this).hasClass("background_"+a))});c.removeClass("locked");c.removeClass("background_"+a)}function onSelectionChange(c,a,f){var d=$("iframe#r_engine").contents()[0].getSelection();if(!d.focusNode){return}if(manageSelectionChange(d,c,"kolab","undo")){$("#link,#linktext").val("");$("#linkInsert").unbind("click");$("#link,#linktext,#linkInsert").attr("disabled","disabled");var g=evaluateCursorPosInText(c,"cursor");if($doc("div.selAnchor#"+c).length){var b=evaluateCursorPosInText(c,"selAnchor");sendPositionChangeEventToServer(g,$doc("div.cursor#"+c).parents("p.paragraphContainer").attr("klb"),b,$doc("div.selAnchor#"+c).parents("p.paragraphContainer").attr("klb"),c,a)}else{sendPositionChangeEventToServer(g,$doc("div.cursor#"+c).parents("p.paragraphContainer").attr("klb"),null,null,c,a)}checkToolbarState(c);Cursor.setCursor(c,"#FF0063")}}function manageSelectionChange(b,h,o,c){if(!b.isCollapsed){var g=$doc("div.cursor#"+h).parent();if(!b.custom){if(b.focusNode.length==b.focusOffset){if($(previousNodeSearch($doc("div.cursor#"+h)[0])).is(b.focusNode)){return false}}else{if(b.focusOffset==0){if($(nextNodeSearch($doc("div.cursor#"+h)[0])).is(b.focusNode)){return false}}}}var f=b.focusNode;var m=b.focusOffset;var l=null;var i=$(b.focusNode).parents("p.paragraphContainer").attr("klb");var j=$(b.baseNode).parents("p.paragraphContainer").attr("klb");var a=verifySingleLockedParagraph(j,h,o);if(j==i&&a){if(!b.custom){b.removeAllRanges()}return false}if(!$doc("div.selAnchor#"+h).length){if(!a){var n=$doc("div.selAnchor#"+h).parents("span[style]");l=placeSelectionNode(b.anchorNode,b.anchorOffset,"selAnchor",h);if(l){f=l}if(n.length){mergeAllNode($.makeArray($(n)[0].childNodes))}}else{return false}}var d=$($doc('p.paragraphContainer[klb="'+j+'"],p.paragraphContainer[klb="'+i+'"]')[0]).is($doc('p.paragraphContainer[klb="'+j+'"]'));var e=searchLockedParagraph($doc('p.paragraphContainer[klb="'+j+'"]'),$doc('p.paragraphContainer[klb="'+i+'"]'),d,o);if(e){var k=$doc("div.cursor#"+h).parents("p.paragraphContainer");if(d){$(k).children(":last").append($doc("div.cursor#"+h))}else{$(k).children(":first").prepend($doc("div.cursor#"+h))}}else{placeSelectionNode(f,m,"cursor",h)}if(g.length){mergeAllNode($.makeArray($(g)[0].childNodes))}setParagraphLock(h,o)}else{if($doc("div.selAnchor#"+h).length){return false}if(verifySingleLockedParagraph($(b.focusNode).parents("p.paragraphContainer").attr("klb"),h,o)){if(!b.custom){b.removeAllRanges()}return false}if($doc("div.cursor#"+h).length){if(b.focusNode.length==b.focusOffset){if($(previousNodeSearch($doc("div.cursor#"+h)[0])).is(b.focusNode)){return false}}else{if(b.focusOffset==0){if($(nextNodeSearch($doc("div.cursor#"+h)[0])).is(b.focusNode)){return false}}}}var g=$doc("div.cursor#"+h).parent();placeSelectionNode(b.focusNode,b.focusOffset,"cursor",h);if(g.length){mergeAllNode($.makeArray($(g)[0].childNodes))}setParagraphLock(h,o)}return true}function placeSelectionNode(g,f,a,e){var b=null;if(g.nodeType==3){$doc("div."+a+"#"+e).remove();if(f==g.textContent.length){$(g).after('<div class="'+a+'" id="'+e+'"></div>')}else{if(f==0){var d=previousNodeSearch(g);if(d=="firstLine"){$(g).before('<div class="'+a+'" id="'+e+'"></div>')}else{$(d).after('<div class="'+a+'" id="'+e+'"></div>')}}else{var c=g.splitText(f);$(c).before('<div class="'+a+'" id="'+e+'"></div>');if($doc("div.cursor#"+e)[0]){b=$doc("div.cursor#"+e)[0].nextSibling}}}}else{if(g.nodeType==1){if(!$(g).is("div.cursor")&&!$(g).is("div.selAnchor")){$doc("div."+a+"#"+e).remove();if($(g).is("p.paragraphContainer")){$(g).children(":first").prepend('<div class="'+a+'" id="'+e+'"></div>')}else{if($(g).is("span[author]")){$(g).prepend('<div class="'+a+'" id="'+e+'"></div>')}}}}}return b}function setSelectionBox(f,l){var c=0.5;$doc("div.selectionEndBox#"+f).remove();$doc("div.selectionStartBox#"+f).remove();$doc("div.selectionBox#"+f).remove();if(!$doc("div.selAnchor#"+f).length){return}if($($doc("div.selAnchor#"+f+",div.cursor#"+f)[0]).is("div.selAnchor#"+f)){var k=$doc("div.selAnchor#"+f)[0];var m=$doc("div.cursor#"+f)[0]}else{var k=$doc("div.cursor#"+f)[0];var m=$doc("div.selAnchor#"+f)[0]}var i=$doc("div.cursor#"+f).parents("p");var g=$doc("div.selAnchor#"+f).parents("p");if(i.attr("klb")==g.attr("klb")&&i.parent().is(g.parent())){if($doc("div.cursor#"+f).position().top==$doc("div.selAnchor#"+f).position().top){var a=$(m).position().left-$(k).position().left;if(!$(k).children().length){$(k).append('<div class="selectionStartBox" id="'+f+'" ></div>')}$(k).children("div.selectionStartBox#"+f).width(a);$(k).children("div.selectionStartBox#"+f).height($(k).height());$(k).children("div.selectionStartBox#"+f).css("background-color",l);$(k).children("div.selectionStartBox#"+f).css("top",$(k).position().top);$(k).children("div.selectionStartBox#"+f).css("opacity",c);return}else{var b=650-$(k).position().left;var e=$(m).position().left;var d=parseInt($(k).height());var j=parseInt($(m).height());if(!$(k).children("div.selectionStartBox").length){$(k).append('<div class="selectionStartBox" id="'+f+'" ></div>')}if(!$(m).children("div.selectionEndBox").length){$(m).append('<div class="selectionEndBox" id="'+f+'" ></div>')}$(k).children("div.selectionStartBox#"+f).width(b);$(k).children("div.selectionStartBox#"+f).height(d);$(k).children("div.selectionStartBox#"+f).css("background-color",l);$(k).children("div.selectionStartBox#"+f).css("top",$(k).position().top);$(k).children("div.selectionStartBox#"+f).css("opacity",c);$(m).children("div.selectionEndBox#"+f).width(e+1);$(m).children("div.selectionEndBox#"+f).height(j);$(m).children("div.selectionEndBox#"+f).css("background-color",l);$(m).children("div.selectionEndBox#"+f).css("top",$(m).position().top);$(m).children("div.selectionEndBox#"+f).css("opacity",c);$(m).children().css("left",0);if(d+$(k).position().top<$(m).position().top){if(!$(k).children("div.selectionBox").length){$(k).append('<div class="selectionBox" id="'+f+'" ></div>')}var h=$(m).position().top-(d+$(k).position().top);$(k).children("div.selectionBox#"+f).width(650);$(k).children("div.selectionBox#"+f).height(h);$(k).children("div.selectionBox#"+f).css("background-color",l);$(k).children("div.selectionBox#"+f).css("opacity",c);$(k).children("div.selectionBox#"+f).css("top",d+$(k).position().top);$(k).children("div.selectionBox#"+f).css("left",0)}else{$doc("div.selectionBox").remove()}}}else{var b=650-$(k).position().left;var e=$(m).position().left;var d=parseInt($(k).height());var j=parseInt($(m).height());if(!$(k).children("div.selectionStartBox").length){$(k).append('<div class="selectionStartBox" id="'+f+'" ></div>')}if(!$(m).children("div.selectionEndBox").length){$(m).append('<div class="selectionEndBox" id="'+f+'" ></div>')}$(k).children("div.selectionStartBox#"+f).width(b);$(k).children("div.selectionStartBox#"+f).height(d);$(k).children("div.selectionStartBox#"+f).css("background-color",l);$(k).children("div.selectionStartBox#"+f).css("top",$(k).position().top);$(k).children("div.selectionStartBox#"+f).css("opacity",c);$(m).children("div.selectionEndBox#"+f).width(e+1);$(m).children("div.selectionEndBox#"+f).height(j);$(m).children("div.selectionEndBox#"+f).css("background-color",l);$(m).children("div.selectionEndBox#"+f).css("top",$(m).position().top);$(m).children("div.selectionEndBox#"+f).css("opacity",c);$(m).children().css("left",0);createParagraphBox(f,k,m,d,j,l)}}function createParagraphBox(f,j,l,e,h,k){var i=$(j).parents("p.paragraphContainer");var b=$(j).parents("p.paragraphContainer");var a=$(l).parents("p.paragraphContainer");if(!$(j).children("div.selectionBox").length){$(j).append('<div class="selectionBox" id="'+f+'" ></div>')}$(j).children("div.selectionBox#"+f).width(650);$(j).children("div.selectionBox#"+f).css("background-color",k);$(j).children("div.selectionBox#"+f).css("opacity",0.5);$(j).children("div.selectionBox#"+f).css("left",0);var g=0;while(i.length&&!$(i).is($(a))){if($(i).is($(b))){g+=$(i).height()-($(j).position().top+e)+parseInt($(i).css("margin-bottom"))}else{g+=$(i).height()+parseInt($(i).css("margin-bottom"))}if(!i[0].nextSibling){var d=$($(i).parents("div.page")[0].nextSibling);if(d.length&&d.hasClass("pageBreak")){d=$(d[0].nextSibling)}if(d.length){var c=i.parents("div.page").position().top+i.parents("div.page").height()-(i.position().top+i.height());i=d.children(":first");g+=c+30}}else{i=$(i[0].nextSibling)}}g+=$(l).position().top;$(j).children("div.selectionBox#"+f).height(g);$(j).children("div.selectionBox#"+f).css("top",$(j).position().top+e)};function spellCheck(){var a=$doc("p.background_kolab");var b="";for(i=0;i<a.length;i++){$("body").append('<input id="spellCheck_'+i+'" klb="'+$(a[i]).attr("klb")+'" type="textarea" style="margin: 5px;display: none;"/>');$("#spellCheck_"+i).val($(a[i]).text())}$("input[klb]").bind("change",function(h){var g=$(h.target);var k=$doc('p.paragraphContainer[klb="'+g.attr("klb")+'"]');var f=new diff_match_patch();var d=f.patch_make(k.text(),g.val());applySpellCheck(k,d)});var c=$("input[klb]").spellCheckInDialog({popUpStyle:"fancybox",theme:"modern",showStatisticsScreen:false});c.onDialogClose=function(){$("input[klb]").remove()}}function applySpellCheck(h,d){for(i=0;i<d.length;i++){console.log(d[i]);var g=0;var a=h[0].childNodes[0];var c=true;while(c){if(a.nodeType==1&&a.nodeName=="SPAN"){a=a.childNodes[0]}else{if(a.nodeType==1){if(a.nextSibling){a=a.nextSibling}else{return}}else{if(a.nodeType==3){if((g+a.textContent.length)<d[i].start1){g+=a.textContent.length;if(a.nextSibling){a=a.nextSibling}else{a=a.parentNode}}else{if((g+a.textContent.length)==d[i].start1){if(a.nextSibling){a=a.nextSibling}else{a=a.parentNode}}else{c=false}}}else{return}}}}console.log(a);g=d[i].start1-g;var f=d[i].diffs;for(j=0;j<f.length;j++){var e=f[j][1].length;switch(f[j][0]){case 0:console.log("none");if(f[j+1]){while((g+e)>a.length){console.log("while",g,e,a.length);e=e-(a.length-g);g=0;do{if(a.nextSibling){a=a.nextSibling}else{if(a.parentNode.nextSibling){a=a.parentNode.nextSibling.childNodes[0]}else{return}}}while(a.nodeType!=3)}g+=e;console.log(a,g)}break;case 1:console.log("add");a.insertData(g,f[j][1]);g+=e;break;case -1:console.log("remove");while((g+e)>a.length){var b=(a.length-g);a.deleteData(g,b);e-=b;g=0;do{if(a.nextSibling){a=a.nextSibling}else{if(a.parentNode.nextSibling){a=a.parentNode.nextSibling.childNodes[0]}else{return}}}while(a.nodeType!=3)}a.deleteData(g,e);break}}}};function initStylingManager(c,a,b){path=b;$("#applyStyle").bind("click",function(){applyCoordStyle(arrayOfStyle,arrayOfData)});$("#bold").bind("click",function(){manageStyling("font-weight","bold",c,"undo",true);if($doc("div.selAnchor#"+c).length){sendParagraphChangeEvent("style","bold","font-weight",c,a);checkToolbarState(c);Cursor.setCursor(c,"#FF0063")}});$("#italic").bind("click",function(){manageStyling("font-style","italic",c,"undo",true);if($doc("div.selAnchor#"+c).length){sendParagraphChangeEvent("style","italic","font-style",c,a);checkToolbarState(c);Cursor.setCursor(c,"#FF0063")}});$("#underline").bind("click",function(){manageStyling("text-decoration","underline",c,"undo",true);if($doc("div.selAnchor#"+c).length){sendParagraphChangeEvent("style","underline","text-decoration",c,a);checkToolbarState(c);Cursor.setCursor(c,"#FF0063")}});$("#strike").bind("click",function(){manageStyling("text-decoration","line-through",c,"undo",true);if($doc("div.selAnchor#"+c).length){sendParagraphChangeEvent("style","line-through","text-decoration",c,a);checkToolbarState(c);Cursor.setCursor(c,"#FF0063")}});$("#fontBtn").bind("click",function(){var d=$("#font").children(":selected").val();manageStyling("font-family",d,c,"undo",true);if($doc("div.selAnchor#"+c).length){sendParagraphChangeEvent("style",d,"font-family",c,a);checkToolbarState(c);Cursor.setCursor(c,"#FF0063")}});$("#sizeBtn").bind("click",function(){var d=$("#size").children(":selected").val();manageStyling("font-size",d,c,"undo",true);if($doc("div.selAnchor#"+c).length){sendParagraphChangeEvent("style",d,"font-size",c,a);checkToolbarState(c);Cursor.setCursor(c,"#FF0063")}});$("#colorBtn").bind("click",function(){var d=$("#color").children(":selected").val();manageStyling("background-color",d,c,"undo",true);if($doc("div.selAnchor#"+c).length){sendParagraphChangeEvent("style",d,"background-color",c,a);checkToolbarState(c);Cursor.setCursor(c,"#FF0063")}});$("#headingBtn").bind("click",function(){var d=$("#heading").children(":selected").val();manageHeading(d,c,"undo");sendParagraphChangeEvent("stylePgh",d,"hdg",c,a);checkToolbarState(c);Cursor.setCursor(c,"#FF0063")});$("#alignBtn").bind("click",function(){var d=$("#align").children(":selected").val();manageAlignement(d,c,"undo");sendParagraphChangeEvent("stylePgh",d,"alg",c,a);checkToolbarState(c);Cursor.setCursor(c,"#FF0063")});$("#lhBtn").bind("click",function(){var d=$("#lh").children(":selected").val();switch(d){case"1":d="normal";break;case"1.5":d=1.5;break;case"2":d=2;break;case"2.5":d=2.5;break}setLineHeight(d,c,"undo");sendParagraphChangeEvent("stylePgh",d,"lht",c,a);checkToolbarState(c);Cursor.setCursor(c,"#FF0063")});$("#indP").bind("click",function(){var d=manageIndent("ind",c,"undo");sendParagraphChangeEvent("stylePgh",d,"ind",c,a);checkToolbarState(c);Cursor.setCursor(c,"#FF0063")});$("#indM").bind("click",function(){var d=manageIndent("det",c,"undo");sendParagraphChangeEvent("stylePgh",d,"det",c,a);checkToolbarState(c);Cursor.setCursor(c,"#FF0063")})}var mapStyling={};mapStyling.value=[];mapStyling.style=[];function manageStyling(p,l,b,o,m){if(!$doc("div.selAnchor#"+b).length){if(mapStyling.style.length){if(mapStyling.style.indexOf(p)!=-1){var f=mapStyling.style.indexOf(p);if(p=="font-family"||p=="font-size"||p=="background-color"){mapStyling.value.splice(f,1,l)}else{if(p=="text-decoration"){mapStyling.value[f]=mapStyling.value[f].replace(new RegExp(" ?"+l+" ?"),"");if(!mapStyling.value[f].match(/(underline|line-through)/)){mapStyling.style.splice(f,1);mapStyling.value.splice(f,1)}}else{mapStyling.style.splice(f,1);mapStyling.value.splice(f,1)}}}else{if(p=="text-decoration"){var j=$doc("div.cursor#"+b).parent().css(p);if(!j.match(new RegExp(" ?"+l+" ?"))){if(j.match(/none/)){j=l}else{j="underline line-through"}}else{j=j.replace(new RegExp(" ?"+l+" ?"),"");if(!j.match(/(underline|line-through)/)){j="none"}else{if(l=="underline"){j="line-through"}else{j="underline"}}}mapStyling.style.push(p);mapStyling.value.push(j)}else{if($doc("div.cursor#"+b).parent().css(p)==l){mapStyling.style.push(p);mapStyling.value.push("normal")}else{mapStyling.style.push(p);mapStyling.value.push(l)}}}}else{var c=$doc("div.cursor#"+b).parent().css(p);if(p=="text-decoration"){if(!c.match(new RegExp(" ?"+l+" ?"))){if(c.match(/none/)){c=l}else{c="underline line-through"}}else{c=c.replace(new RegExp(" ?"+l+" ?"),"");if(!c.match(/(underline|line-through)/)){c="none"}else{if(l=="underline"){c="line-through"}else{c="underline"}}}mapStyling.style.push(p);mapStyling.value.push(c)}else{if(c==l){mapStyling.style.push(p);mapStyling.value.push("normal")}else{mapStyling.style.push(p);mapStyling.value.push(l)}}}}else{var d=[[]];var g=0;var c=$doc("div.cursor#"+b).parent().css(p);if(p=="text-decoration"&&m){if(!c.match(new RegExp(" ?"+l+" ?"))){if(c.match(/none/)){c=l}else{c="underline line-through"}}else{c=c.replace(new RegExp(" ?"+l+" ?"),"");if(!c.match(/(underline|line-through)/)){c="none"}else{if(l=="underline"){c="line-through"}else{c="underline"}}}l=c}else{if(c==l&&m){l="normal"}}if($($doc("div.selAnchor#"+b+",div.cursor#"+b)[0]).is("div.selAnchor#"+b)){var n=$doc("div.selAnchor#"+b)[0];var e=$doc("div.cursor#"+b)[0];var f=evaluateCursorPosInText(b,"selAnchor")}else{var n=$doc("div.cursor#"+b)[0];var e=$doc("div.selAnchor#"+b)[0];var f=evaluateCursorPosInText(b,"cursor")}var r=false;var a=$(n).parent();if($(n)[0].nextSibling&&$(n)[0].previousSibling){$(n).parent().after('<span author="'+$(n).parent().attr("author")+'" style="'+$(n).parent().attr("style")+'"></span>');var q=$($(n).parent()[0].nextSibling);while($(n)[0].nextSibling){q.append($(n)[0].nextSibling)}}else{if($(n)[0].nextSibling){r=true}}var k=$(e).parent();if($(e)[0].nextSibling&&$(e)[0].previousSibling){$(e).parent().after('<span author="'+$(e).parent().attr("author")+'" style="'+$(e).parent().attr("style")+'"></span>');var q=$($(e).parent()[0].nextSibling);while($(e)[0].nextSibling){q.append($(e)[0].nextSibling)}}var i;if($doc(n).parent()[0].nextSibling&&!r){i=$($doc(n).parent()[0].nextSibling)}else{i=$doc(n).parent()}var s=[{klb:i.parent().attr("klb"),coord:[]}];while(i.length){if(!i.find(e).length){if(o=="undo"){d[g].push(p+":"+i.css(p)+";")}s[g].coord.push({start:f,end:(f+i.text().length)});f+=i.text().length;i.css(p,l);if(o=="redo"){d[g].push(p+":"+i.css(p)+";")}}else{break}if(i[0].nextSibling){i=$(i[0].nextSibling)}else{if(i.parent()[0].nextSibling){List.changeSize(i.parent());i=$($(i.parent()[0].nextSibling).children()[0]);d.push([]);s.push({klb:i.parent().attr("klb"),coord:[]});g++}else{break}}}if(i.find(e).length){d[g].push(p+":"+i.css(p)+";");s[g].coord.push({start:f,end:(f+i.text().length)})}$doc(e).parent().css(p,l);List.changeSize($doc(e).parent().parent());if(o=="undo"){if(!m){Undo.addElement({action:"styleSpec",content:d,user:b,extra:s})}else{Undo.addElement("break");Undo.addElement({action:"styleSpec",content:d,user:b,extra:s});var h=null;if($doc("div.selAnchor#"+b).length){h={};h.klb=$doc("div.selAnchor#"+b).parents("p.paragraphContainer").attr("klb");h.pos=evaluateCursorPosInText(b,"cursor")}Undo.addElement({action:"cursor",content:($doc("div.cursor#"+b).parents("p.paragraphContainer").attr("klb")+","+evaluateCursorPosInText(b,"cursor")),user:b,extra:""})}}else{if(o=="redo"){if(!m){Redo.addElement({action:"styleSpec",content:d,user:b,extra:s})}else{Redo.addElement("break");Redo.addElement({action:"styleSpec",content:d,user:b,extra:s});var h=null;if($doc("div.selAnchor#"+b).length){h={};h.klb=$doc("div.selAnchor#"+b).parents("p.paragraphContainer").attr("klb");h.pos=evaluateCursorPosInText(b,"cursor")}Redo.addElement({action:"cursor",content:($doc("div.cursor#"+b).parents("p.paragraphContainer").attr("klb")+","+evaluateCursorPosInText(b,"cursor")),user:b,extra:""})}}}combineSpanAuthor(a,k)}$("iframe#r_engine")[0].contentWindow.focus()}function manageHeading(j,b,l){var m="font-family:arial,helvetica,sans-serif;font-size:16px;background-color:transparent;font-weight:normal;font-style:normal;text-decoration:none;";var a=[];var r={type:"head",klb:[]};if(l=="undo"){Undo.addElement("break")}else{if(l=="redo"){Redo.addElement("break")}}if(!$doc("div.selAnchor#"+b).length){var p=$doc("div.cursor#"+b).parents("p.paragraphContainer");r.klb.push(p.attr("klb"));a.push(p.attr("head")?p.attr("head"):"");if(j==""){p.attr("head","")}else{if(j!="Normal"){p.attr("head",j)}else{var c=[[]];var s=[{klb:p.attr("klb"),coord:[]}];p.attr("head","");var o=combineAllSpan(p.children(":first"),c,s,0);console.log(o[0]);c=o[0];s=o[1];p.children().each(function(){var t=$(this).css("background-color");$(this).attr("style",m);$(this).css("background-color",t)})}}}else{if($($doc("div.selAnchor#"+b+",div.cursor#"+b)[0]).is("div.selAnchor#"+b)){var k=$doc("div.selAnchor#"+b)[0];var d=$doc("div.cursor#"+b)[0]}else{var k=$doc("div.cursor#"+b)[0];var d=$doc("div.selAnchor#"+b)[0]}var q=$(k).parents("p.paragraphContainer").attr("klb");var n=$(d).parents("p.paragraphContainer").attr("klb");var h=q;var g=true;var c=[[]];var s=[{klb:h,coord:[]}];var f=0;var e=0;do{if(!g){h=$($doc('p.paragraphContainer[klb="'+h+'"]')[0].nextSibling).attr("klb")}var p=$doc('p.paragraphContainer[klb="'+h+'"]');r.klb.push(p.attr("klb"));a.push(p.attr("head")?p.attr("head"):"");if(j==""){p.attr("head","")}else{if(j!="Normal"){p.attr("head",j)}else{p.attr("head","");var o=combineAllSpan(p.children(":first"),c,s,f);c=o[0];s=o[1];p.children().each(function(){var t=$(this).css("background-color");$(this).attr("style",m);$(this).css("background-color",t)});if($doc('p.paragraphContainer[klb="'+h+'"]')[0].nextSibling){f++;e=0;c.push([]);s.push([{klb:$($doc('p.paragraphContainer[klb="'+h+'"]')[0].nextSibling).attr("klb"),coord:[]}])}}}g=false}while(h!=n)}if(l=="undo"){Undo.addElement({action:"styleSpec",content:c,user:b,extra:s});var i=null;if($doc("div.selAnchor#"+b).length){i={};i.klb=$doc("div.selAnchor#"+b).parents("p.paragraphContainer").attr("klb");i.pos=evaluateCursorPosInText(b,"cursor")}Undo.addElement({action:"cursor",content:($doc("div.cursor#"+b).parents("p.paragraphContainer").attr("klb")+","+evaluateCursorPosInText(b,"cursor")),user:b,extra:""})}else{if(l=="redo"){Redo.addElement({action:"styleSpec",content:c,user:b,extra:s});var i=null;if($doc("div.selAnchor#"+b).length){i={};i.klb=$doc("div.selAnchor#"+b).parents("p.paragraphContainer").attr("klb");i.pos=evaluateCursorPosInText(b,"cursor")}Redo.addElement({action:"cursor",content:($doc("div.cursor#"+b).parents("p.paragraphContainer").attr("klb")+","+evaluateCursorPosInText(b,"cursor")),user:b,extra:""})}}$("iframe#r_engine")[0].contentWindow.focus()}function manageAlignement(i,h,d){var f={type:"css",klb:[]};var k=[];if(!$doc("div.selAnchor#"+h).length){var e=$doc("div.cursor#"+h).parents("p.paragraphContainer");f.klb.push(e.attr("klb"));k.push(e.attr("style"));e.css("text-align",i);if(i.toLowerCase()=="justify"){e.css("white-space","normal")}else{e.css("white-space","pre-wrap")}}else{if($($doc("div.selAnchor#"+h+",div.cursor#"+h)[0]).is("div.selAnchor#"+h)){var j=$doc("div.selAnchor#"+h)[0];var l=$doc("div.cursor#"+h)[0]}else{var j=$doc("div.cursor#"+h)[0];var l=$doc("div.selAnchor#"+h)[0]}var c=$(j).parents("p.paragraphContainer").attr("klb");var b=$(l).parents("p.paragraphContainer").attr("klb");var a=c;var g=true;do{if(!g){a=$($doc('p.paragraphContainer[klb="'+a+'"]')[0].nextSibling).attr("klb")}f.klb.push(a);k.push($doc('p.paragraphContainer[klb="'+a+'"]').attr("style"));$doc('p.paragraphContainer[klb="'+a+'"]').css("text-align",i);if(i=="justify"){$doc('p.paragraphContainer[klb="'+a+'"]').css("white-space","normal")}else{$doc('p.paragraphContainer[klb="'+a+'"]').css("white-space","pre-wrap")}g=false}while(a!=b)}if(d=="undo"){Undo.addElement({action:"styleSpecPgh",content:k,user:h,extra:f})}$("iframe#r_engine")[0].contentWindow.focus()}function setLineHeight(i,h,d){var f={type:"css",klb:[]};var k=[];if(!$doc("div.selAnchor#"+h).length){var e=$doc("div.cursor#"+h).parents("p.paragraphContainer");f.klb.push(e.attr("klb"));k.push(e.attr("style"));e.css("line-height",i)}else{if($($doc("div.selAnchor#"+h+",div.cursor#"+h)[0]).is("div.selAnchor#"+h)){var j=$doc("div.selAnchor#"+h)[0];var l=$doc("div.cursor#"+h)[0]}else{var j=$doc("div.cursor#"+h)[0];var l=$doc("div.selAnchor#"+h)[0]}var c=$(j).parents("p.paragraphContainer").attr("klb");var b=$(l).parents("p.paragraphContainer").attr("klb");var a=c;var g=true;do{if(!g){a=$($doc('p.paragraphContainer[klb="'+a+'"]')[0].nextSibling).attr("klb")}var e=$doc('p.paragraphContainer[klb="'+a+'"]');f.klb.push(e.attr("klb"));k.push(e.attr("style"));e.css("line-height",i);g=false}while(a!=b)}if(d=="undo"){Undo.addElement({action:"styleSpecPgh",content:k,user:h,extra:f})}$("iframe#r_engine")[0].contentWindow.focus()}function manageIndent(b,h,d){var i;if(d=="undo"){if(b=="ind"){Undo.addElement({action:"stylePgh",content:"",user:h,extra:"det"})}else{Undo.addElement({action:"stylePgh",content:"",user:h,extra:"ind"})}}else{if(d=="redo"){if(b=="ind"){Redo.addElement({action:"stylePgh",content:"",user:h,extra:"det"})}else{Redo.addElement({action:"stylePgh",content:"",user:h,extra:"ind"})}}}if(!$doc("div.selAnchor#"+h).length){var f=$doc("div.cursor#"+h).parents("p.paragraphContainer");if(b=="ind"){if(f.hasClass("bullet")||f.hasClass("bulletLast")){List.increaseLevel(f)}else{if(parseInt(f.css("padding-left"))<=90){i=parseInt(f.css("padding-left"))+30;f.css("padding-left",i+"px");f[0].style.width=f.width()-30}}}else{if(f.hasClass("bullet")||f.hasClass("bulletLast")){List.decreaseLevel(f)}else{if(parseInt(f.css("padding-left"))>=30){i=parseInt(f.css("padding-left"))-30;f.css("padding-left",i+"px");f[0].style.width=f.width()+30}}}}else{if($($doc("div.selAnchor#"+h+",div.cursor#"+h)[0]).is("div.selAnchor#"+h)){var j=$doc("div.selAnchor#"+h)[0];var k=$doc("div.cursor#"+h)[0]}else{var j=$doc("div.cursor#"+h)[0];var k=$doc("div.selAnchor#"+h)[0]}var e=$(j).parents("p.paragraphContainer").attr("klb");var c=$(k).parents("p.paragraphContainer").attr("klb");var a=e;var g=true;do{if(!g){a=$($doc('p.paragraphContainer[klb="'+a+'"]')[0].nextSibling).attr("klb")}var f=$doc('p.paragraphContainer[klb="'+a+'"]');if(b=="ind"){if(f.hasClass("bullet")||f.hasClass("bulletLast")){List.increaseLevel(f)}else{if(parseInt(f.css("padding-left"))<=90){i=parseInt(f.css("padding-left"))+30;f.css("padding-left",i+"px");f[0].style.width=f.width()-30}}}else{if(f.hasClass("bullet")||f.hasClass("bulletLast")){List.decreaseLevel(f)}else{if(parseInt(f.css("padding-left"))>=30){i=parseInt(f.css("padding-left"))-30;f.css("padding-left",i+"px");f[0].style.width=f.width()+30}}}g=false}while(a!=c)}$("iframe#r_engine")[0].contentWindow.focus();return i}function addHorizontalLine(b,a,c){if($doc("div.selAnchor#"+b).length){selectionDelete(b,a,c)}if(previousNodeSearch($doc("div.cursor#"+b)[0])=="firstLine"){manageEnter(b,null,"kolab","undo",false);var d=$doc("div.cursor#"+b).parents("p.paragraphContainer").prev("p.paragraphContainer")}else{if(nextNodeSearch($doc("div.cursor#"+b)[0])=="lastLine"){manageEnter(b,null,"kolab","undo",false);var d=$doc("div.cursor#"+b).parents("p.paragraphContainer")}else{manageEnter(b,null,"kolab","undo",false);manageEnter(b,null,"kolab","undo",false);var d=$doc("div.cursor#"+b).parents("p.paragraphContainer").prev("p.paragraphContainer")}}d.html("");d.attr("contentEditable",false);d.addClass("hr")}function checkToolbarState(c){var i=["arial, helvetica, sans-serif","arial black, helvetica, sans-serif","georgia, serif","helvetica, helvetica, sans-serif","impact, cursive","lucida sans unicode, lucida grande, sans-serif","myriad-pro, sans-serif","tahoma, geneva, sans-serif","times new roman, times, serif","trebuchet ms, helvetica, sans-serif","verdana, geneva, sans-serif"];var f=["11px","12px","13px","15px","16px","19px","22px","24px","26px","29px","32px","35px","37px","48px","64px","96px"];var s=["#FFFF00","#48FF48","#40FFFF","#FF82FF","#7171FF","#FF4242","#C0C0C0","transparent"];var a=["normal","1.5","2","2.5"];var p=["left","center","right","justify"];var e=["Normal","Title","Subtitle","Heading1","Heading2","Heading3","Note"];var j;if($($doc("div.selAnchor#"+c+",div.cursor#"+c)[0]).is("div.selAnchor#"+c)){j=$doc("div.selAnchor#"+c).parent()}else{j=$doc("div.cursor#"+c).parent()}var k=j.css("font-weight");if(k=="bold"){$("#bold").attr("src",path+"images/bolda.jpg")}else{$("#bold").attr("src",path+"images/bold.jpg")}var d=j.css("font-style");if(d=="italic"){$("#italic").attr("src",path+"images/italica.jpg")}else{$("#italic").attr("src",path+"images/italic.jpg")}var h=j.css("text-decoration");if(h.match(/\underline/)){$("#underline").attr("src",path+"images/underlinea.jpg")}else{$("#underline").attr("src",path+"images/underline.jpg")}var n=i.indexOf(j.css("font-family"));$("#font")[0].selectedIndex=n;var l=f.indexOf(j.css("font-size"));$("#size")[0].selectedIndex=l;var r=j.css("background-color").split("(")[1].split(")")[0];r=r.split(",");var b=r.map(function(t){t=parseInt(t).toString(16);return(t.length==1)?"0"+t:t});if(b.join("")=="00000000"){b="transparent"}else{b="#"+b.join("").toUpperCase()}var g=s.indexOf(b);$("#color")[0].selectedIndex=g;backgroundOptionChange();var q=a.indexOf(j.css("line-height"));$("#lh")[0].selectedIndex=q;var o=p.indexOf(j.css("text-align"));$("#align")[0].selectedIndex=o;var m=0;if(j.parents("p.paragraphContainer").attr("head")){m=e.indexOf(j.parents("p.paragraphContainer").attr("head"))}$("#heading")[0].selectedIndex=m}function backgroundOptionChange(){var a=$("#color").children(":selected").val();if(a=="transparent"){$("#color").css("background-color","white")}else{$("#color").css("background-color",a)}}function applyParagraphStyle(d,b){for(var c=0;c<b.klb.length;c++){var a=$doc('p.paragraphContainer[klb="'+b.klb[c]+'"]');if(b.type=="head"){if(d[c]==""){a.attr("head","")}else{a.attr("head",d[c])}}else{a.attr("style",d[c])}}}function applyCoordStyle(b,h,e){var d,c;d={};d.isCollapsed=false;var m=0;for(var l=0;l<h.length;l++){for(var g=0;g<h[l].coord.length;g++){c=childAtPos($doc('p.paragraphContainer[klb="'+h[l].klb+'"]'),h[l].coord[g].start);d.anchorNode=c[0];d.anchorOffset=c[1];placeSelectionNode(d.anchorNode,d.anchorOffset,"selAnchor","tempCursor");c=childAtPos($doc('p.paragraphContainer[klb="'+h[l].klb+'"]'),h[l].coord[g].end);d.focusNode=c[0];d.focusOffset=c[1];placeSelectionNode(d.focusNode,d.focusOffset,"cursor","tempCursor");var o=stylesUnZip(b[l][g]);console.log(o,o.value.length,b[l][g],h,b);for(var f=0;f<o.value.length;f++){console.log(o.value[f],o.style[f]);manageStyling(o.style[f],o.value[f],"tempCursor",e,false)}var n=$doc("div.cursor#tempCursor").parent();var a=$doc("div.selAnchor#tempCursor").parent();$doc("div.cursor#tempCursor").remove();$doc("div.selAnchor#tempCursor").remove();mergeAllNode($.makeArray($(a)[0].childNodes));mergeAllNode($.makeArray($(n)[0].childNodes))}}}arrayOfStyle=[[]];arrayOfData=[];arrayOfStyle[0][0]="font-weight:bold;font-style:italic";arrayOfStyle.push(["font-weight:bold;font-style:italic"]);arrayOfData[0]={klb:"initialKlb",coord:[{start:2,end:5}]};arrayOfData.push({klb:"initialKlb3",coord:[{start:7,end:10}]});function initUndoRedoManager(b,a){$("#undo").bind("click",function(){var c=Undo.getElement();if(c){console.log("UNDO: ",c);changesetRouter(c,"redo")}$("iframe#r_engine")[0].contentWindow.focus()});$("#redo").bind("click",function(){var c=Redo.getElement();if(c){console.log("REDO: ",c);changesetRouter(c,"undo")}$("iframe#r_engine")[0].contentWindow.focus()})}var Undo=(function(){var b=[];function e(f){b.push(f)}function d(){return b.pop()}function c(){b=[]}function a(j){var g=$doc("div.cursor#"+j).parents("span[author]").attr("style").split(";");g.pop();var h=[];var f=[];for(i=0;i<g.length;i++){g[i]=g[i].split(":");h.push(g[i][0]);f.push(g[i][1])}return[h,f]}return{getElement:d,addElement:e,clearStack:c,getStyleMap:a}})();var Redo=(function(){var d=[];function c(e){d.push(e)}function b(){return d.pop()}function a(){d=[]}return{getElement:b,addElement:c,clearStack:a}})();function $doc(a){if(a){return $("iframe#r_engine").contents().children("html").children("body").find(a)}else{return $("iframe#r_engine").contents().children("html").children("body")}}function $klb(a){return $doc().find('p[klb="'+a+'"]')}function klbGeneratorGenerator(b,a){var e="abcdefghijklmnopqrstuvwxyz0123456789",d=e.length,g=b,f=[],c=1000;if(typeof a=="string"){$doc("["+a+"]").each(function(){try{f.push(this.getAttribute(a))}catch(h){}})}return(function(){var h,k,j=0;do{if(j>750&&a){}k="";for(h=0;h<g;h++){k+=e[Math.floor(Math.random()*d)]}j++}while(f.indexOf(k)!=-1&&j<c);f.push(k);return k})}function textOnly(a){return(a.match(htmlPartsPlus)||[]).reduce(function(c,b){if(b[0]!="<"){c+=b.replace(/&\w{2,7};/g," ").length}return c},0)}function childAtPos(d,a){var b,c,e;if(!d.length){return[null,parseInt(a)]}d.contents().each(function(){if(this.outerHTML!=undefined&&this.outerHTML.length){c=textOnly(this.outerHTML);if(c<a){a-=c}else{if($(this).contents().length){e=childAtPos($(this),a);b=e[0];a=e[1]}return false}}else{if(this.length<a){a-=this.length}else{b=this;return false}}});return[b,parseInt(a)]}function childPos(d,a){var f=d.children();var e=0;for(var c=0;c<f.length;c++){if($(f[c]).find(a).length){break}else{e+=$(f[c]).text().length}}obj=$(f[c]).find(a)[0];while(obj!=$(f[c])[0]){var b=obj.previousSibling;if(b){obj=b;if(obj.nodeType==3){e+=obj.data.length}else{e+=obj.textContent.length}}else{obj=obj.parentNode}}return e}function prghSplit(n,j){var q=[];while($(n).width()>(pageWidth-parseInt(n.parents("p.paragraphContainer").css("padding-left")))){var e;if($(n).text().match(/ /g)&&!($(n).text().match(/ /g).length==1&&$(n).text().match(/ $/))){var c=htmlPop(n[0]);e=c.length}else{var a=$(n).text().length;var d=$(n).width();var h=d/a;e=(d-pageWidth)/h;e=Math.ceil(e)}var m=$(n).text().length-e;var p=childAtPos($(n),m);var f=p[0];m=p[1];var l=f;if(m==f.data.length){f=f.nextSibling}else{if(m!=0){f=f.splitText(m)}}var k=[];var o=[];while(!$(l).is("div.lineText")){if(!f){l=l.parentNode;f=l.nextSibling;if(!$(l).is("div.lineText")){o.push(l)}}else{if(f.nodeType!=3&&!$(f).is("div.cursor#"+j)&&!$(f).is("div#selAnchor")&&!$(f).is("div.space")){l=f;f=f.childNodes[0]}else{var b=$(f).parent().attr("style");var g=$(f).parent().parent().attr("author");k.unshift([f,b,g]);l=f;f=f.nextSibling}}}q=q.concat(k);for(i=0;i<k.length;i++){if($(k[i][0]).is("div.space")){$(k[i][0]).remove();k[i][0]=document.createTextNode(" ")}else{$(k[i][0]).remove()}}k=[];for(i=0;i<o.length;i++){if(!$(o[i]).text().length){$(o[i]).remove()}}}return q}function prghShift(k,c,b){var t=true;var j=[];var a=parseInt(k.width());var q=false;var p=0;while(t){if(c.text().match(/ /g)||k.text()[k.text().length-1]==" "){var u=htmlShift(c[0]);p=u.length}else{var l=k.text().length;if(l!=0){var n=a/l;p=(pageWidth-a)/n;p=Math.round(p)}else{p=0}if(p==0){p=1}if(p>c.text().length){p=c.text().length}}var f=p;var h=childAtPos(c,f);var r=h[0];f=h[1];var m=r;if(f==0){r=r.previousSibling}else{if(f!=r.data.length){r=r.splitText(f);r=r.previousSibling}}var g=[];var e=[];while(!$(m).is("div.lineText")){if(!r){m=m.parentNode;r=m.previousSibling;if(!$(m).is("div.lineText")){e.push(m)}}else{if(r.nodeType!=3&&!$(r).is("div.cursor#"+b)&&!$(r).is("div#selAnchor")){m=r;r=r.childNodes[r.childNodes.length-1]}else{var s=$(r).parent().attr("style");var d=$(r).parent().parent().attr("author");g.unshift([r,s,d]);m=r;r=r.previousSibling}}}var o=0;$("#rosenframe_back").append('<span id="invisible" style="visibility: hidden;"></span>');for(i=0;i<g.length;i++){if(g[i][0].nodeType==3){$("#rosenframe_back").children("#invisible").append('<span style="'+g[i][1]+'">'+g[i][0].data+"</span>")}else{$("#rosenframe_back").children("#invisible").append('<span style="'+g[i][1]+'">'+g[i][0].outerHTML+"</span>")}}o=$("#rosenframe_back").children("#invisible").width();$("#rosenframe_back").children("#invisible").remove();if((a+o)<=(pageWidth-parseInt(k.parents("div.paragraphContainer").css("padding-left")))){a=a+o;j=j.concat(g);for(i=0;i<g.length;i++){$(g[i][0]).remove()}g=[];for(i=0;i<e.length;i++){if(!$(e[i]).text().length){$(e[i]).remove()}}if(!c.html().length){var v=c.parent("div.lineContainer").next("div.lineContainer");c.parent().remove();if(v.length){c=v.children()}else{t=false}}}else{if(k.text().match(/ /g)&&!k.text().match(/ $/)){a=a+o;j=j.concat(g);for(i=0;i<g.length;i++){$(g[i][0]).remove()}g=[];for(i=0;i<e.length;i++){if(!$(e[i]).text().length){$(e[i]).remove()}}if(!c.html().length){var v=c.parent("div.lineContainer").next("div.lineContainer");c.parent().remove();if(v.length){c=v.children()}}t=false;q=true}else{t=false}}}return[j,q]}function htmlShift(a){var b=a.textContent;b=b.replace(/<div class="cursor"><\/div>|<div class="selAnchor"><\/div>/g,"");if(b.match(/^ /)){word=b.match(/^ *?\S*? |^ *?\S*?$/)[0]}else{word=b.match(/^\S*? |^\S*?$/)[0]}return word}function htmlPop(a){var b=a.textContent;b=b.replace(/<div class="cursor"><\/div>|<div class="selAnchor"><\/div>/g,"");if(b.match(/ $/)){word=b.match(/\S+? +/g);word=word[word.length-1]}else{word=b.match(/\S+?$/)[0]}return word}var standalones={area:true,base:true,basefont:true,br:true,col:true,frame:true,hr:true,img:true,input:true,link:true,meta:true,param:true};function segmenter(b){var a=[];if(!b.innerHTML){return[]}return(function(c){return c?c:[]}(b.innerHTML.match(htmlPartsPlus))).reduce(function(e,f){var k=[],h=[],l,d,j,g,c;if(f.match(htmlParts)){tagName=f.match(/[^\/<>\s]+/);if(tagName.length){if(tagName[0] in standalones){k.push([f,a.map(function(m){return m})])}else{if(f[1]==="/"){a.pop()}else{a.push(f)}}}}else{if(f==" "||f.trim()){j=0;while(d!==-1){d=f.indexOf(" ",h.length?h[h.length-1]+1:0);if(d!==-1){h.push(d+1)}}if(!h.length){k.push([f,a.map(function(m){return m})])}else{if(h[0]!==0){k.push([f.substring(0,h[0]),a.map(function(m){return m})])}for(c=1;c<h.length;c++){k.push([f.substring(h[c-1],h[c]),a.map(function(m){return m})])}if(h[h.length-1]<f.length){k.push([f.substring(h[h.length-1]),a.map(function(m){return m})])}}}}return e.concat(k)},[])}function combiner(c){var b=[];c.push(["",[]]);function a(e){return e.reduce(function(g,f){if(b.indexOf(f)!==-1){return g}else{b.push(f);return g+f}},"")}function d(e){var f=b.map(function(g){return g});b=[];return f.filter(function(g){if(e.indexOf(g)!==-1){b.push(g);return false}return true}).reverse().reduce(function(j,g){var h=g.indexOf(" ");if(h===-1){h=g.indexOf(">")}return j+"</"+g.substring(1,h)+">"},"")}return c.reduce(function(f,e){if(!e){return f}return f+d(e[1])+a(e[1])+e[0]},"")}var htmlParts=/<(?:(?:\/([^>]+)>)|(?:!--([\S|\s]*?)-->)|(?:([^\s>]+)\s*((?:(?:"[^"]*")|(?:'[^']*')|[^"'>])*)\/?>))/g,htmlPartsPlus=/<(?:(?:\/([^>]+)>)|(?:!--([\S|\s]*?)-->)|(?:([^\s>]+)\s*((?:(?:"[^"]*")|(?:'[^']*')|[^"'>])*)\/?>))|[^<>]+/g,fullOrPartialTags=/[^<>]+>|<[^<>]+>|<+[^<>]+|[<>]/g;function htmlHash(a){var b=a?20600:6700,c=[];return{give:function(e){if(e===""){return""}var f,d=c.length;for(f=0;f<d;f++){if(c[f]==e){return String.fromCharCode(b+f)}}c.push(e);return String.fromCharCode(b+f)},get:function(e){if(e===""){return""}var d=e.charCodeAt(0)-b;if(d<0||d>=c.length){return""}return c[d]},regex:function(){var e,d=c.length,f="";for(e=0;e<d;e++){f+=String.fromCharCode(b+e)}return new RegExp("["+f+"]","g")},debug:a?(function(){return c}):(function(){})}}function previousNodeSearch(c){var b=c.previousSibling;var a=true;while(a){if(!b){if($(c).is("span[author]")){b="firstLine";a=false}else{c=c.parentNode;b=c.previousSibling}}else{if(b.nodeType!=3&&!$(b).is("div.cursor")&&!$(b).is("div.selAnchor")){b=b.childNodes[b.childNodes.length-1]}else{if($(b).is("div.cursor")||$(b).is("div.selAnchor")||!b.data.length){b=b.previousSibling}else{a=false}}}}return b}function nextNodeSearch(c){var a=c.nextSibling;var b=true;while(b){if(!a){if($(c).is("span[author]")){a="lastLine";b=false}else{c=c.parentNode;a=c.nextSibling}}else{if(a.nodeType!=3&&!$(a).is("div.cursor")&&!$(a).is("div.selAnchor")){a=a.childNodes[0]}else{if($(a).is("div.cursor")||$(a).is("div.selAnchor")||!a.data.length){a=a.nextSibling}else{b=false}}}}return a}function mergeSpanAuthor(a){if(a.attr("author")==a.next("span[author]").attr("author")){a.append(a.next("span[author]").children());a.next("span[author]").remove()}else{if(a.attr("author")==a.prev("span[author]").attr("author")){a.prepend(a.prev("span[author]").html());a.prev("span[author]").remove()}}}function combineAllSpan(d,e,a,c){var b=d;var f=0;e[c].push(d.attr("style"));a[c].coord.push({start:f,end:(f+d.text().length)});f+=d.text().length;d.nextAll().each(function(){e[c].push($(this).attr("style"));a[c].coord.push({start:f,end:(f+$(this).text().length)});f+=$(this).text().length;if(b.attr("author")==$(this).attr("author")){b.append($(this)[0].childNodes);$(this).remove()}else{mergeAllNode($.makeArray($(b)[0].childNodes));b=$(this)}});console.log(e);return[e,a]}function stylesEquivalent(e,c){if(e===c){return true}var b=e.split(";"),a=c.split(";"),d;for(d=b.length-1;d>=0;d--){b[d]=b[d].toLowerCase().replace(/^\s*/,"").replace(/\s*$/,"").replace(/:\s*/g,"");if(b[d]===""){b.splice(d,1)}}for(d=a.length-1;d>=0;d--){a[d]=a[d].toLowerCase().replace(/^\s*/,"").replace(/\s*$/,"").replace(/:\s*/g,"");if(a[d]===""){a.splice(d,1)}}if(b.length!==a.length){return false}b.sort();a.sort();for(d=0;d<b.length;d++){if(b[d]!==a[d]){return false}}return true}function combineSpanAuthor(a,h){var c=a;var g;var d=true;while(d){if(c[0].nextSibling){g=$(c[0].nextSibling)}else{var f=c.parent();do{if(f[0].nextSibling){f=$(f[0].nextSibling)}else{if(f.parent()[0].nextSibling){var e=f.parent()[0].nextSibling;if($(e).hasClass("pageBreak")){e=e[0].nextSibling}var f=$(e.childNodes[0])}else{return}}var b=true;if(f[0].childNodes.length>=2){c=f[0].childNodes[0];g=f[0].childNodes[1];b=false}else{if(f.find(h)){b=false;d=false;c=null;g=null}}}while(b)}if(c&&g){if(g[0]==h[0]){d=false}if(c.attr("author")==g.attr("author")&&stylesEquivalent(c.attr("style"),g.attr("style"))){c.append(g[0].childNodes);g.remove()}else{c=g}}}}function mergeNodeToNext(c){var a=c.nextSibling;if(a){if(a.nodeType==3){var b=c.data;$doc(c).remove();a.insertData(0,b)}}}function mergeNodeToPrevious(c){var a=c.previousSibling;if(a){if(a.nodeType==3){var b=c.data;$(c).remove();a.insertData(a.data.length,b)}}}function mergeAllNode(b){for(var a=b.length-1;a>0;a--){if(b[a].data==""){$(b[a]).remove()}else{if(b[a].nodeType==3&&b[a].nodeType==b[a-1].nodeType){mergeNodeToNext(b[a-1])}}}}function stylesZip(b,a){return b.reduce(function(e,c,d){if(e.length){e+=";"}e+=c;e+=":";e+=a[d];return e},"")}function stylesUnZip(a){var b={style:[],value:[]};a.split(";").forEach(function(c){if(c.length){var d=c.split(":");b.style.push(d[0]);b.value.push(d[1])}});return b}function verifyAuthorStyle(b,c,d){if(b.length&&b.attr("author")==c){for(var a=0;a<d.style.length;a++){if(b.css(d.style[a])!=d.value[a]){return false}}}else{return false}return true}function wordCount(){var a=$doc().text();if(!a.length){return 0}else{a=a.replace(/[-_]/g,"");return a.split(/[^A-Za-z0-9]+/).length}}function pageCount(){return $doc("div.page").length}function applyHeadToText(a){a=a.replace(/(<p.*?head=".+?".*?>)(.*?)(<\/p>)/,function(d,g,c,f){var b=g.match(/head="(.*?)"/)[1];g=g.replace(/ head="(.*?)"/,"");var e="";switch(b){case"Title":e="font-family:arial,helvetica,sans-serif;font-size:48px;font-weight:bold;font-style:normal;text-decoration:none;";break;case"Subtitle":e="font-family:arial,helvetica,sans-serif;font-size:32px;font-weight:normal;font-style:normal;text-decoration:none;";break;case"Heading1":e="font-family:arial,helvetica,sans-serif;font-size:32px;font-weight:bold;font-style:normal;text-decoration:none;";break;case"Heading2":e="font-family:arial,helvetica,sans-serif;font-size:24px;font-weight:normal;font-style:normal;text-decoration:none;";break;case"Heading3":e="font-family:arial,helvetica,sans-serif;font-size:19px;font-weight:normal;font-style:normal;text-decoration:none;";break;case"Note":e="font-family:arial,helvetica,sans-serif;font-size:13px;font-weight:normal;font-style:italic;text-decoration:none;";break}if(g.match(/style/)){g=g.replace(/style="(.*?)"/,'style="$1'+e+'"')}else{g=g.replace(/>/,' style="$1'+e+'">')}c=c.replace(/(<span author.*?style=")(.*?)(">)/,function(h,l,k,j){return(l+k.match(/background-color:.*?;/)[0]+j)});return(g+c+f)});return a}function verifyLink(a){if(a.match(/^(ht|f)tps?:\/\/[a-z0-9-\.]+\.[a-z]{2,4}\/?([^\s<>\#%"\,\{\}\\|\\\^\[\]`]+)?$/)){return true}else{return false}};function initVideoManager(c,b,a){$("#vidAdd").bind("click",function(){$("#vidl,#vidInsert").removeAttr("disabled");$("#vidAdd").attr("disabled","disabled");$("#vidInsert").bind("click",function(){verifyVideoLink(c,b)});$("#vidl").focus()})}function verifyVideoLink(c,b){var f=$("#vidl").val();var e=f;if(e.length){if(e.match(/^https?:\/\/www.youtube.com\/watch\?v=.*/)){e=e.substr((e.indexOf("/watch?v=")+9));if(e.indexOf("&")!=-1){e=e.substring(0,e.indexOf("&"))}insertvideo(c,b,"youtube",f,e)}else{if(e.match(/^https?:\/\/youtu.be\/.*/)){var g;e=e.substr((e.indexOf("youtu.be/")+9));if(e.indexOf("?")!=-1){g=e.substring(e.indexOf("?"));e=e.substring(0,e.indexOf("?"));var a=g.match(/(\d+)m/);var d=g.match(/(\d+)s/);a=a?parseInt(a[1]):0;d=d?parseInt(d[1]):0;g=(a*60)+d}else{g=0}insertvideo(c,b,"youtu.be",f,e,g)}else{if(e.match(/^https?:\/\/vimeo.com\/.*/)){e=e.substr((e.lastIndexOf("/")+1));insertvideo(c,b,"vimeo",f,e)}else{if(e.match(/^https?:\/\/www.dailymotion.com\/video\/.*/)){e=e.substring((e.indexOf("video/")+6),(e.indexOf("_")));insertvideo(c,b,"dailymotion",f,e)}}}}}}function insertvideo(b,a,c,e,d,f){if($doc("div.selAnchor#"+b).length){selectionDelete(b,a)}if(previousNodeSearch($doc("div.cursor#"+b)[0])=="firstLine"){manageEnter(b,null,"kolab","undo",false);var h=$doc("div.cursor#"+b).parents("p.paragraphContainer").prev("p.paragraphContainer")}else{if(nextNodeSearch($doc("div.cursor#"+b)[0])=="lastLine"){manageEnter(b,null,"kolab","undo",false);var h=$doc("div.cursor#"+b).parents("p.paragraphContainer")}else{manageEnter(b,null,"kolab","undo",false);manageEnter(b,null,"kolab","undo",false);var h=$doc("div.cursor#"+b).parents("p.paragraphContainer").prev("p.paragraphContainer")}}h.html("");var g=klbGenerator();switch(c){case"youtube":h.append('<iframe id="'+g+'" link="'+e+'" src="http://www.youtube.com/embed/'+d+'" width="564" height="368" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>');break;case"youtu.be":h.append('<iframe id="'+g+'" link="'+e+'" src="http://www.youtube.com/embed/'+d+"?wmode=transparent&start="+f+'" width="564" height="368" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>');break;case"vimeo":h.append('<iframe id="'+g+'" link="'+e+'" src="http://player.vimeo.com/video/'+d+'" width="564" height="368" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>');break;case"dailymotion":h.append('<iframe id="'+g+'" link="'+e+'" src="http://www.dailymotion.com/embed/video/'+d+'" width="564" height="368" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>');break}$("#vidl").val("");$("#vidInsert").unbind("click");$("#vidl,#vidInsert").attr("disabled","disabled");$("#vidAdd").removeAttr("disabled");$("iframe#r_engine")[0].contentWindow.focus()};return{load:load};})(); 
